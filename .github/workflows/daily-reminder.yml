name: Daily Reminder Cron

on:
  schedule:
    - cron: '37 17 * * *'  # UTC –≤—Ä–µ–º—è (20:37 –ú–°–ö)
  workflow_dispatch:        # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  trigger-reminder:
    runs-on: ubuntu-latest
    steps:
      # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤
      - name: Verify secrets exist
        run: |
          if [ -z "${{ secrets.VERCEL_URL }}" ]; then
            echo "::error::VERCEL_URL secret is missing in GitHub repository settings"
            exit 1
          fi
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "::error::CRON_SECRET secret is missing in GitHub repository settings"
            exit 1
          fi
          echo "‚úÖ All required secrets are present"
      
      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
      - name: Setup environment
        id: setup
        run: |
          echo "VERCEL_URL=${{ secrets.VERCEL_URL }}" >> $GITHUB_ENV
          echo "CRON_SECRET=${{ secrets.CRON_SECRET }}" >> $GITHUB_ENV
          echo "URL=https://${{ secrets.VERCEL_URL }}/api/cron/daily-reminder" >> $GITHUB_ENV
          echo "::notice::Using Vercel URL: ${{ secrets.VERCEL_URL }}"
          echo "::notice::CRON_SECRET length: ${#CRON_SECRET}"
      
      # –®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
      - name: Trigger daily reminder
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
          if [ -z "$VERCEL_URL" ]; then
            echo "::error::VERCEL_URL is empty!"
            exit 1
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "::error::CRON_SECRET is empty!"
            exit 1
          fi
          
          echo "üîß Making request to: $URL"
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          response=$(curl -i -s -X POST \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "User-Agent: GitHub-Actions-Cron/1.0" \
            -w "\nHTTP_STATUS:%{http_code}" \
            "$URL")
            
          # –ò–∑–≤–ª–µ–∫–∞–µ–º HTTP —Å—Ç–∞—Ç—É—Å
          http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
          response_body=$(echo "$response" | sed '/HTTP_STATUS/d')
          
          echo "üìä Response status: $http_status"
          echo "üìÑ Response body:"
          echo "$response_body"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          if [ "$http_status" -eq 200 ]; then
            echo "‚úÖ Success: Daily reminder triggered"
          else
            echo "::error::‚ùå Error: Received HTTP $http_status"
            exit 1
          fi
