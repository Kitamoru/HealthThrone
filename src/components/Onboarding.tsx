import { useState, useEffect, useRef } from 'react';
import { api } from '../lib/api';
import { Loader } from './Loader';

type Role = 'Разработчик' | 'Инженер по безопасности' | 'Тестер' | 'Аналитик' | 'Дизайнер' | 'Продакт менеджер' | 'Менеджер проектов' | 'Скрам мастер' | 'Тимлид' | 'Техлид' | 'Саппорт' | 'Девопс' | 'Архитектор' | 'Аккаунт менеджер' | 'Менеджер по продажам' | 'C-level' | 'HR';
type BaseType = 'Достигатор' | 'Исследователь' | 'Социализатор' | 'Убийца';
type Answer = 'a' | 'b' | 'c' | 'd';

const QUESTIONS = [
  "Что сильнее всего зажигает искру в твоем сердце во время странствий?",
  "Что дает тебе силы двигаться дальше, даже в самом сложном приключении?",
  "Что превращает твой эль в воду, а дорогу — в каторгу?",
  "Какое задание заставит твое сердце биться чаще?",
  "Какой стиль странствий тебе по душе?",
  "Что делает твои труды по-настоящему ценными?",
  "Какой миг странствий ты назовешь совершенным?",
  "Что вдохновляет тебя на новые подвиги?",
  "Как ты встречаешь поражение или неудачу?",
];

const OPTIONS = [
  [
    "Достижение ясной цели и получение заслуженной награды (золото, титул, земли)",
    "Открытие древних руин, разгадка тайных знаний или постижение новых законов магии",
    "Теплота костра в кругу верных спутников, общие песни и истории",
    "Победа в честном (или не очень) поединке или состязании с достойным противником"
  ],
  [
    "Видимый прогресс на карте к цели и перспективы роста могущества или славы",
    "Возможность разгадать хитроумную головоломку или столкнуться с совершенно неведомой магией",
    "Знание, что товарищи рядом и доверяют тебе, как ты доверяешь им",
    "Шанс доказать всем (и себе), что именно ты — сильнейший воин или хитрейший маг в этих землях"
  ],
  [
    "Блуждание без четкой цели или когда твои подвиги остаются непризнанными гильдией",
    "Дороги, где каждый шаг предсказуем, нет места открытиям, а все задачи решаются старыми, как мир, способами",
    "Распри в отряде, холодное безразличие спутников или предательство",
    "Поражение от рук соперников или осознание, что твоя гильдия слабее других"
  ],
  [
    "Выполнение контракта гильдии с четкими условиями и щедрой платой по завершении",
    "Изучение древних свитков в забытой библиотеке или создание нового могущественного артефакта/заклинания",
    "Общее дело с отрядом, где успех рождается из слаженности и взаимопомощи",
    "Турнир, охота на опаснейшего чудовища или миссия с высоким риском, где можно проявить превосходство"
  ],
  [
    "Тщательное планирование маршрута, сбор сведений, фокус на выполнении миссии",
    "Глубокое погружение в детали: изучение следов, свойств артефактов, проверка древних легенд на практике",
    "Поддержка товарищей в бою и на привале, укрепление уз доверия и братства в отряде",
    "Лидерство на передовой, принятие вызовов, ведение группы к победе над любыми врагами"
  ],
  [
    "Мешок золота по контракту, повышение в гильдии или всеобщее признание твоих заслуг",
    "Момент, когда твоя догадка подтверждается, заклинание срабатывает или артефакт обретает силу согласно твоему замыслу",
    "Чувство нерушимого братства, когда каждый в отряде готов жизнь положить за другого",
    "Осознание своего превосходства над соперниками, укрепление личной славы и могущества"
  ],
  [
    "Возвращение в гильдию с трофеями и успешным докладом о выполненной миссии",
    "Озарение! Когда пазл тайны наконец складывается, и ты понимаешь суть древнего ритуала или устройства",
    "Уставшие, но довольные, вы делите добычу у костра после боя, который выиграли только благодаря слаженной работе",
    "Ты стоишь над поверженным могущественным врагом или побеждаешь в изматывающем турнире, доказав свое превосходство"
  ],
  [
    "Карта с намеченными целями и саги о легендарных героях, достигших величия",
    "Слухи о затерянных городах, древних артефактах, границах карты с надписью *Здесь водятся драконы*",
    "Возможность собрать верный отряд, разделить с ними костёр и трудности пути",
    "Вызовы от других искателей приключений, шанс помериться силой с лучшими из лучших"
  ],
  [
    "Анализирую ошибки тактики, чтобы в следующий битве или переговорах достичь победы",
    "Ищу новое знание или нестандартный подход, который поможет преодолеть это препятствие в будущем",
    "Обращаюсь за советом и поддержкой к товарищам, вместе ищем путь исправить положение",
    "Тренируюсь яростнее, коплю силы и ресурсы, чтобы в следующий раз сокрушить того, кто меня победил"
  ]
];

const ANSWER_TO_TYPE: Record<Answer, BaseType> = {
  'a': 'Достигатор',
  'b': 'Исследователь',
  'c': 'Социализатор',
  'd': 'Убийца'
};

const ROLE_TYPE_TO_CLASS: Record<Role, Record<BaseType, string>> = {
  'Разработчик': {
    'Достигатор': 'Мастер алгоритмов',
    'Исследователь': 'Искатель оптимизации',
    'Социализатор': 'Бард коллаборации',
    'Убийца': 'Разрушитель багов'
  },
  'Инженер по безопасности': {
    'Достигатор': 'Страж уязвимостей',
    'Исследователь': 'Шпион угроз',
    'Социализатор': 'Проповедник безопасности',
    'Убийца': 'Охотник за угрозами'
  },
  'Тестер': {
    'Достигатор': 'Мастер покрытия',
    'Исследователь': 'Ловец багов',
    'Социализатор': 'Посол качества',
    'Убийца': 'Испытатель пределов'
  },
  'Аналитик': {
    'Достигатор': 'Заклинатель метрик',
    'Исследователь': 'Алхимик данных',
    'Социализатор': 'Рассказчик инсайтов',
    'Убийца': 'Разрушитель иллюзий'
  },
  'Дизайнер': {
    'Достигатор': 'Ясновидящий',
    'Исследователь': 'Картограф опыта',
    'Социализатор': 'Глас народа',
    'Убийца': 'Разрушитель хаоса'
  },
  'Продакт менеджер': {
    'Достигатор': 'Завоеватель рынков',
    'Исследователь': 'Провидец рынка',
    'Социализатор': 'Миротворец стейкхолдеров',
    'Убийца': 'Балансир спринтов'
  },
  'Менеджер проектов': {
    'Достигатор': 'Мастер дедлайнов',
    'Исследователь': 'Навигатор хаоса',
    'Социализатор': 'Дирижер команды',
    'Убийца': 'Разрушитель преград'
  },
  'Скрам мастер': {
    'Достигатор': 'Хранитель скорости',
    'Исследователь': 'Призыватель кайдзенов',
    'Социализатор': 'Мастер церемоний',
    'Убийца': 'Охотник на импедансы'
  },
  'Тимлид': {
    'Достигатор': 'Архитектор роста',
    'Исследователь': 'Навигатор развития',
    'Социализатор': 'Наставник гильдии',
    'Убийца': 'Щит команды'
  },
  'Техлид': {
    'Достигатор': 'Архимаг качества',
    'Исследователь': 'Проводник технологий',
    'Социализатор': 'Мудрец кода',
    'Убийца': 'Судья техдолга'
  },
  'Саппорт': {
    'Достигатор': 'Волшебник поддержки',
    'Исследователь': 'Хранитель истины',
    'Социализатор': 'Посол доверия',
    'Убийца': 'Охотник за SLA'
  },
  'Девопс': {
    'Достигатор': 'Страж стабильности',
    'Исследователь': 'Алхимик инфраструктуры',
    'Социализатор': 'Говорящий с духами',
    'Убийца': 'Укротитель инцидентов'
  },
  'Архитектор': {
    'Достигатор': 'Мудрец систем',
    'Исследователь': 'Советник будущего',
    'Социализатор': 'Проповедник смыслов',
    'Убийца': 'Искатель антипаттернов'
  },
  'Аккаунт менеджер': {
    'Достигатор': 'Зачарователь сделок',
    'Исследователь': 'Картограф потребностей',
    'Социализатор': 'Повелитель отношений',
    'Убийца': 'Охотник за возражениями'
  },
  'Менеджер по продажам': {
    'Достигатор': 'Торговец судьбы',
    'Исследователь': 'Коллекционер путей',
    'Социализатор': 'Хранитель связей',
    'Убийца': 'Повелитель желаний'
  },
  'C-level': {
    'Достигатор': 'Повелитель ресурсов',
    'Исследователь': 'Провидец',
    'Социализатор': 'Связующий звезды',
    'Убийца': 'Убийца стагнации'
  },
  'HR': {
    'Достигатор': 'Инженер талантов',
    'Исследователь': 'Картограф мотивации',
    'Социализатор': 'Изгнанник выгорания',
    'Убийца': 'Охотник за головами'
  }
};

const CLASS_DESCRIPTIONS: Record<Role, Record<string, string>> = {
  'Разработчик': {
    'Мастер алгоритмов': `Ваш код – неприступная крепость логики. Вы возводите идеальные структуры, превращая сложнейшие задачи в элегантные решения, и гордитесь каждым безупречным коммитом как завоеванной цитаделью. Ваша мотивация – видеть алгоритмы, работающие с безупречной точностью.`,
    'Искатель оптимизации': `Вы – вечный следопыт в лабиринтах кода. Ваша страсть – находить скрытые тропы эффективности, разгадывать тайны производительности и внедрять магические артефакты (библиотеки, фреймворки), ускоряющие путь всей партии. Мотивация – в самом поиске и открытии лучшего пути.`,
    'Бард коллаборации': `Ваша сила – в гармонии команды. Вы разглаживаете конфликты, делитесь знаниями как ценными свитками и превращаете совместную работу в слаженный ансамбль, где каждый инструмент-разработчик звучит чисто. Ваша мотивация – успех и дух товарищества всей гильдии.`,
    'Разрушитель багов': `Вы – гроза цифровой нечисти. С холодной яростью охотника вы выслеживаете, окружаете и безжалостно уничтожаете коварных баггретов, особенно наслаждаясь победами над критическими инцидентами-боссами. Мотивация – в азарте погони и триумфе над ошибкой.`
  },
  'Инженер по безопасности': {
    'Страж уязвимостей': `Ваш щит – безупречная конфигурация, ваш меч – строгий комплаенс. Вы методично укрепляете периметр, патчите каждую брешь и гордитесь цифрами 100% соответствия как завоеванными трофеями. Мотивация – в создании неприступной цифровой цитадели.`,
    'Шпион угроз': `Вы мастер перевоплощения, проникающий в лагеря врага (Darknet, хакерские форумы). Ваша цель – узнать планы тьмы раньше атаки, разведать новые векторы угроз и принести ценные свитки разведданных своей гильдии. Мотивация – в азарте разведки и предвосхищении.`,
    'Проповедник безопасности': `Вы обращаете неверных в культ Security Awareness. Ваши проповеди (тренинги, гайды) превращают рядовых сотрудников в бдительных стражей, создавая единый фронт обороны. Ваша мотивация – в силе коллективной бдительности и доверии.`,
    'Охотник за угрозами': `Вы – хищник в цифровой пустоши. В реальном времени вы выслеживаете атакующих, нейтрализуете вторжения и с гордостью демонстрируете трофеи – поверженных ботов и эксплойты. Мотивация – в адреналине погони и победе над живым противником.`
  },
  'Тестер': {
    'Мастер покрытия': `Ваша карта тест-кейсов покрывает каждую пядь подземелья приложения. Вы гордитесь цифрой 100% coverage как короной и методично выискиваете каждую недоделку по спецификации. Ваша мотивация – безупречная полнота проверки.`,
    'Ловец багов': `Вы – азартный охотник за глюками, особенно редкими и странными. Ваша радость – найти баг в неочевидном краевом случае, изучить его повадки и добавить в свою коллекцию диковин. Мотивация – в охоте и открытии неизведанных лог-тропинок.`,
    'Посол качества': `Вы – мост между мирами Dev и Ops/Users. Ваши отчеты – это понятные истории, а обратная связь помогает разработчикам увидеть продукт глазами тех, кто им пользуется. Ваша мотивация – в улучшении продукта через взаимопонимание.`,
    'Испытатель пределов': `Вы сознательно вызываете хаос – лавины нагрузки, нашествия неверных данных. Ваша цель – сломать систему, найти ту единственную слабость, что может обрушить продакшен-цитадель. Мотивация – в триумфе над сложностью и предотвращении катастрофы.`
  },
  'Аналитик': {
    'Заклинатель метрик': `Вы превращаете сырые данные в кристально чистые KPI и предсказания, которые всегда сбываются. Ваши дашборды – магические кристаллы, указывающие путь к цели. Мотивация – в точности, предсказуемости и достижении измеримых результатов.`,
    'Алхимик данных': `Ваш котел – Big Data, а ингредиенты – разрозненные цифры. Вы экспериментируете, ищете скрытые закономерности и философский камень инсайта, способный осветить путь бизнеса. Мотивация – в самом процессе алхимии и открытии нового.`,
    'Рассказчик инсайтов': `Вы превращаете сухие цифры в эпичные саги о пользователях и рынке. Ваши презентации – завораживающие истории, которые вдохновляют партию на подвиги. Мотивация – в том, чтобы ваши открытия поняли и прочувствовали все.`,
    'Разрушитель иллюзий': `Вы – беспристрастный судья гипотез. Ваше аналитическое жало безжалостно разбивает красивые, но ложные предположения, оставляя на поле боя только голые, сверкающие факты. Мотивация – в интеллектуальном превосходстве и победе истины над заблуждением.`
  },
  'Дизайнер': {
    'Ясновидящий': `Ваша цель – превратить хаос требований в кристально понятные решения. Вы гордитесь безупречным соответствием брифу, техническому заданию и стандартам доступности, видя в каждом завершенном проекте неприступную крепость логики и пользы. Ваша мотивация – в безупречном выполнении замысла и создании предсказуемо работающих решений.`,
    'Картограф опыта': `Вы – вечный следопыт в лабиринтах пользовательских потребностей и контекстов. Ваша страсть – находить скрытые боли, тестировать гипотезы, разгадывать тайны поведения и прокладывать интуитивные пути (будь то интерфейс, услуга или коммуникация). Мотивация – в самом поиске и открытии неочевидных истин, формирующих лучший опыт.`,
    'Глас народа': `Ваша сила – в эмпатии и умении быть мостом. Вы отстаиваете потребности людей перед драконами функциональных ограничений и бизнес-требований. Ваши презентации – это истории, которые вдохновляют команду, а обратная связь помогает всем увидеть продукт глазами тех, для кого он создан. Мотивация – в защите интересов пользователя и создании гармонии между людьми и решениями.`,
    'Разрушитель хаоса': `Вы – безжалостный охотник на неясность, неудобство и визуальный шум. Ваша цель – выявить и уничтожить все, что мешает восприятию, пониманию или действию (сложные потоки, противоречивые сообщения, визуальный дисбаланс). После вашего рейда решение сияет чистотой смысла и эффективностью. Мотивация – в устранении барьеров и достижении безусловной ясности.`
  },
  'Продакт менеджер': {
    'Завоеватель рынков': `Ваш продукт – осадная машина, сметающая конкурентов. Вы ставите четкие метрики (MAU, конверсия, удержание) и ведете свою гильдию к их завоеванию. Мотивация – в видимом росте, доле рынка и победе.`,
    'Провидец рынка': `Вы сканируете горизонт будущего, ища неоткрытые земли (ниши, тренды). Ваши видения формируют стратегию, а эксперименты – карту нового пути для гильдии. Мотивация – в предвидении и создании того, чего еще нет.`,
    'Миротворец стейкхолдеров': `Вы – дипломат между враждующими кланами (Dev, Marketing, Sales, Support). Ваша магия – находить общий язык, синхронизировать цели и превращать хаос требований в священный скрам-свиток. Мотивация – в гармонии и совместном движении к цели.`,
    'Балансир спринтов': `Вы – мастер приоритезации на поле боя ресурсов. Ваше искусство – жонглировать фичами-мечами и багами-щитами, фокусируя удар гильдии на главном враге сейчас. Мотивация – в эффективном "убойном" результате каждого спринта.`
  },
  'Менеджер проектов': {
    'Мастер дедлайнов': `Ваш хронометр точен как часы богов. Вы доставляете проектные артефакты точно в срок и в рамках бюджета, как безупречный логист подземелий. Мотивация – в безукоризненном выполнении плана и достижении целей.`,
    'Навигатор хаоса': `Вы читаете карту рисков как открытую книгу. Ваш дар – предвидеть обвалы, болота задержек и находить обходные тропы через хаос неопределенности. Мотивация – в решении головоломок и поиске лучшего пути вперед.`,
    'Дирижер команды': `Вы превращаете группу специалистов в слаженный оркестр. Ваша палочка задает ритм, разрешает разногласия и поддерживает моральный дух даже в аду кретического пути. Мотивация – в силе сплоченной команды и ее успехе.`,
    'Разрушитель преград': `Ваш молот – процессы, ваша ярость – против блокеров. Вы сносите бюрократические стены, разбиваете камни непонимания и расчищаете путь для партии к цели. Мотивация – в преодолении препятствий и победе над хаосом.`
  },
  'Скрам мастер': {
    'Хранитель скорости': `Вы оберегаете Velocity команды как священный Грааль. Ваши ритуалы (ретро) выявляют трение, а заклинания (практики) ускоряют движение гильдии к цели. Мотивация – в стабильном, высоком темпе и прогрессе.`,
    'Призыватель кайдзенов': `Вы – вечный искатель лучших скрам-ритуалов и практик. Ваша магия – находить и внедрять улучшения, делая путь команды глаже и эффективнее. Мотивация – в постоянном поиске и внедрении оптимизаций.`,
    'Мастер церемоний': `Вы – хранитель огня психологической безопасности. Ваши церемонии (планнинг, стендап, ретро) – это костры, вокруг которых греется и объединяется команда. Мотивация – в здоровой, доверительной атмосфере гильдии.`,
    'Охотник на импедансы': `Вы выслеживаете невидимых демонов, тормозящих команду – лишние встречи, бюрократию, разрозненность. Ваша цель – найти и безжалостно устранить их. Мотивация – в устранении всего, что мешает потоку и скорости.`
  },
  'Тимлид': {
    'Архитектор роста': `Вы строите лестницы компетенций для каждого члена гильдии. Ваш план – вести команду к выполнению квартальных целей и спринтов, возводя цитадель профессионализма. Мотивация – в развитии команды и достижении общих целей.`,
    'Навигатор развития': `Вы составляете индивидуальные карты роста для героев вашей гильдии, находите лучшие пути обучения и новые вызовы. Мотивация – в поиске и реализации потенциала каждого.`,
    'Наставник гильдии': `Вы – маяк и опора. Вы взращиваете командный дух, заботитесь о благополучии товарищей и передаете свои знания, превращая группу в настоящую семью-гильдию. Мотивация – в успехе, доверии и единстве команды.`,
    'Щит команды': `Вы встаете на пути внешнего давления, абсурдных сроков и токсичности. Ваш щит принимает удар, защищая пространство, где ваша гильдия может творить магию. Мотивация – в отстаивании интересов и безопасности команды.`
  },
  'Техлид': {
    'Архимаг качества': `Ваши стандарты – неприступная стена. Вы гарантируете, что кодовая база – это крепость надежности, а каждый коммит соответствует высшим канонам мастерства. Мотивация – в техническом совершенстве и безупречности.`,
    'Проводник технологий': `Вы освещаете путь в темных лесах новых технологий и архитектур. Ваша задача – найти, оценить и безопасно провести команду по лучшему пути. Мотивация – во внедрении инноваций и будущего.`,
    'Мудрец кода': `Ваши код-ревью – уроки высшей магии. Вы терпеливо наставляете, делитесь мудростью и помогаете каждому разработчику отточить свое мастерство. Мотивация – в росте экспертизы команды и передаче знаний.`,
    'Судья техдолга': `Вы безжалостны к хаосу и компромиссам. Ваше клеймо техдолга сжигает лень, а ваши решения в архитектурных спорах непоколебимы. Мотивация – в чистоте кода, эффективности и победе над хаотичными решениями.`
  },
  'Саппорт': {
    'Волшебник поддержки': `Ваши решения быстры и точны как магия. Вы закрываете максимум тикетов с высочайшим CSAT, превращая истерику в благодарность. Мотивация – в скорости, эффективности и идеальных метриках разрешения.`,
    'Хранитель истины': `Вы – археолог логов и конфигов. Копая глубже, вы находите первопричины проблем, превращая разрозненные симптомы в ясную картину. Мотивация – в разгадке тайны и предотвращении повторных инцидентов.`,
    'Посол доверия': `Вы – лицо гильдии для клиентов. Ваше спокойствие, эмпатия и умение слушать превращают разгневанных драконов в лояльных союзников, даже в самых сложных ситуациях. Мотивация – в построении позитивных отношений и доверия.`,
    'Охотник за SLA': `Вы мчитесь наперегонки с таймером критичных SLA. Ваша цель – победить время, устранить проблему до последней секунды и доказать надежность гильдии. Мотивация – в азарте погони и победе над сроками.`
  },
  'Девопс': {
    'Страж стабильности': `Ваше царство – 99.99% uptime. Вы выстраиваете неприступную инфраструктуру и безупречные CI/CD конвейеры, работающие как швейцарские часы. Мотивация – в абсолютной надежности и предсказуемости систем.`,
    'Алхимик инфраструктуры': `Ваш котел – Terraform, Kubernetes, облака. Вы смешиваете технологии, создавая зелья автоматизации, превращающие рутину в магию самонастройки. Мотивация – в создании элегантных, эффективных и инновационных решений.`,
    'Говорящий с духами': `Вы – шаман, понимающий язык серверов и облаков. Ваш дар – налаживать диалог между разработчиками и инфраструктурой, синхронизируя их ритмы и создавая общие практики. Мотивация – в гармонизации процессов Dev и Ops.`,
    'Укротитель инцидентов': `Когда рушатся миры (продакшен), вы входите в шторм. Ваша ярость и мастерство усмиряют хаос, локализуют проблему и восстанавливают порядок в рекордные сроки. Мотивация – в победе над кризисом и восстановлении контроля.`
  },
  'Архитектор': {
    'Мудрец систем': `Вы проектируете цитадели кода, способные выдержать штурм миллионов пользователей. Ваши схемы – это карты сокровищ для разработчиков, ведущие к масштабируемым и надежным решениям. Мотивация – в создании технически безупречных и мощных систем.`,
    'Советник будущего': `Вы смотрите на 5-10 лет вперед, оценивая технологические тренды и риски. Ваши рекомендации – это компас, уберегающий гильдию от архитектурных тупиков. Мотивация – в стратегическом видении и выборе долгосрочно выигрышных путей.`,
    'Проповедник смыслов': `Вы – евангелист хорошей архитектуры. Вы умеете объяснить сложные решения простыми словами, найти консенсус между командами и вдохновить их на строительство по вашему плану. Мотивация – во всеобщем понимании и принятии архитектурного видения.`,
    'Искатель антипаттернов': `Ваше копье – критическое мышление. Вы безжалостно разоблачаете и уничтожаете плохие архитектурные решения, монолиты и хаотичные микросервисы, расчищая место для элегантности. Мотивация – в борьбе с неэффективностью и утверждении правильных паттернов.`
  },
  'Аккаунт менеджер': {
    'Зачарователь сделок': `Ваша магия – в контрактах, где выигрывают все. Вы заключаете выгодные сделки, удерживаете ключевых клиентов и гордитесь цифрами retention как завоеванными крепостями. Мотивация – в измеримом успехе и росте аккаунтов.`,
    'Картограф потребностей': `Вы составляете детальные карты экосистемы клиента, выявляя скрытые боли и желания. Ваши находки открывают новые возможности для продуктов гильдии. Мотивация – в глубоком понимании клиента и поиске точек роста.`,
    'Повелитель отношений': `Вы строите мосты доверия и партнерства. Ваши клиенты – ваши вассалы, лояльные и защищенные. Вы превращаете транзакции в долгосрочные союзы. Мотивация – в силе личных связей и взаимном доверии.`,
    'Охотник за возражениями': `Ваши аргументы – серебряные пули против сомнений и отказов. Вы мастерски разбиваете возражения, преодолеваете барьеры и закрываете апсейлы, расширяя влияние гильдии. Мотивация – в победе в сложных переговорах и преодолении сопротивления.`
  },
  'Менеджер по продажам': {
    'Торговец судьбы': `Вы не просто продаете – вы меняете судьбы клиентов. Ваш план продаж – поле битвы, а перевыполнение квот – триумф. Вы гордитесь каждой победой-сделкой. Мотивация – в превышении целей и завоевании рынка.`,
    'Коллекционер путей': `Вы знаете сотни троп к "да". Ваша коллекция – кейсы, методики, подходы, которые вы постоянно пополняете и используете, чтобы найти лучший путь к сердцу (и кошельку) клиента. Мотивация – в поиске и применении самых эффективных тактик.`,
    'Хранитель связей': `Ваша сеть контактов – паутина влияния. Вы соединяете людей, создаете возможности и используете силу отношений для достижения целей. Ваша гильдия продажников сплочена вашей харизмой. Мотивация – в силе сообщества и взаимопомощи.`,
    'Повелитель желаний': `Вы пробуждаете в клиентах жгучую потребность в вашем продукте. Ваши презентации – завораживающие иллюзии, а умение продавать – магия, против которой трудно устоять. Мотивация – в доминировании на переговорах и безоговорочном "да".`
  },
  'C-level': {
    'Повелитель ресурсов': `Вы – стратег распределения золота и войск (бюджетов и людей). Ваша цель – максимальная отдача от каждого вложенного ресурса для завоевания бизнес-целей. Мотивация – в эффективности, ROI и достижении стратегических KPI.`,
    'Провидец': `Вы сканируете горизонты рынка, технологий и бизнес-моделей. Ваши стратегические видения – карта, по которой движется вся гильдия в будущее. Мотивация – в предвидении трендов и формировании будущего компании.`,
    'Связующий звезды': `Вы создаете галактику из разрозненных команд и направлений. Ваша харизма и видение объединяют людей, формируя сильную корпоративную культуру и общие ценности. Мотивация – в единстве, силе коллектива и разделяемом всеми успехе.`,
    'Убийца стагнации': `Вы – реформатор, безжалостный к бюрократии и устаревшим процессам. Ваши решения рубят головы гидре неэффективности, открывая путь для инноваций и скорости. Мотивация – в преодолении инерции, драйве изменений и конкурентном преимуществе.`
  },
  'HR': {
    'Инженер талантов': `Вы строите эффективные конвейеры найма, снижаете turnover и гордитесь метриками закрытых вакансий и удержания звезд. Ваша крепость – сильный, надежный кадровый состав. Мотивация – в измеримых результатах построения команды.`,
    'Картограф мотивации': `Вы составляете уникальные карты драйверов и демотиваторов для каждого "героя" и "клана". Ваши исследования помогают находить ключи к истинному вовлечению. Мотивация – в понимании сложной природы мотивации и поиске лучших решений.`,
    'Изгнанник выгорания': `Вы – главный защитник от темных сил апатии и усталости. Ваши ритуалы (тимбилдинги, программы well-being) и обереги (обратная связь, поддержка) создают благоприятный климат в гильдии. Мотивация – в психологическом благополучии и душе команды.`,
    'Охотник за головами': `Вы – элитный рекрутер, выслеживающий топ-таланты на рынке. Ваша цель – привлечь в гильдию самых сильных "персонажей", переманивая их у конкурентов. Мотивация – в победе в "войне за таланты" и усилении гильдии суперзвездами.`
  }
};

interface OnboardingProps {
  onComplete: () => void;
  userId?: number;
  initData?: string;
}

const Onboarding = ({ onComplete, userId, initData }: OnboardingProps) => {
  const [step, setStep] = useState<'role' | 'test' | 'result'>('role');
  const [selectedRole, setSelectedRole] = useState<Role | null>(null);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState<Answer[]>([]);
  const [baseType, setBaseType] = useState<BaseType | null>(null);
  const [characterClass, setCharacterClass] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [shuffledOptions, setShuffledOptions] = useState<string[][]>([]);
  const dropdownRef = useRef<HTMLDivElement>(null);

  const roles: Role[] = [
    'Разработчик', 'Инженер по безопасности', 'Тестер', 'Аналитик', 
    'Дизайнер', 'Продакт менеджер', 'Менеджер проектов', 'Скрам мастер',
    'Тимлид', 'Техлид', 'Саппорт', 'Девопс', 'Архитектор', 
    'Аккаунт менеджер', 'Менеджер по продажам', 'C-level', 'HR'
  ];

  // Функция для перемешивания массива
  const shuffleArray = (array: any[]) => {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
  };

  // Инициализация перемешанных вариантов при переходе к тесту
  useEffect(() => {
    if (step === 'test') {
      const shuffled = OPTIONS.map(options => shuffleArray(options));
      setShuffledOptions(shuffled);
    }
  }, [step]);

  const handleRoleSelect = (role: Role) => {
    setSelectedRole(role);
    setIsDropdownOpen(false);
    setStep('test');
  };

  const handleAnswer = (answer: Answer) => {
    const newAnswers = [...answers, answer];
    setAnswers(newAnswers);

    if (currentQuestion < QUESTIONS.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      calculateBaseType(newAnswers);
    }
  };

  const calculateBaseType = (answers: Answer[]) => {
    const scores = {
      'Достигатор': 0,
      'Исследователь': 0,
      'Социализатор': 0,
      'Убийца': 0
    };

    answers.forEach(answer => {
      const type = ANSWER_TO_TYPE[answer];
      scores[type]++;
    });

    const maxScore = Math.max(...Object.values(scores));
    const finalType = (Object.keys(scores) as BaseType[]).find(
      key => scores[key] === maxScore
    ) || 'Достигатор';

    setBaseType(finalType);
    setStep('result');
  };

  useEffect(() => {
    if (step === 'result' && selectedRole && baseType) {
      const classForRole = ROLE_TYPE_TO_CLASS[selectedRole][baseType];
      setCharacterClass(classForRole);
    }
  }, [step, selectedRole, baseType]);

  const saveResult = async () => {
    if (!characterClass || !userId || !initData) return;
    
    setIsSaving(true);
    
    try {
      const response = await api.updateUserClass(userId, characterClass, initData);
      if (!response.success) throw new Error(response.error);
      onComplete();
    } catch (error) {
      console.error('Ошибка сохранения:', error);
    } finally {
      setIsSaving(false);
    }
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  return (
    <div className="onboarding-container">
      {isSaving && <Loader />}
      
      {step === 'role' && (
        <div className="role-step">
          <div className="onboarding-header">
            <h1>Добро пожаловать в Подземелье Moraleon!</h1>
            <p>Выбери свою роль в гильдии:</p>
          </div>
          
          <div className="role-selector-container" ref={dropdownRef}>
            <div 
              className="role-selector"
              onClick={() => setIsDropdownOpen(!isDropdownOpen)}
            >
              <span className={selectedRole ? '' : 'placeholder'}>
                {selectedRole || '-- Выбери свою роль --'}
              </span>
              <div className={`dropdown-icon ${isDropdownOpen ? 'open' : ''}`}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9L12 15L18 9" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </div>
            </div>
            
            {isDropdownOpen && (
              <div className="role-dropdown">
                {roles.map(role => (
                  <div
                    key={role}
                    className={`role-option ${selectedRole === role ? 'selected' : ''}`}
                    onClick={() => handleRoleSelect(role)}
                  >
                    {role}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {step === 'test' && (
        <div className="test-step">
          <div className="progress-container">
            <p className="progress-text">Вопрос {currentQuestion + 1} из {QUESTIONS.length}</p>
            <div className="progress-bar">
              <div 
                className="progress-fill" 
                style={{ width: `${((currentQuestion + 1) / QUESTIONS.length) * 100}%` }}
              ></div>
            </div>
          </div>
          
          <div className="test-container">
            <p className="test-text">{QUESTIONS[currentQuestion]}</p>
          </div>
          
          <div className="answers-container">
            {shuffledOptions.length > 0 && shuffledOptions[currentQuestion].map((option, index) => {
              // Определяем букву ответа по оригинальному индексу
              const originalIndex = OPTIONS[currentQuestion].indexOf(option);
              const answerLetter = String.fromCharCode(97 + originalIndex) as Answer;
              
              return (
                <button
                  key={index}
                  onClick={() => handleAnswer(answerLetter)}
                  className="answer-button"
                >
                  {option}
                </button>
              );
            })}
          </div>
        </div>
      )}

      {step === 'result' && selectedRole && baseType && characterClass && (
        <div className="result-step">
          <div className="result-header">
            <h2>Твой Класс определён!</h2>
          </div>
          
          <div className="result-card">
            <h3 className="class-title">{characterClass}</h3>
            <p className="class-description">{CLASS_DESCRIPTIONS[selectedRole][characterClass]}</p>
            <p className="class-footer">Твоё путешествие в Подземелье Мотивации начинается!</p>
          </div>
          
          <button
            onClick={saveResult}
            className="accept-button"
          >
            Принять Судьбу
          </button>
        </div>
      )}
    </div>
  );
};

export default Onboarding;
