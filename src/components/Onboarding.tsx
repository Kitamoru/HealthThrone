// components/Onboarding.tsx
import { useState, useEffect } from 'react';
import { api } from '../lib/api';

// Типы данных
type Role = 'Разработчик' | 'Инженер по безопасности' | 'Тестер' | 'Аналитик' | 'Дизайнер' | 'Продакт менеджер' | 'Менеджер проектов' | 'Скрам мастер' | 'Тимлид' | 'Техлид' | 'Саппорт' | 'Девопс' | 'Архитектор' | 'Аккаунт менеджер' | 'Менеджер по продажам' | 'Руководитель' | 'HR';
type BaseType = 'Достигатор' | 'Исследователь' | 'Социализатор' | 'Убийца';
type Answer = 'a' | 'b' | 'c' | 'd';

// Данные для теста
const QUESTIONS = [
  "После победы над монстром Рутины, что наполняет тебя энергией?",
  "Когда путь преграждает Лабиринт Невозможного, что зажигает факел твоего упорства?",
  "Какая тьма сильнее всего иссушает твой источник мотивации?",
  "Если бы пришлось пить отравленный эль, какой яд выбрал бы?",
  "Какое зелье быстрее всего восстановит твои магические силы?",
  "Как предпочитаешь получать обратную связь от Главаря Гильдии?",
  "Идеальный момент в Подземелье для тебя - когда...",
  "Какой квест возьмешь первым у доски заданий?",
  "Твой магический щит дал трещину. Что скажешь себе?",
];

const OPTIONS = [
  [
    "a) Видеть, как золото KPI переливается в сундуке гильдии",
    "b) Чувствовать, как пазлы сложной головоломки щелкают в сознании",
    "c) Слышать благодарность союзников: «Без твоей защитной магии мы бы пали!»",
    "d) Держать в руках трофей, доказывающий: твой клинок острее всех"
  ],
  [
    "a) Четкая карта с этапами пути и сияющий артефакт в конце тоннеля",
    "b) Сам лабиринт! Его тайные механизмы так загадочны",
    "c) Крики товарищей: «Держись!» и знание, что вся гильдия верит",
    "d) Внутренний голос: «Я сокрушу эти стены, даже если это последнее, что я сделаю!»"
  ],
  [
    "a) Блуждаение без карты и целей, когда никто не видит твоих побед",
    "b) Бесконечная рубка одних и тех же скелетов по указке",
    "c) Ядовитые споры между союзниками и чувство, что твое место шатко",
    "d) Поражение гильдии в Великом Турнире или отсутствие достойных противников"
  ],
  [
    "a) Изучать древний артефакт, но без признания твоих усилий",
    "b) Рубить тренировочных манекенов в дружелюбной таверне",
    "c) Сражаться в отряде, где все ненавидят друг друга",
    "d) Завоевывать трон, но без права менять законы королевства"
  ],
  [
    "a) Видеть как этап квеста помечается руной «Завершено»",
    "b) Расшифровывать древние свитки или тестировать новый боевой стиль",
    "c) Объединить магию с другими чародеями для общего щита",
    "d) Бросить вызов дракону в одиночку, когда от твоего решения зависит судьба"
  ],
  [
    "a) С четкими цифрами: «Твой урон увеличился на 30%»",
    "b) С фокусом на твои уникальные методы: «Твои руны защиты были гениальны»",
    "c) С благодарностью за командный дух: «Ты сплотил нас у костра перед битвой»",
    "d) Подчеркивая твою непобедимость: «Ты сражался как лев Альянса!»"
  ],
  [
    "a) Магический кристалл KPI вспыхивает ярче солнца, подтверждая твой триумф",
    "b) Ты находишь потайной рычаг, который превращает пропасть в мост",
    "c) Вся гильдия поднимает кубки после победы над драконом",
    "d) Ты наносишь последний удар Повелителю Хаоса, и барды слагают о тебе саги"
  ],
  [
    "a) С четким сроком и наградой: «Принести 10 шкур ледяного волка к полнолунию»",
    "b) Где нужно разгадать тайну Проклятого Храма или испытать новый арбалет",
    "c) Где требуется объединить силы с другими для ритуала Единения",
    "d) «Победить Чемпиона Арены» или «Спасти заложников из логова бандитов в одиночку»"
  ],
  [
    "a) «Анализирую слабое место, кую новый щит, следую плану усиления»",
    "b) «Интересно! Почему он треснул именно здесь? Найду причину и улучшу сплав»",
    "c) «Как моя неудача повлияла на доверие гильдии? Нужно загладить вину»",
    "d) «Это поражение. Но следующую битву я выиграю с таким превосходством, что все забудут»"
  ]
];

// Соответствие ответов базовым типам
const ANSWER_TO_TYPE: Record<Answer, BaseType> = {
  'a': 'Достигатор',
  'b': 'Исследователь',
  'c': 'Социализатор',
  'd': 'Убийца'
};

// Маппинг: Роль + Базовый тип = Класс персонажа
const ROLE_TYPE_TO_CLASS: Record<Role, Record<BaseType, string>> = {
  'Разработчик': {
    'Достигатор': 'Мастер алгоритмов',
    'Исследователь': 'Искатель оптимизации',
    'Социализатор': 'Бард коллаборации',
    'Убийца': 'Разрушитель багов'
  },
  'Инженер по безопасности': {
    'Достигатор': 'Страж уязвимостей',
    'Исследователь': 'Шпион угроз',
    'Социализатор': 'Проповедник безопасности',
    'Убийца': 'Охотник за угрозами'
  },
  'Тестер': {
    'Достигатор': 'Мастер покрытия',
    'Исследователь': 'Ловец багов',
    'Социализатор': 'Посол качества',
    'Убийца': 'Испытатель пределов'
  },
  'Аналитик': {
    'Достигатор': 'Заклинатель метрик',
    'Исследователь': 'Алхимик данных',
    'Социализатор': 'Рассказчик инсайтов',
    'Убийца': 'Разрушитель иллюзий'
  },
  'Дизайнер': {
    'Достигатор': 'Ясновидящий',
    'Исследователь': 'Картограф опыта',
    'Социализатор': 'Глас народа',
    'Убийца': 'Разрушитель хаоса'
  },
  'Продакт менеджер': {
    'Достигатор': 'Завоеватель рынков',
    'Исследователь': 'Провидец рынка',
    'Социализатор': 'Миротворец стейкхолдеров',
    'Убийца': 'Балансир спринтов'
  },
  'Менеджер проектов': {
    'Достигатор': 'Мастер дедлайнов',
    'Исследователь': 'Навигатор хаоса',
    'Социализатор': 'Дирижер команды',
    'Убийца': 'Разрушитель преград'
  },
  'Скрам мастер': {
    'Достигатор': 'Хранитель скорости',
    'Исследователь': 'Призыватель кайдзенов',
    'Социализатор': 'Мастер церемоний',
    'Убийца': 'Охотник на импедансы'
  },
  'Тимлид': {
    'Достигатор': 'Архитектор роста',
    'Исследователь': 'Навигатор развития',
    'Социализатор': 'Наставник гильдии',
    'Убийца': 'Щит команды'
  },
  'Техлид': {
    'Достигатор': 'Архимаг качества',
    'Исследователь': 'Проводник технологий',
    'Социализатор': 'Мудрец кода',
    'Убийца': 'Судья техдолга'
  },
  'Саппорт': {
    'Достигатор': 'Волшебник поддержки',
    'Исследователь': 'Хранитель истины',
    'Социализатор': 'Посол доверия',
    'Убийца': 'Охотник за SLA'
  },
  'Девопс': {
    'Достигатор': 'Страж стабильности',
    'Исследователь': 'Алхимик инфраструктуры',
    'Социализатор': 'Говорящий с духами',
    'Убийца': 'Укротитель инцидентов'
  },
  'Архитектор': {
    'Достигатор': 'Мудрец систем',
    'Исследователь': 'Советник будущего',
    'Социализатор': 'Проповедник смыслов',
    'Убийца': 'Искатель антипаттернов'
  },
  'Аккаунт менеджер': {
    'Достигатор': 'Зачарователь сделок',
    'Исследователь': 'Картограф потребностей',
    'Социализатор': 'Повелитель отношений',
    'Убийца': 'Охотник за возражениями'
  },
  'Менеджер по продажам': {
    'Достигатор': 'Торговец судьбы',
    'Исследователь': 'Коллекционер путей',
    'Социализатор': 'Хранитель связей',
    'Убийца': 'Повелитель желаний'
  },
  'Руководитель': {
    'Достигатор': 'Повелитель ресурсов',
    'Исследователь': 'Провидец',
    'Социализатор': 'Связующий звезды',
    'Убийца': 'Убийца стагнации'
  },
  'HR': {
    'Достигатор': 'Инженер талантов',
    'Исследователь': 'Картограф мотивации',
    'Социализатор': 'Изгнанник выгорания',
    'Убийца': 'Охотник за головами'
  }
};

// Описания классов для разных ролей
const CLASS_DESCRIPTIONS: Record<Role, Record<string, string>> = {
  'Разработчик': {
    'Мастер алгоритмов': `Ваш код – неприступная крепость логики. Вы возводите идеальные структуры, превращая сложнейшие задачи в элегантные решения, и гордитесь каждым безупречным коммитом как завоеванной цитаделью. Ваша мотивация – видеть алгоритмы, работающие с безупречной точностью.`,
    'Искатель оптимизации': `Вы – вечный следопыт в лабиринтах кода. Ваша страсть – находить скрытые тропы эффективности, разгадывать тайны производительности и внедрять магические артефакты (библиотеки, фреймворки), ускоряющие путь всей партии. Мотивация – в самом поиске и открытии лучшего пути.`,
    'Бард коллаборации': `Ваша сила – в гармонии команды. Вы разглаживаете конфликты, делитесь знаниями как ценными свитками и превращаете совместную работу в слаженный ансамбль, где каждый инструмент-разработчик звучит чисто. Ваша мотивация – успех и дух товарищества всей гильдии.`,
    'Разрушитель багов': `Вы – гроза цифровой нечисти. С холодной яростью охотника вы выслеживаете, окружаете и безжалостно уничтожаете коварных баггретов, особенно наслаждаясь победами над критическими инцидентами-боссами. Мотивация – в азарте погони и триумфе над ошибкой.`
  },
  'Инженер по безопасности': {
    'Страж уязвимостей': `Ваш щит – безупречная конфигурация, ваш меч – строгий комплаенс. Вы методично укрепляете периметр, патчите каждую брешь и гордитесь цифрами 100% соответствия как завоеванными трофеями. Мотивация – в создании неприступной цифровой цитадели.`,
    'Шпион угроз': `Вы мастер перевоплощения, проникающий в лагеря врага (Darknet, хакерские форумы). Ваша цель – узнать планы тьмы раньше атаки, разведать новые векторы угроз и принести ценные свитки разведданных своей гильдии. Мотивация – в азарте разведки и предвосхищении.`,
    'Проповедник безопасности': `Вы обращаете неверных в культ Security Awareness. Ваши проповеди (тренинги, гайды) превращают рядовых сотрудников в бдительных стражей, создавая единый фронт обороны. Ваша мотивация – в силе коллективной бдительности и доверии.`,
    'Охотник за угрозами': `Вы – хищник в цифровой пустоши. В реальном времени вы выслеживаете атакующих, нейтрализуете вторжения и с гордостью демонстрируете трофеи – поверженных ботов и эксплойты. Мотивация – в адреналине погони и победе над живым противником.`
  },
  'Тестер': {
    'Мастер покрытия': `Ваша карта тест-кейсов покрывает каждую пядь подземелья приложения. Вы гордитесь цифрой 100% coverage как короной и методично выискиваете каждую недоделку по спецификации. Ваша мотивация – безупречная полнота проверки.`,
    'Ловец багов': `Вы – азартный охотник за глюками, особенно редкими и странными. Ваша радость – найти баг в неочевидном краевом случае, изучить его повадки и добавить в свою коллекцию диковин. Мотивация – в охоте и открытии неизведанных лог-тропинок.`,
    'Посол качества': `Вы – мост между мирами Dev и Ops/Users. Ваши отчеты – это понятные истории, а обратная связь помогает разработчикам увидеть продукт глазами тех, кто им пользуется. Ваша мотивация – в улучшении продукта через взаимопонимание.`,
    'Испытатель пределов': `Вы сознательно вызываете хаос – лавины нагрузки, нашествия неверных данных. Ваша цель – сломать систему, найти ту единственную слабость, что может обрушить продакшен-цитадель. Мотивация – в триумфе над сложностью и предотвращении катастрофы.`
  },
  'Аналитик': {
    'Заклинатель метрик': `Вы превращаете сырые данные в кристально чистые KPI и предсказания, которые всегда сбываются. Ваши дашборды – магические кристаллы, указывающие путь к цели. Мотивация – в точности, предсказуемости и достижении измеримых результатов.`,
    'Алхимик данных': `Ваш котел – Big Data, а ингредиенты – разрозненные цифры. Вы экспериментируете, ищете скрытые закономерности и философский камень инсайта, способный осветить путь бизнеса. Мотивация – в самом процессе алхимии и открытии нового.`,
    'Рассказчик инсайтов': `Вы превращаете сухие цифры в эпичные саги о пользователях и рынке. Ваши презентации – завораживающие истории, которые вдохновляют партию на подвиги. Мотивация – в том, чтобы ваши открытия поняли и прочувствовали все.`,
    'Разрушитель иллюзий': `Вы – беспристрастный судья гипотез. Ваше аналитическое жало безжалостно разбивает красивые, но ложные предположения, оставляя на поле боя только голые, сверкающие факты. Мотивация – в интеллектуальном превосходстве и победе истины над заблуждением.`
  },
  'Дизайнер': {
    'Ясновидящий': `Ваша цель – превратить хаос требований в кристально понятные решения. Вы гордитесь безупречным соответствием брифу, техническому заданию и стандартам доступности, видя в каждом завершенном проекте неприступную крепость логики и пользы. Ваша мотивация – в безупречном выполнении замысла и создании предсказуемо работающих решений.`,
    'Картограф опыта': `Вы – вечный следопыт в лабиринтах пользовательских потребностей и контекстов. Ваша страсть – находить скрытые боли, тестировать гипотезы, разгадывать тайны поведения и прокладывать интуитивные пути (будь то интерфейс, услуга или коммуникация). Мотивация – в самом поиске и открытии неочевидных истин, формирующих лучший опыт.`,
    'Глас народа': `Ваша сила – в эмпатии и умении быть мостом. Вы отстаиваете потребности людей перед драконами функциональных ограничений и бизнес-требований. Ваши презентации – это истории, которые вдохновляют команду, а обратная связь помогает всем увидеть продукт глазами тех, для кого он создан. Мотивация – в защите интересов пользователя и создании гармонии между людьми и решениями.`,
    'Разрушитель хаоса': `Вы – безжалостный охотник на неясность, неудобство и визуальный шум. Ваша цель – выявить и уничтожить все, что мешает восприятию, пониманию или действию (сложные потоки, противоречивые сообщения, визуальный дисбаланс). После вашего рейда решение сияет чистотой смысла и эффективностью. Мотивация – в устранении барьеров и достижении безусловной ясности.`
  },
  'Продакт менеджер': {
    'Завоеватель рынков': `Ваш продукт – осадная машина, сметающая конкурентов. Вы ставите четкие метрики (MAU, конверсия, удержание) и ведете свою гильдию к их завоеванию. Мотивация – в видимом росте, доле рынка и победе.`,
    'Провидец рынка': `Вы сканируете горизонт будущего, ища неоткрытые земли (ниши, тренды). Ваши видения формируют стратегию, а эксперименты – карту нового пути для гильдии. Мотивация – в предвидении и создании того, чего еще нет.`,
    'Миротворец стейкхолдеров': `Вы – дипломат между враждующими кланами (Dev, Marketing, Sales, Support). Ваша магия – находить общий язык, синхронизировать цели и превращать хаос требований в священный скрам-свиток. Мотивация – в гармонии и совместном движении к цели.`,
    'Балансир спринтов': `Вы – мастер приоритезации на поле боя ресурсов. Ваше искусство – жонглировать фичами-мечами и багами-щитами, фокусируя удар гильдии на главном враге сейчас. Мотивация – в эффективном "убойном" результате каждого спринта.`
  },
  'Менеджер проектов': {
    'Мастер дедлайнов': `Ваш хронометр точен как часы богов. Вы доставляете проектные артефакты точно в срок и в рамках бюджета, как безупречный логист подземелий. Мотивация – в безукоризненном выполнении плана и достижении целей.`,
    'Навигатор хаоса': `Вы читаете карту рисков как открытую книгу. Ваш дар – предвидеть обвалы, болота задержек и находить обходные тропы через хаос неопределенности. Мотивация – в решении головоломок и поиске лучшего пути вперед.`,
    'Дирижер команды': `Вы превращаете группу специалистов в слаженный оркестр. Ваша палочка задает ритм, разрешает разногласия и поддерживает моральный дух даже в аду кретического пути. Мотивация – в силе сплоченной команды и ее успехе.`,
    'Разрушитель преград': `Ваш молот – процессы, ваша ярость – против блокеров. Вы сносите бюрократические стены, разбиваете камни непонимания и расчищаете путь для партии к цели. Мотивация – в преодолении препятствий и победе над хаосом.`
  },
  'Скрам мастер': {
    'Хранитель скорости': `Вы оберегаете Velocity команды как священный Грааль. Ваши ритуалы (ретро) выявляют трение, а заклинания (практики) ускоряют движение гильдии к цели. Мотивация – в стабильном, высоком темпе и прогрессе.`,
    'Призыватель кайдзенов': `Вы – вечный искатель лучших скрам-ритуалов и практик. Ваша магия – находить и внедрять улучшения, делая путь команды глаже и эффективнее. Мотивация – в постоянном поиске и внедрении оптимизаций.`,
    'Мастер церемоний': `Вы – хранитель огня психологической безопасности. Ваши церемонии (планнинг, стендап, ретро) – это костры, вокруг которых греется и объединяется команда. Мотивация – в здоровой, доверительной атмосфере гильдии.`,
    'Охотник на импедансы': `Вы выслеживаете невидимых демонов, тормозящих команду – лишние встречи, бюрократию, разрозненность. Ваша цель – найти и безжалостно устранить их. Мотивация – в устранении всего, что мешает потоку и скорости.`
  },
  'Тимлид': {
    'Архитектор роста': `Вы строите лестницы компетенций для каждого члена гильдии. Ваш план – вести команду к выполнению квартальных целей и спринтов, возводя цитадель профессионализма. Мотивация – в развитии команды и достижении общих целей.`,
    'Навигатор развития': `Вы составляете индивидуальные карты роста для героев вашей гильдии, находите лучшие пути обучения и новые вызовы. Мотивация – в поиске и реализации потенциала каждого.`,
    'Наставник гильдии': `Вы – маяк и опора. Вы взращиваете командный дух, заботитесь о благополучии товарищей и передаете свои знания, превращая группу в настоящую семью-гильдию. Мотивация – в успехе, доверии и единстве команды.`,
    'Щит команды': `Вы встаете на пути внешнего давления, абсурдных сроков и токсичности. Ваш щит принимает удар, защищая пространство, где ваша гильдия может творить магию. Мотивация – в отстаивании интересов и безопасности команды.`
  },
  'Техлид': {
    'Архимаг качества': `Ваши стандарты – неприступная стена. Вы гарантируете, что кодовая база – это крепость надежности, а каждый коммит соответствует высшим канонам мастерства. Мотивация – в техническом совершенстве и безупречности.`,
    'Проводник технологий': `Вы освещаете путь в темных лесах новых технологий и архитектур. Ваша задача – найти, оценить и безопасно провести команду по лучшему пути. Мотивация – во внедрении инноваций и будущего.`,
    'Мудрец кода': `Ваши код-ревью – уроки высшей магии. Вы терпеливо наставляете, делитесь мудростью и помогаете каждому разработчику отточить свое мастерство. Мотивация – в росте экспертизы команды и передаче знаний.`,
    'Судья техдолга': `Вы безжалостны к хаосу и компромиссам. Ваше клеймо техдолга сжигает лень, а ваши решения в архитектурных спорах непоколебимы. Мотивация – в чистоте кода, эффективности и победе над хаотичными решениями.`
  },
  'Саппорт': {
    'Волшебник поддержки': `Ваши решения быстры и точны как магия. Вы закрываете максимум тикетов с высочайшим CSAT, превращая истерику в благодарность. Мотивация – в скорости, эффективности и идеальных метриках разрешения.`,
    'Хранитель истины': `Вы – археолог логов и конфигов. Копая глубже, вы находите первопричины проблем, превращая разрозненные симптомы в ясную картину. Мотивация – в разгадке тайны и предотвращении повторных инцидентов.`,
    'Посол доверия': `Вы – лицо гильдии для клиентов. Ваше спокойствие, эмпатия и умение слушать превращают разгневанных драконов в лояльных союзников, даже в самых сложных ситуациях. Мотивация – в построении позитивных отношений и доверии.`,
    'Охотник за SLA': `Вы мчитесь наперегонки с таймером критичных SLA. Ваша цель – победить время, устранить проблему до последней секунды и доказать надежность гильдии. Мотивация – в азарте погони и победе над сроками.`
  },
  'Девопс': {
    'Страж стабильности': `Ваше царство – 99.99% uptime. Вы выстраиваете неприступную инфраструктуру и безупречные CI/CD конвейеры, работающие как швейцарские часы. Мотивация – в абсолютной надежности и предсказуемости систем.`,
    'Алхимик инфраструктуры': `Ваш котел – Terraform, Kubernetes, облака. Вы смешиваете технологии, создавая зелья автоматизации, превращающие рутину в магию самонастройки. Мотивация – в создании элегантных, эффективных и инновационных решений.`,
    'Говорящий с духами': `Вы – шаман, понимающий язык серверов и облаков. Ваш дар – налаживать диалог между разработчиками и инфраструктурой, синхронизируя их ритмы и создавая общие практики. Мотивация – в гармонизации процессов Dev и Ops.`,
    'Укротитель инцидентов': `Когда рушатся миры (продакшен), вы входите в шторм. Ваша ярость и мастерство усмиряют хаос, локализуют проблему и восстанавливают порядок в рекордные сроки. Мотивация – в победе над кризисом и восстановлении контроля.`
  },
  'Архитектор': {
    'Мудрец систем': `Вы проектируете цитадели кода, способные выдержать штурм миллионов пользователей. Ваши схемы – это карты сокровищ для разработчиков, ведущие к масштабируемым и надежным решениям. Мотивация – в создании технически безупречных и мощных систем.`,
    'Советник будущего': `Вы смотрите на 5-10 лет вперед, оценивая технологические тренды и риски. Ваши рекомендации – это компас, уберегающий гильдию от архитектурных тупиков. Мотивация – в стратегическом видении и выборе долгосрочно выигрышных путей.`,
    'Проповедник смыслов': `Вы – евангелист хорошей архитектуры. Вы умеете объяснить сложные решения простыми словами, найти консенсус между командами и вдохновить их на строительство по вашему плану. Мотивация – во всеобщем понимании и принятии архитектурного видения.`,
    'Искатель антипаттернов': `Ваше копье – критическое мышление. Вы безжалостно разоблачаете и уничтожаете плохие архитектурные решения, монолиты и хаотичные микросервисы, расчищая место для элегантности. Мотивация – в борьбе с неэффективностью и утверждении правильных паттернов.`
  },
  'Аккаунт менеджер': {
    'Зачарователь сделок': `Ваша магия – в контрактах, где выигрывают все. Вы заключаете выгодные сделки, удерживаете ключевых клиентов и гордитесь цифрами retention как завоеванными крепостями. Мотивация – в измеримом успехе и росте аккаунтов.`,
    'Картограф потребностей': `Вы составляете детальные карты экосистемы клиента, выявляя скрытые боли и желания. Ваши находки открывают новые возможности для продуктов гильдии. Мотивация – в глубоком понимании клиента и поиске точек роста.`,
    'Повелитель отношений': `Вы строите мосты доверия и партнерства. Ваши клиенты – ваши вассалы, лояльные и защищенные. Вы превращаете транзакции в долгосрочные союзы. Мотивация – в силе личных связей и взаимном доверии.`,
    'Охотник за возражениями': `Ваши аргументы – серебряные пули против сомнений и отказов. Вы мастерски разбиваете возражения, преодолеваете барьеры и закрываете апсейлы, расширяя влияние гильдии. Мотивация – в победе в сложных переговорах и преодолении сопротивления.`
  },
  'Менеджер по продажам': {
    'Торговец судьбы': `Вы не просто продаете – вы меняете судьбы клиентов. Ваш план продаж – поле битвы, а перевыполнение квот – триумф. Вы гордитесь каждой победой-сделкой. Мотивация – в превышении целей и завоевании рынка.`,
    'Коллекционер путей': `Вы знаете сотни троп к "да". Ваша коллекция – кейсы, методики, подходы, которые вы постоянно пополняете и используете, чтобы найти лучший путь к сердцу (и кошельку) клиента. Мотивация – в поиске и применении самых эффективных тактик.`,
    'Хранитель связей': `Ваша сеть контактов – паутина влияния. Вы соединяете людей, создаете возможности и используете силу отношений для достижения целей. Ваша гильдия продажников сплочена вашей харизмой. Мотивация – в силе сообщества и взаимопомощи.`,
    'Повелитель желаний': `Вы пробуждаете в клиентах жгучую потребность в вашем продукте. Ваши презентации – завораживающие иллюзии, а умение продавать – магия, против которой трудно устоять. Мотивация – в доминировании на переговорах и безоговорочном "да".`
  },
  'Руководитель': {
    'Повелитель ресурсов': `Вы – стратег распределения золота и войск (бюджетов и людей). Ваша цель – максимальная отдача от каждого вложенного ресурса для завоевания бизнес-целей. Мотивация – в эффективности, ROI и достижении стратегических KPI.`,
    'Провидец': `Вы сканируете горизонты рынка, технологий и бизнес-моделей. Ваши стратегические видения – карта, по которой движется вся гильдия в будущее. Мотивация – в предвидении трендов и формировании будущего компании.`,
    'Связующий звезды': `Вы создаете галактику из разрозненных команд и направлений. Ваша харизма и видение объединяют людей, формируя сильную корпоративную культуру и общие ценности. Мотивация – в единстве, силе коллектива и разделяемом всеми успехе.`,
    'Убийца стагнации': `Вы – реформатор, безжалостный к бюрократии и устаревшим процессам. Ваши решения рубят головы гидре неэффективности, открывая путь для инноваций и скорости. Мотивация – в преодолении инерции, драйве изменений и конкурентном преимуществе.`
  },
  'HR': {
    'Инженер талантов': `Вы строите эффективные конвейеры найма, снижаете turnover и гордитесь метриками закрытых вакансий и удержания звезд. Ваша крепость – сильный, надежный кадровый состав. Мотивация – в измеримых результатах построения команды.`,
    'Картограф мотивации': `Вы составляете уникальные карты драйверов и демотиваторов для каждого "героя" и "клана". Ваши исследования помогают находить ключи к истинному вовлечению. Мотивация – в понимании сложной природы мотивации и поиске лучших решений.`,
    'Изгнанник выгорания': `Вы – главный защитник от темных сил апатии и усталости. Ваши ритуалы (тимбилдинги, программы well-being) и обереги (обратная связь, поддержка) создают благоприятный климат в гильдии. Мотивация – в психологическом благополучии и душе команды.`,
    'Охотник за головами': `Вы – элитный рекрутер, выслеживающий топ-таланты на рынке. Ваша цель – привлечь в гильдию самых сильных "персонажей", переманивая их у конкурентов. Мотивация – в победе в "войне за таланты" и усилении гильдии суперзвездами.`
  }
};

// Добавляем пропсы для компонента Onboarding
interface OnboardingProps {
  onComplete: () => void;
  userId?: number; // Изменён тип с string на number
  initData?: string;
}

const Onboarding = ({ onComplete, userId, initData }: OnboardingProps) => {
  const [step, setStep] = useState<'role' | 'test' | 'result'>('role');
  const [selectedRole, setSelectedRole] = useState<Role | null>(null);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState<Answer[]>([]);
  const [baseType, setBaseType] = useState<BaseType | null>(null);
  const [characterClass, setCharacterClass] = useState<string | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [saveError, setSaveError] = useState<string | null>(null);

  // Роли для выпадающего списка
  const roles: Role[] = [
    'Разработчик', 'Инженер по безопасности', 'Тестер', 'Аналитик', 
    'Дизайнер', 'Продакт менеджер', 'Менеджер проектов', 'Скрам мастер',
    'Тимлид', 'Техлид', 'Саппорт', 'Девопс', 'Архитектор', 
    'Аккаунт менеджер', 'Менеджер по продажам', 'Руководитель', 'HR'
  ];

  // Обработчик выбора роли
  const handleRoleSelect = (role: Role) => {
    setSelectedRole(role);
    setStep('test');
  };

  // Обработчик ответа на вопрос
  const handleAnswer = (answer: Answer) => {
    const newAnswers = [...answers, answer];
    setAnswers(newAnswers);

    if (currentQuestion < QUESTIONS.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
    } else {
      calculateBaseType(newAnswers);
    }
  };

  // Расчет базового типа персонажа
  const calculateBaseType = (answers: Answer[]) => {
    const scores = {
      'Достигатор': 0,
      'Исследователь': 0,
      'Социализатор': 0,
      'Убийца': 0
    };

    answers.forEach(answer => {
      const type = ANSWER_TO_TYPE[answer];
      scores[type]++;
    });

    const maxScore = Math.max(...Object.values(scores));
    const finalType = (Object.keys(scores) as BaseType[]).find(
      key => scores[key] === maxScore
    ) || 'Достигатор';

    setBaseType(finalType);
    setStep('result');
  };

  // Определение класса персонажа на основе роли и базового типа
  useEffect(() => {
    if (step === 'result' && selectedRole && baseType) {
      const classForRole = ROLE_TYPE_TO_CLASS[selectedRole][baseType];
      setCharacterClass(classForRole);
    }
  }, [step, selectedRole, baseType]);

  // Сохранение результата
  const saveResult = async () => {
    if (!characterClass || !userId || !initData) {
      setSaveError("Недостаточно данных для сохранения");
      return;
    }

    setIsSaving(true);
    setSaveError(null);

    try {
      const response = await api.updateUserClass(userId, characterClass, initData);
      
      if (!response.success) {
        throw new Error(response.error || "Неизвестная ошибка сервера");
      }
      
      onComplete();
    } catch (error: any) {
      console.error('Ошибка сохранения класса:', error);
      setSaveError(error.message || "Ошибка при сохранении данных");
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="min-h-screen bg-dungeon bg-cover text-white p-4 relative">
      {step === 'role' && (
        <div className="max-w-md mx-auto mt-20 text-center">
          <h1 className="text-2xl font-bold mb-6">Добро пожаловать в Подземелье Moraleon!</h1>
          <p className="mb-8">Выбери свою роль в гильдии:</p>
          
          <div className="relative">
            <select 
              onChange={(e) => handleRoleSelect(e.target.value as Role)}
              className="w-full p-4 bg-gray-800 border-2 border-gold rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="">-- Выбери свою роль --</option>
              {roles.map(role => (
                <option key={role} value={role}>{role}</option>
              ))}
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
              <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
              </svg>
            </div>
          </div>
        </div>
      )}

      {step === 'test' && (
        <div className="max-w-md mx-auto mt-10 bg-gray-900 bg-opacity-80 p-6 rounded-xl border-2 border-purple-700">
          <div className="mb-4 text-center">
            <h2 className="text-xl font-bold mb-2">Испытание духа</h2>
            <p className="text-sm mb-4">Вопрос {currentQuestion + 1} из {QUESTIONS.length}</p>
            <div className="w-full bg-gray-700 rounded-full h-2.5">
              <div 
                className="bg-blue-600 h-2.5 rounded-full" 
                style={{ width: `${((currentQuestion + 1) / QUESTIONS.length) * 100}%` }}
              ></div>
            </div>
          </div>

          <div className="mb-6">
            <p className="text-lg font-medium mb-4">{QUESTIONS[currentQuestion]}</p>
            <div className="space-y-3">
              {OPTIONS[currentQuestion].map((option, index) => (
                <button
                  key={index}
                  onClick={() => handleAnswer(String.fromCharCode(97 + index) as Answer)}
                  className="w-full p-3 bg-gray-800 hover:bg-gray-700 border border-purple-600 rounded-lg text-left transition-all duration-200 transform hover:scale-[1.02]"
                >
                  {option}
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {step === 'result' && selectedRole && baseType && characterClass && (
        <div className="max-w-md mx-auto mt-10 text-center">
          <h2 className="text-2xl font-bold mb-6">Твой Класс определён!</h2>
          <div className="bg-gray-900 bg-opacity-80 p-6 rounded-xl border-2 border-gold mb-6">
            <h3 className="text-xl font-bold text-yellow-400 mb-2">{characterClass}</h3>
            <p className="text-lg mb-4">{CLASS_DESCRIPTIONS[selectedRole][characterClass]}</p>
            <p className="text-sm italic">Твоё путешествие в Подземелье Мотивации начинается!</p>
          </div>

          {saveError && (
            <div className="text-red-500 text-center mb-4">
              {saveError}
            </div>
          )}

          <button
            onClick={saveResult}
            disabled={isSaving}
            className={`w-full p-3 bg-green-700 rounded-lg font-bold ${
              isSaving ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-600'
            }`}
          >
            {isSaving ? 'Сохранение...' : 'Принять Судьбу'}
          </button>
        </div>
      )}
      
      {isSaving && (
  <div className="fixed inset-0 z-50">
    <div className="absolute inset-0 bg-black bg-opacity-70"></div>
    <div className="relative w-full h-full flex items-center justify-center">
      <div style={{
        width: 'min(90%, 400px)',
        aspectRatio: '1/1',
        backgroundImage: 'url(/IMG_0413.png)', 
        backgroundSize: 'cover',
        backgroundRepeat: 'no-repeat',
        backgroundPosition: 'center',
        animation: 'pulse 1.5s infinite ease-in-out'
      }}></div>
    </div>
    
    <style>{`
      @keyframes pulse {
        0% { transform: scale(0.95); opacity: 0.8; }
        50% { transform: scale(1.05); opacity: 1; }
        100% { transform: scale(0.95); opacity: 0.8; }
      }
    `}</style>
  </div>
)}
    </div>
  );
};

export default Onboarding;
