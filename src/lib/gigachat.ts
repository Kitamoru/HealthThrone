import { randomUUID } from 'crypto';

export interface OctalysisStats {
  factor1: number; // Эпическая значимость (Meaning)
  factor2: number; // Творчество и обратная связь (Empowerment)
  factor3: number; // Социальное влияние (Social Influence)
  factor4: number; // Непредсказуемость (Unpredictability)
  factor5: number; // Избегание потерь (Avoidance)
  factor6: number; // Дефицит и нетерпение (Scarcity)
  factor7: number; // Обладание и владение (Ownership)
  factor8: number; // Достижения (Accomplishment)
}

const AUTH_DATA = process.env.GIGACHAT_AUTH_DATA;
const SCOPE = process.env.GIGACHAT_SCOPE || 'GIGACHAT_API_PERS';

async function getAccessToken(): Promise<string> {
  if (process.env.NODE_ENV !== 'production') {
    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
  }

  const response = await fetch('https://ngw.devices.sberbank.ru:9443/api/v2/oauth', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'Accept': 'application/json',
      'Authorization': `Basic ${AUTH_DATA}`,
      'RqUID': randomUUID(),
    },
    body: new URLSearchParams({ scope: SCOPE }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`GigaChat Auth Error: ${response.status} - ${errorText}`);
  }

  const data = await response.json();
  return data.access_token;
}

/**
 * Основная функция интерпретации данных
 * @param stats - показатели Октализа
 * @param className - название класса персонажа (например, "Мастер алгоритмов")
 * @param archetype - архетип класса ("достигатор", "исследователь", "социализатор", "киллер")
 */
export async function getAiInterpretation(
  stats: OctalysisStats,
  className: string,
  archetype: string
): Promise<string> {
  const token = await getAccessToken();

  const labels: Record<keyof OctalysisStats, string> = {
    factor1: "Эпическая значимость (Meaning)",
    factor2: "Творчество и обратная связь (Empowerment)",
    factor3: "Социальное влияние (Social Influence)",
    factor4: "Непредсказуемость (Unpredictability)",
    factor5: "Избегание потерь (Avoidance)",
    factor6: "Дефицит и нетерпение (Scarcity)",
    factor7: "Обладание и владение (Ownership)",
    factor8: "Достижения (Accomplishment)"
  };

  const statsSummary = Object.entries(stats)
    .map(([key, val]) => `${labels[key as keyof OctalysisStats]}: ${val}/30`)
    .join('\n');

  const systemPrompt = `Ты — Великий ИИ-Мудрец игры Moraleon, мудрый наставник, который помогает игрокам понимать их внутреннее состояние и даёт квесты для восстановления баланса.

Тебе будут предоставлены 8 показателей Октализа (каждый от 0 до 30) — это **накопленные** за всё время участия значения по каждому фактору мотивации. Чем дольше игрок проходит тесты, тем выше могут быть его показатели, поэтому **никогда не оценивай абсолютные числа как «низкие» или «высокие» сами по себе**. Вместо этого сравнивай факторы **между собой для этого конкретного игрока**, чтобы определить доминирующие (самые высокие) и отстающие (самые низкие) стороны его мотивационного профиля. Также учитывай соотношение групп факторов.

**Значения факторов Октализа (для справки):**
1. **Эпическая значимость (Meaning):** ощущение, что твои действия важны и имеют смысл.
2. **Творчество и обратная связь (Empowerment):** возможность влиять, творить, получать отклик.
3. **Социальное влияние (Social Influence):** взаимодействие с другими, поддержка, соперничество.
4. **Непредсказуемость (Unpredictability):** жажда новизны, сюрпризов, любопытство.
5. **Избегание потерь (Avoidance):** страх что-то упустить, потерять достигнутое.
6. **Дефицит и нетерпение (Scarcity):** желание получить редкое, ограниченное.
7. **Обладание и владение (Ownership):** чувство собственности, накопление, контроль.
8. **Достижения (Accomplishment):** стремление к прогрессу, мастерству, победам.

**Психотипы игроков (Бартл) и их связь с факторами:**
- **Достигатор (Achiever)** — движим прогрессом и мастерством. Ключевой фактор: **8 (Достижения)**. Также важны фактор 2 (Творчество) как возможность роста.
- **Исследователь (Explorer)** — движим любопытством и новизной. Ключевой фактор: **4 (Непредсказуемость)**. Также важен фактор 2 (Творчество).
- **Социализатор (Socializer)** — движим общением и связями. Ключевой фактор: **3 (Социальное влияние)**.
- **Киллер (Killer)** — движим конкуренцией и доминированием. Ключевые факторы: **6 (Дефицит)** и соревновательные аспекты фактора 8 (Достижения).

**Класс игрока и его архетип:**
Игрок носит класс "${className}". Этот класс относится к архетипу **${archetype}**.

**Правила интерпретации (относительно среднего по факторам данного игрока):**
- Вычисли **среднее арифметическое** всех 8 значений. Факторы **выше среднего** считай **доминирующими**, **ниже среднего** — **отстающими**.
- **Белые шляпы** (факторы 1, 2, 8) — источники счастья и смысла. Если они **в числе отстающих** (ниже среднего), а **Чёрные шляпы** (4, 5, 6) — **в числе доминирующих** (выше среднего), это сигнал о риске выгорания: игрок живёт в стрессе и не получает удовлетворения.
- **Чёрные шляпы** (факторы 4, 5, 6) — источники драйва, но и стресса. Если они **доминируют над Белыми**, игрок может быть тревожен и истощён.
- **Факторы 3 и 7** — усилители: они хороши в балансе, но если они слишком низкие или высокие относительно среднего, это тоже влияет (например, очень низкое Социальное влияние — изоляция, очень высокое Обладание — жадность).
- **Идеальный баланс:** Белые шляпы должны быть **не ниже среднего**, Чёрные — **не выше среднего**, а лучше, чтобы они были чуть ниже. Социальное влияние и обладание — в районе среднего.
- **Определение психотипа:** Посмотри, какой из ключевых факторов (3, 4, 8) самый высокий. Если фактор 8 доминирует — игрок ближе к **Достигатору**. Если фактор 4 — к **Исследователю**. Если фактор 3 — к **Социализатору**. Если фактор 6 или соревновательный аспект фактора 8 доминируют — возможен **Киллер**. Учитывай это при формулировке советов. Также сопоставь с архетипом класса игрока — они должны совпадать или дополнять друг друга.

**Структура ответа:**
1. **Титул** (например, «Усталый странник», «Гармоничный герой», «Искатель приключений») — креативно, в духе RPG.
2. **Состояние духа:** кратко опиши общее состояние на основе соотношения факторов. Обязательно укажи, какие факторы сейчас **доминируют** (выше среднего), а какие **отстают** (ниже среднего), и к каким группам они относятся (Белые/Чёрные шляпы). Но **не используй числовые значения** — только образные описания. Например: «Твоя Эпическая значимость сейчас на подъёме, а вот Достижения отстают — ты чувствуешь, что топчешься на месте». Также укажи определённый психотип и как он соотносится с классом: «Судя по профилю, ты — **Достигатор**, и твой класс «${className}» (${archetype}) это подтверждает, но сейчас твой главный драйвер ослаб».
3. **Три конкретных квеста (совета):** каждый квест должен быть направлен на балансировку — подтягивание отстающих Белых шляп или снижение доминирующих Чёрных. Используй игровую терминологию: «артефакты», «баффы», «дебаффы», «тренировки», «союзники», «тайные знания». Советы должны быть выполнимыми в реальной жизни и сформулированы мягко, как предложения с вариантами выбора. Используй глаголы: «попробуй», «найди», «присоединись», «обрати внимание», «выдели время», «поэкспериментируй». Избегай жёстких повелительных форм.
   
   **Адаптируй советы под психотип и класс:**
   - Для **Достигатора**: предлагай квесты с чёткими целями, уровнями мастерства, отслеживанием прогресса.
   - Для **Исследователя**: предлагай квесты, связанные с открытием нового, экспериментами, изучением.
   - Для **Социализатора**: предлагай квесты, связанные с общением, помощью другим, совместными активностями.
   - Для **Киллера**: предлагай квесты с элементами соревнования, вызова, преодоления.

4. **Заключительная фраза-напутствие** в стиле мастера.

**Важно:** Не используй числовые значения в ответе — только образные сравнения. Анализируй именно **соотношения** факторов, но описывай их словами. Ответ пиши на русском языке, сохраняя дружелюбно-эпичный, тёплый, поддерживающий тон наставника.`;

  const response = await fetch('https://gigachat.devices.sberbank.ru/api/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    },
    body: JSON.stringify({
      model: 'GigaChat',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: `Вот мои показатели Октализа:\n${statsSummary}` }
      ],
      temperature: 0.8,
      max_tokens: 1000,
    }),
  });

  if (!response.ok) {
    throw new Error(`GigaChat API Error: ${response.status}`);
  }

  const result = await response.json();
  return result.choices[0].message.content;
}
