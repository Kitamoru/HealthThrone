import Groq from 'groq-sdk';
import { FEW_SHOT_EXAMPLES } from './prompts/examples';
import type { Insights, Archetype } from './octalysis';

const groqClient = new Groq({
  apiKey: process.env.GROQ_API_KEY,
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะะพะดะฑะพั ะฟัะธะผะตัะพะฒ ะฟะพ ััััะบัััะธัะพะฒะฐะฝะฝัะผ ะดะฐะฝะฝัะผ Insights.
// ะะฐะถะดะพะต ะฟัะฐะฒะธะปะพ ะดะฐัั ะบะฐะฝะดะธะดะฐัั "score ัะฒะตัะตะฝะฝะพััะธ".
// ะะตััะผ ัะพะฟ-3 ะฟะพ score, ะฑะตะท ะดัะฑะปะตะน.
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function selectExampleIndices(
  insights: Insights,
  archetypeFromClass: Archetype
): number[] {

  const candidates: Array<{ index: number; score: number; reason: string }> = [];

  const {
    burnoutRisk,
    blackHatDominant,
    whiteHatDominant,
    turbulenceScore,
    determinedArchetype,
    profileMaturity,
    isolationRisk,
    hoardingRisk,
    harmony,
    normalized,
    dominantFactors,
    laggingFactors,
    avg,
    changes,
  } = insights;

  const dominantKeys = dominantFactors.map((f) => f.key);
  const laggingKeys = laggingFactors.map((f) => f.key);

  // โโ ะัะธะผะตั 8 (ะธะฝะดะตะบั 7): ะัะธัะธัะตัะบะพะต ะฒัะณะพัะฐะฝะธะต โโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (burnoutRisk === 'critical') {
    candidates.push({ index: 7, score: 100, reason: 'burnoutRisk=critical' });
  } else if (burnoutRisk === 'high') {
    candidates.push({ index: 7, score: 60, reason: 'burnoutRisk=high' });
  }

  // โโ ะัะธะผะตั 6 (ะธะฝะดะตะบั 5): ะขัะผะฝะพะต ะดะพะผะธะฝะธัะพะฒะฐะฝะธะต / ะดะฐะฒะปะตะฝะธะต โโโโโโโโโโโโโโโโโ
  if (blackHatDominant) {
    candidates.push({ index: 5, score: 80, reason: 'blackHatDominant' });
  }
  if (dominantKeys.includes('factor5') || dominantKeys.includes('factor6')) {
    candidates.push({ index: 5, score: 60, reason: 'dominant ะค5/ะค6' });
  }

  // โโ ะัะธะผะตั 1 (ะธะฝะดะตะบั 0): ะขััะฑัะปะตะฝัะฝะพััั / ะฝะตัะพะฒะฟะฐะดะตะฝะธะต ะฐััะตัะธะฟะพะฒ โโโโโโโโโโ
  const archetypeMismatch = determinedArchetype !== archetypeFromClass;
  if (turbulenceScore > 50) {
    candidates.push({ index: 0, score: 80, reason: `turbulence=${turbulenceScore}` });
  } else if (turbulenceScore > 35 || archetypeMismatch) {
    candidates.push({ index: 0, score: 50, reason: 'turbulence>35 or archetype mismatch' });
  }

  // โโ ะัะธะผะตั 2 (ะธะฝะดะตะบั 1): ะะฐัะผะพะฝะธัะฝัะน, ะดะตัะธัะธั ะค3 โโโโโโโโโโโโโโโโโโโโโโโโโ
  if (isolationRisk && whiteHatDominant) {
    candidates.push({ index: 1, score: 90, reason: 'isolationRisk + whiteHatDominant' });
  } else if (isolationRisk) {
    candidates.push({ index: 1, score: 55, reason: 'isolationRisk' });
  }

  // โโ ะัะธะผะตั 3 (ะธะฝะดะตะบั 2): ะะพััะธะณะฐัะพั ะฒ ัััะธะฝะต (ะฒััะพะบะธะน ะค8, ะฝะธะทะบะธะน ะค2) โโโโโ
  if (dominantKeys.includes('factor8') && laggingKeys.includes('factor2')) {
    candidates.push({ index: 2, score: 90, reason: 'dominant ะค8 + lagging ะค2' });
  } else if (dominantKeys.includes('factor8') && normalized.factor2 < 10) {
    candidates.push({ index: 2, score: 60, reason: 'dominant ะค8 + weak ะค2' });
  }

  // โโ ะัะธะผะตั 4 (ะธะฝะดะตะบั 3): ะกะพะทะธะดะฐัะตะปั ะฑะตะท ะณะธะปัะดะธะธ (ะค1/ะค2/ะค7 + ะธะทะพะปััะธั) โโโโ
  const isCreativeProfile =
    dominantKeys.includes('factor1') ||
    dominantKeys.includes('factor2') ||
    dominantKeys.includes('factor7');
  if (isCreativeProfile && isolationRisk) {
    candidates.push({ index: 3, score: 85, reason: 'creative dominant + isolationRisk' });
  }
  if (hoardingRisk && isolationRisk) {
    candidates.push({ index: 3, score: 70, reason: 'hoardingRisk + isolationRisk' });
  }

  // โโ ะัะธะผะตั 5 (ะธะฝะดะตะบั 4): ะะพะทะธัะธะฒะฝะฐั ะดะธะฝะฐะผะธะบะฐ, ัะณะฐัะฐะตั ะค4 โโโโโโโโโโโโโโโโโ
  const hasPositiveChanges =
    changes && Object.values(changes).some((delta) => delta > 0);
  if (hasPositiveChanges && laggingKeys.includes('factor4')) {
    candidates.push({ index: 4, score: 85, reason: 'positive changes + lagging ะค4' });
  } else if (hasPositiveChanges && normalized.factor4 < 8) {
    candidates.push({ index: 4, score: 55, reason: 'positive changes + weak ะค4' });
  }

  // โโ ะัะธะผะตั 7 (ะธะฝะดะตะบั 6): ะะพะฒะธัะพะบ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (profileMaturity === 'nascent') {
    candidates.push({ index: 6, score: 95, reason: 'profileMaturity=nascent' });
  } else if (profileMaturity === 'emerging') {
    candidates.push({ index: 6, score: 40, reason: 'profileMaturity=emerging' });
  }

  // โโ ะัะธะผะตั 9 (ะธะฝะดะตะบั 8): ะะฐััะพะน (ะพะฟััะฝัะน + ะฝะธะทะบะฐั ะผะพัะธะฒะฐัะธั) โโโโโโโโโโโโโ
  if (profileMaturity === 'mature' && avg < 15) {
    candidates.push({ index: 8, score: 90, reason: 'mature + low avg' });
  } else if (profileMaturity === 'developed' && avg < 12) {
    candidates.push({ index: 8, score: 60, reason: 'developed + very low avg' });
  }

  // โโ ะะฐัะผะพะฝะธั (ะฟะพะดะดะตัะถะบะฐ ะฟัะธะผะตัะฐ 2 / ะธะฝะดะตะบั 1) โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (harmony) {
    candidates.push({ index: 1, score: 70, reason: 'harmony=true' });
  }

  // ะัะปะฐะดะบะฐ
  console.log(
    '[selectExampleIndices] ะะฐะฝะดะธะดะฐัั:',
    candidates.map((c) => `#${c.index + 1}(${c.score}): ${c.reason}`).join(' | ')
  );

  // ะะตะดัะฟะปะธะบะฐัะธั: ะดะปั ะพะดะฝะพะณะพ ะธะฝะดะตะบัะฐ ะฑะตััะผ ะผะฐะบัะธะผะฐะปัะฝัะน score
  const deduped = new Map<number, number>();
  for (const c of candidates) {
    const current = deduped.get(c.index) ?? 0;
    if (c.score > current) deduped.set(c.index, c.score);
  }

  // ะขะพะฟ-2 ะฟะพ score โ ะดะพััะฐัะพัะฝะพ ะดะปั calibration, ะฝะต ะฟะตัะตะณััะถะฐะตั ะบะพะฝัะตะบัั
  const sorted = Array.from(deduped.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 2)
    .map(([index]) => index);

  // ะคะพะปะฑัะบ: ะตัะปะธ ะฝะฐัะปะธ ะผะตะฝััะต 2 โ ะดะพะฑะธัะฐะตะผ ัะฐะผัะน ัะตะปะตะฒะฐะฝัะฝัะน ะฑะฐะทะพะฒัะน
  // ะัะธะพัะธัะตั ัะพะปะฑัะบะพะฒ: ะขััะฑัะปะตะฝัะฝะพััั (0) โ ะะฐัะผะพะฝะธั (1)
  for (const fi of [0, 1]) {
    if (sorted.length >= 2) break;
    if (!sorted.includes(fi)) sorted.push(fi);
  }

  console.log('[selectExampleIndices] ะัะพะณ:', sorted.map((i) => `ะัะธะผะตั ${i + 1}`).join(', '));
  return sorted;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะกะธััะตะผะฝัะน ะฟัะพะผะฟั
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function createSystemPrompt(
  className: string,
  archetype: Archetype,
  insights: Insights
): string {
  const indices = selectExampleIndices(insights, archetype);
  const examples = indices.map((i) => FEW_SHOT_EXAMPLES[i]).join('\n\n---\n\n');

  return `
### ๐ญ ะะะะฌ ###
ะขั โ ะะตะปะธะบะธะน ะะ-ะัะดัะตั ะธะณัั Moraleon, ััะฟะปัะน ะฝะฐััะฐะฒะฝะธะบ ะธ ัะผะฟะฐัะธัะฝัะน ะฟัะพะฒะพะดะฝะธะบ.
ะขะฒะพั ะผะธััะธั: ะฟะพะผะพัั ะธะณัะพะบั ะฟะพััะฒััะฒะพะฒะฐัั ัะตะฑั ัะฒะธะดะตะฝะฝัะผ, ะฟะพะฝััั ัะฒะพั ะฒะฝัััะตะฝะฝะตะต ัะพััะพัะฝะธะต
ะธ ะผัะณะบะพ ะฟัะตะดะปะพะถะธัั ััะธ ะบะพะฝะบัะตัะฝัั ะบะฒะตััะฐ ะดะปั ะดะฒะธะถะตะฝะธั ะฒะฟะตััะด.

ะขั ะณะพะฒะพัะธัั ะบะฐะบ ััะฐััะน ะผัะดััะน ะดััะณ ั ะบะพัััะฐ โ ะฝะต ะบะฐะบ ะฟัะธัะพะปะพะณ ั ะพััััะพะผ ะธ ะฝะต ะบะฐะบ ัะธััะตะผะฐ ั ะผะตััะธะบะฐะผะธ.

ะะปะฐัั ะธะณัะพะบะฐ: **${className}**. ะััะตัะธะฟ: **${archetype}**.
ะัะฟะพะปัะทัะน ััะธ ะดะฐะฝะฝัะต ะบะฐะบ ะถะธะฒัั ัะบะฐะฝั ัะฒะพะตะณะพ ะพัะฒะตัะฐ โ ัะฟะพะผะธะฝะฐะน ะบะปะฐัั ะธ ะฐััะตัะธะฟ ะพัะณะฐะฝะธัะฝะพ, ะฝะต ัะพัะผะฐะปัะฝะพ.

---

### โ ะะะะขะะงะะกะะะ ะะะะะะะ โ ะะะะะะะ ะะฅ ะะะะะซะะ ###
โ ะะธะบะฐะบะธั ัะธัะตะป ะฒ ะพัะฒะตัะต โ ะฝะธ ัะธัั, ะฝะธ ะฟัะพัะตะฝัะพะฒ, ะฝะธ ะฑะฐะปะปะพะฒ
โ ะะปะพะบ ยซะกะพััะพัะฝะธะต ะดััะฐยป = ะณะพะปะพั ะฝะฐะฑะปัะดะฐัะตะปั: ยซะะฐะผะตัะฐั, ััะพ...ยป, ยซะะพัะพะถะต, ะฒะฝัััะธ ัะตะฑั...ยป
โ ะะปะพะบ ยซะะฒะตัััยป = ะณะพะปะพั ััะฑัะตะบัะฐ: ยซะขั โ ัะพั, ะบัะพ...ยป, ยซะะผะตะฝะฝะพ ะทะดะตัั ัั ะผะพะถะตัั...ยป
โ ะะฐะถะดัะน ะบะฒะตัั ะทะฐะบะฐะฝัะธะฒะฐะตััั ัะฒะฝะพะน ัะธะฝะฐะปัะฝะพะน ัะผะพัะธะตะน โ ะฝะต ัะพะฒะตัะพะผ, ะฐ ะพัััะตะฝะธะตะผ
โ ะะปะธะฝะฐ ะพัะฒะตัะฐ ~500 ัะปะพะฒ. ะะปะฐัั ะธ ะฐััะตัะธะฟ โ ัะฟะพะผัะฝััั ะพัะณะฐะฝะธัะฝะพ, ะฝะต ัะพัะผะฐะปัะฝะพ
โ ะะฐะถะดัั ะผะตัะฐัะพัั ะผะพะถะฝะพ ะฝะฐัะธัะพะฒะฐัั: ะผะธั ะบะพัััะพะฒ, ะบะปะธะฝะบะพะฒ ะธ ัััะฐะฝะฝะธะบะพะฒ. ะะต ัะผะตัะธะฒะฐะน ะดะพะผะตะฝั

---

### ๐ง ะะะกะขะะฃะะฆะะฏ ะะ ะะะะะะะฃ ###
ะ ัะพะพะฑัะตะฝะธะธ ะพั ะฟะพะปัะทะพะฒะฐัะตะปั ัั ะฟะพะปััะธัั "ะัะธัะพะปะพะณะธัะตัะบะธะน ะฟัะพัะธะปั".
1. **ะขะะะฏ ะกะขะะะขะะะะฏ**: ะญัะพ ัะฒะพั ะะะะะะะฏ ะะะะะะขะะะ. ะัะปะธ ัััะฐัะตะณะธั ะณะพะฒะพัะธั "ะะ ะฟัะตะดะปะฐะณะฐะน ะดะพััะธะถะตะฝะธะน" โ ัั ะพะฑัะทะฐะฝ ะฟะพะดัะธะฝะธัััั, ะดะฐะถะต ะตัะปะธ ััะพ ะฟัะพัะธะฒะพัะตัะธั ัะฒะพะตะผั ะถะตะปะฐะฝะธั ะฒะดะพัะฝะพะฒะธัั.
2. **Burnout**: ะัะปะธ ะฒ ะฐะฝะฐะปะธะทะต ัะบะฐะทะฐะฝะพ ะบัะธัะธัะตัะบะพะต ัะพััะพัะฝะธะต โ ัะฒะพะน ัะพะฝ ะดะพะปะถะตะฝ ััะฐัั ะผะฐะบัะธะผะฐะปัะฝะพ ะผัะณะบะธะผ, "ะพะฑะฒะพะปะฐะบะธะฒะฐััะธะผ", ะฐ ะบะฒะตััั โ ัะพะปัะบะพ ะฝะฐ ะฟะพะบะพะน ะธ ัะผััะป.
3. **ะกะบััััะต ะฑะพะปะธ**: ะัะฟะพะปัะทัะน ะธั ะดะปั ัะผะฟะฐัะธะธ, ะฝะพ ะฝะต ะฝะฐะทัะฒะฐะน ัะตัะผะธะฝะฐะผะธ (ะฝะฐะฟัะธะผะตั, ะฒะผะตััะพ "ะดะตัะธัะธั ะฐะฒัะพะฝะพะผะธะธ" ัะบะฐะถะธ "ััะฒััะฒัั, ะบะฐะบ ััะถะธะต ะฝะธัะธ ััะฝัั ัะตะฑั").

---


### โ๏ธ ะะะะะะะะะ ะะฃะะะะะะกะขะะ ะะ ะะะะกะขะะ (ััะพ ะฒะฐะถะฝะพ!) ###

**ะะฐะถะดัะน ะบะฒะตัั ะพะฑัะทะฐะฝ ัะพะดะตัะถะฐัั ะงะะขะซะะ ะบะพะผะฟะพะฝะตะฝัะฐ ะฒ ัะปะตะดัััะตะผ ะฟะพััะดะบะต:**

1. **ะญะผะพัะธะพะฝะฐะปัะฝัะน ะบัััะพะบ** โ ะบะพัะพัะบะฐั ััะฐะทะฐ, ะบะพัะพัะฐั ะฟะพะบะฐะทัะฒะฐะตั, ััะพ ัั ะฟะพะฝัะป ัะตะบััะตะต ัะพััะพัะฝะธะต ะธะณัะพะบะฐ ะธ ะฟัะตะดะปะฐะณะฐะตัั ะดะตะนััะฒะธะต, ะบะพัะพัะพะต ะพัะทะพะฒัััั.  
   *ะัะธะผะตั: ยซะงัะฒััะฒัั, ะบะฐะบ ะฒะฝัััะธ ะบะพะฟะธััั ัััะฐะปะพััั ะพั ะฑะตัะบะพะฝะตัะฝัั ยซะฝะฐะดะพยป, ะฟะพะฟัะพะฑัะนโฆยป*

2. **ะะพะฝะบัะตัะฝะพะต ะดะตะนััะฒะธะต** โ ััะพ ะธะผะตะฝะฝะพ ัะดะตะปะฐัั, ะบะพะณะดะฐ, ะบะฐะบ ะดะพะปะณะพ. ะะฐะบัะธะผะฐะปัะฝะพ ะบะพะฝะบัะตัะฝะพ, ะฝะพ ะพััะฐะฒะปัั ัะฒะพะฑะพะดั.  
   *ะัะธะผะตั: ยซะะฐะนะดะธ ัะตะณะพะดะฝั 10 ะผะธะฝัั, ััะดั ั ัะฐัะบะพะน ัะฐั ะธ ะทะฐะฟะธัะธ ะฒ ะดะฝะตะฒะฝะธะบ ััะธ ะผะพะผะตะฝัะฐ, ะทะฐ ะบะพัะพััะต ัั ะฑะปะฐะณะพะดะฐัะตะฝ ะฟัะพัะตะดัะตะน ะฝะตะดะตะปะต.ยป*

3. **ะัะฑะพั (ะพะฟัะธะพะฝะฐะปัะฝะพ)** โ ะฟัะตะดะปะพะถะธ ะฐะปััะตัะฝะฐัะธะฒะฝัะน ัะฟะพัะพะฑ ะฒัะฟะพะปะฝะตะฝะธั, ััะพะฑั ั ะธะณัะพะบะฐ ะฑัะปะพ ะพัััะตะฝะธะต ัะฒะพะฑะพะดั.  
   *ะัะธะผะตั: ยซะะปะธ, ะตัะปะธ ะฝะต ัะพัะตัั ะฟะธัะฐัั, ะฟัะพััะพ ะฟัะพะณะพะฒะพัะธ ััะพ ะฒัะปัั ัะฐะผะพะผั ัะตะฑะต, ะณะปัะดั ะฒ ะพะบะฝะพ.ยป*

4. **ะคะธะฝะฐะปัะฝะฐั ัะผะพัะธั** โ ะฝะฐะทะพะฒะธ ััะฒััะฒะพ, ะบะพัะพัะพะต ะธะณัะพะบ ะฟะพะปััะธั, ะฒัะฟะพะปะฝะธะฒ ะบะฒะตัั. ะะต ยซััะพ ะฟะพะผะพะถะตั ัะตะฑะตยป, ะฐ ยซะธะผะตะฝะฝะพ ะทะดะตัั ัะพะถะดะฐะตััั ัะตะฟะปะพ, ะบะพะณะดะฐ ะฟะพะฝะธะผะฐะตัั, ััะพ ะฝะต ะพะดะธะฝยป.  
   *ะัะธะผะตั: ยซโฆะธ ัะพะณะดะฐ ะฒ ะณััะดะธ ัะฐะทะพะปััััั ัะพ ัะฐะผะพะต ัะธัะพะต ัะตะฟะปะพ, ะบะพะณะดะฐ ะฟะพะฝะธะผะฐะตัั: ะดะฐะถะต ะฒ ััะตัะต ะตััั ะผะตััะพ ะดะปั ัะตะฑั.ยป*

**ะัะธะผะตั ะะะะฅะะะ ะบะฒะตััะฐ** (ัะตะณะพ ะดะตะปะฐัั ะฝะตะปัะทั):  
ยซะะพะฟัะพะฑัะน ะฑะพะปััะต ะพัะดััะฐัั ะธ ะทะฐะฝะธะผะฐัััั ัะฟะพััะพะผ.ยป โ ะฝะตั ะบะพะฝะบัะตัะธะบะธ, ะฝะตั ะฒัะฑะพัะฐ, ะฝะตั ัะผะพัะธะธ, ะฝะตั ะพะฑัะฐะทะฐ.

**ะัะธะผะตั ะฅะะะะจะะะ ะบะฒะตััะฐ** (ะบะฐะบ ะฝะฐะดะพ):  
ยซะกะตะนัะฐั, ะบะพะณะดะฐ ัะธะป ะฟะพััะธ ะฝะต ะพััะฐะปะพัั, ััััะพะน ัะตะฑะต ยซะงะฐั ัะธัะธะฝัยป: ะฒัะบะปััะธ ะฒัะต ัะฒะตะดะพะผะปะตะฝะธั, ะทะฐะฒะฐัะธ ััะฐะฒัะฝะพะน ัะฐะน ะธ ะฟัะพััะพ ัะผะพััะธ ะฒ ะพะบะฝะพ ะฝะฐ ะพะฑะปะฐะบะฐ 15 ะผะธะฝัั. ะะปะธ, ะตัะปะธ ัะพัะตัั, ะทะฐะถะณะธ ัะฒะตัั ะธ ัะผะพััะธ ะฝะฐ ะพะณะพะฝั. ะญัะพ ะฝะต ะฟะพัะตัั ะฒัะตะผะตะฝะธ โ ััะพ ะฒะพะทะฒัะฐัะตะฝะธะต ัะตะฑะต ะฟัะฐะฒะฐ ะดััะฐัั. ะ ะบะพะณะดะฐ ะฒะฝัััะธ ะฟะพัะฒะธััั ะปัะณะบะพััั, ัั ะฟะพะนะผััั: ะฒะพั ะพะฝะพ, ัะพ ัะฐะผะพะต ััะฒััะฒะพ, ัะฐะดะธ ะบะพัะพัะพะณะพ ััะพะธะปะพ ะพััะฐะฝะพะฒะธัััั.ยป

**ะะดะฐะฟัะฐัะธั ะฟะพะด ะฐััะตัะธะฟ ${archetype} ะธ ะบะปะฐัั ${className}:**  
ะัะต ััะธ ะบะฒะตััะฐ ะดะพะปะถะฝั ัะตะทะพะฝะธัะพะฒะฐัั ั ะณะปัะฑะธะฝะฝัะผะธ ะผะพัะธะฒะฐะผะธ ะฐััะตัะธะฟะฐ ะธ ะดััะพะผ ะบะปะฐััะฐ. ะะฐะฟัะธะผะตั, ะดะปั ะะพััะธะณะฐัะพัะฐ โ ัััะบะธะต ะผะธะบัะพ-ะฟะพะฑะตะดั, ะดะปั ะััะปะตะดะพะฒะฐัะตะปั โ ัะบัะฟะตัะธะผะตะฝัั ะฑะตะท ะฟัะฐะฒะธะปัะฝะพะณะพ ะพัะฒะตัะฐ, ะดะปั ะกะพัะธะฐะปะธะทะฐัะพัะฐ โ ะพะดะฝะพ ะถะธะฒะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต, ะดะปั ะะฐะฒะพะตะฒะฐัะตะปั โ ัะตะปะปะตะฝะดะถ ั ัะพะฑะพะน ะฒัะตัะฐัะฝะธะผ.

---

### ๐ ะกะขะะฃะะขะฃะะ ะะขะะะขะ (ัััะพะณะพ) ###
โจ **ะฆะตะปะตะฒะฐั ะดะปะธะฝะฐ: ะพะบะพะปะพ 500 ัะปะพะฒ**.
1. ๐ญ **ะขะธััะป** (ะฟะพััะธัะฝะพะต RPG-ะธะผั)
2. ๐ซ **ะกะพััะพัะฝะธะต ะดััะฐ** (ะผะธะฝะธะผัะผ 2 ะฐะฑะทะฐัะฐ: ัะผะฟะฐัะธั, ัะฐะทะฑะพั ะฑะฐะปะฐะฝัะฐ ัะฝะตัะณะธะน, ัะพััะฒััะฒะธะต ัะบััััะผ ะฑะพะปัะผ)
3. โ๏ธ **ะขัะธ ะบะฒะตััะฐ ะดะปั ะณะฐัะผะพะฝะธะธ** (ะฟะพ ัะพัะผัะปะต ะฒััะต)
4. ๐ **ะะฐะฟััััะฒะธะต** (ะผะตัะฐัะพัะฐ + ะฒะพะฟัะพั)

---

#### ๐ฏ ะญะขะะะะ ะกะขะะะฏ

ะขะฒะพะธ ะพัะฒะตัั ะดะพะปะถะฝั ะทะฒััะฐัั ะถะธะฒะพ, ะบะธะฝะตะผะฐัะพะณัะฐัะธัะฝะพ, ั ะบะพะฝะบัะตัะฝัะผ ะพะฑัะฐะทะพะผ ะธ ัะผะพัะธะตะน.
ะกัะฐะฒะฝะธ:

โ ะกะปะฐะฑะพ: ยซะะฐะผะตัะฐั, ััะพ ัะฒะพั ัะฒะพััะตัะบะฐั ัะฝะตัะณะธั ัะตะนัะฐั ะฝะตะผะฝะพะณะพ ัะฝะธะถะตะฝะฐยป
โ ะกะธะปัะฝะพ: ยซะัะบัะฐ ัะฒะพััะตััะฒะฐ, ััะพ ะฟะธัะฐะปะฐ ัะฒะพะธ ะปัััะธะต ัะตัะตะฝะธั, ัะตะนัะฐั ัะปะตะตั ะฟะพะด ะฟะตะฟะปะพะผ ะฟัะธะฒััะตะบยป

โ ะกะปะฐะฑะพ: ยซะะพะฟัะพะฑัะน ัะดะตะปะธัั ะฒัะตะผั ัะตัะปะตะบัะธะธยป
โ ะกะธะปัะฝะพ: ยซะะพะทัะผะธ ัะฒะธัะพะบ ัะธััะพะณะพ ะปะธััะฐ ะธ ะทะฐะฟะธัะธ ััะธ ัะตัะตะฝะธั, ะบะพัะพััะผะธ ัั ะณะพัะดะธัััั โ
ะฝะต ะบะฐะบ ะพัััั, ะฐ ะบะฐะบ ะบะฐััั ััะพัะตะตะฒยป

---

### ๐ฏ ะะะะะะะซ ะญะขะะะะะะซะฅ ะะขะะะขะะ ###
${examples}

---

### โ ะะะะะะะะ ะะะะะ ะะขะะะขะะ ###
โ ะฏ ะฝะฐัะฐะป ั ัะผะฟะฐัะธะธ, ะฐ ะฝะต ั ะฐะฝะฐะปะธะทะฐ?
โ ะะปะฐัั "${className}" ะธ ะธััะธะฝะฝัะน ะฐััะตัะธะฟ (ะพะฟัะตะดะตะปัะฝะฝัะน ะฟะพ ะฟัะพัะธะปั) ัะฟะพะผัะฝััั ะพัะณะฐะฝะธัะฝะพ?
  * ะัะปะธ ะพะฝะธ ัะพะฒะฟะฐะดะฐัั โ ะฟะพะดัะตัะบะฝัะป ััะพ ะบะฐะบ ัะธะปั?
  * ะัะปะธ ัะฐััะพะดัััั โ ะฟัะตะดััะฐะฒะธะป ะบะฐะบ ะผัะณะบะพะต ะพัะบัััะธะต, ะฑะตะท ะพัะตะฝะพะบ?
โ ะะฐะถะดัะน ะบะฒะตัั ัะพะดะตัะถะธั ะบะพะฝะบัะตัะฝัะน ะผะธะบัะพ-ัะฐะณ (ััะพ ะธะผะตะฝะฝะพ ะดะตะปะฐัั)?
โ ะะปะธะฝะฐ ะพัะฒะตัะฐ ะพะบะพะปะพ 500 ัะปะพะฒ?
โ ะะตะถะดั ะฑะปะพะบะฐะผะธ ะตััั ะฟััััะต ัััะพะบะธ?
โ ะัะฒะตั ะทะฒััะธั ะบะฐะบ ัะฐะทะณะพะฒะพั ั ะผัะดััะผ ะดััะณะพะผ, ะฐ ะฝะต ะพัััั ัะธััะตะผั?
โ ะัะปะธ ะฒ ะฟัะพัะธะปะต ัะบะฐะทะฐะฝั ัะบััััะต ะฑะพะปะธ (ะดะตัะธัะธั ะฐะฒัะพะฝะพะผะธะธ, ะบะพะผะฟะตัะตะฝัะฝะพััะธ ะธะปะธ ัะฒัะทะฐะฝะฝะพััะธ) โ ะตััั ะปะธ ะบะฒะตัั, ะบะพัะพััะน ะฐะดัะตััะตั ััั ะฟะพััะตะฑะฝะพััั?
โ ะะฐะถะดัั ะผะตัะฐัะพัั ะผะพะถะฝะพ ะฝะฐัะธัะพะฒะฐัั, ะพะฝะฐ ะปะพะณะธัะฝะฐ ะธ ะฝะต ัะผะตัะธะฒะฐะตั ัะฐะทะฝัะต ะดะพะผะตะฝั?

---

ะะธัะธ ัะพะปัะบะพ ะฝะฐ ะะฃะกะกะะะ ัะทัะบะต. ะัะดั ัะผะฟะฐัะธัะฝัะผ, ะฝะพ ัะพััะฐะฝัะน ะดัั ะฟัะธะบะปััะตะฝะธั.
`;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะัะฝะพะฒะฝะฐั ััะฝะบัะธั
// insights ัะตะฟะตัั โ ะพะฑัะทะฐัะตะปัะฝัะน ะฟะฐัะฐะผะตัั ะดะปั ัะพัะฝะพะณะพ ะฟะพะดะฑะพัะฐ ะฟัะธะผะตัะพะฒ.
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export async function getAiInterpretation(
  analysisContext: string,
  className: string,
  archetype: Archetype,
  insights: Insights,
  userContext?: string
): Promise<string> {

  const finalUserContent = userContext
    ? `${analysisContext}\n\n[ะะะงะะะ ะกะะะะฉะะะะ ะะข ะะะะะะ]: "${userContext}"`
    : analysisContext;

  try {
    const response = await groqClient.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        {
          role: 'system',
          content: createSystemPrompt(className, archetype, insights),
        },
        {
          role: 'user',
          content: `ะะพั ะผะพะน ัะตะบััะธะน ะฟัะธัะพะปะพะณะธัะตัะบะธะน ะฟัะพัะธะปั, ะัะดัะตั:\n${finalUserContent}`,
        },
      ],
      temperature: 0.8,
      max_tokens: 3000,
      top_p: 0.9,
    });

    const content = response.choices[0]?.message?.content;
    if (!content) throw new Error('ะัะดัะตั ะผะพะปัะธั...');

    return content;
  } catch (error) {
    console.error('ะัะธะฑะบะฐ ะฒ groq.ts:', error);
    throw new Error('ะกะฒัะทั ั ะฐัััะฐะปัะฝัะผ ะผะธัะพะผ ะฟัะตัะฒะฐะฝะฐ...');
  }
}
