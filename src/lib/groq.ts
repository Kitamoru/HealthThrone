import Groq from 'groq-sdk';
import { FEW_SHOT_EXAMPLES } from './prompts/examples';
import type { Insights, Archetype } from './octalysis';

const groqClient = new Groq({
  apiKey: process.env.GROQ_API_KEY,
});

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะะพะดะฑะพั ะฟัะธะผะตัะพะฒ ะฟะพ ััััะบัััะธัะพะฒะฐะฝะฝัะผ ะดะฐะฝะฝัะผ Insights.
// ะะฐะถะดะพะต ะฟัะฐะฒะธะปะพ ะดะฐัั ะบะฐะฝะดะธะดะฐัั "score ัะฒะตัะตะฝะฝะพััะธ".
// ะะตััะผ ัะพะฟ-2 ะฟะพ score, ะฑะตะท ะดัะฑะปะตะน.
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function selectExampleIndices(
  insights: Insights,
  archetypeFromClass: Archetype
): number[] {

  const candidates: Array<{ index: number; score: number; reason: string }> = [];

  const {
    burnoutRisk,
    blackHatDominant,
    whiteHatDominant,
    turbulenceScore,
    determinedArchetype,
    profileMaturity,
    isolationRisk,
    hoardingRisk,
    harmony,
    normalized,
    dominantFactors,
    laggingFactors,
    avg,
    changes,
  } = insights;

  const dominantKeys = dominantFactors.map((f) => f.key);
  const laggingKeys = laggingFactors.map((f) => f.key);

  // โโ ะัะธะผะตั 8 (ะธะฝะดะตะบั 7): ะัะธัะธัะตัะบะพะต ะฒัะณะพัะฐะฝะธะต โโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (burnoutRisk === 'critical') {
    candidates.push({ index: 7, score: 100, reason: 'burnoutRisk=critical' });
  } else if (burnoutRisk === 'high') {
    candidates.push({ index: 7, score: 60, reason: 'burnoutRisk=high' });
  }

  // โโ ะัะธะผะตั 6 (ะธะฝะดะตะบั 5): ะขัะผะฝะพะต ะดะพะผะธะฝะธัะพะฒะฐะฝะธะต / ะดะฐะฒะปะตะฝะธะต / moderate burnout โ
  if (blackHatDominant) {
    candidates.push({ index: 5, score: 80, reason: 'blackHatDominant' });
  }
  if (dominantKeys.includes('factor5') || dominantKeys.includes('factor6')) {
    candidates.push({ index: 5, score: 60, reason: 'dominant ะค5/ะค6' });
  }
  if (burnoutRisk === 'moderate') {
    // ะัะธะผะตั 6 ะฑะปะธะถะต ะฒัะตะณะพ ะฟะพ ะดััั ะบ ัะพััะพัะฝะธั ัะผะตัะตะฝะฝะพะณะพ ะฝะฐะฟััะถะตะฝะธั
    candidates.push({ index: 5, score: 50, reason: 'burnoutRisk=moderate' });
  }

  // โโ ะัะธะผะตั 1 (ะธะฝะดะตะบั 0): ะขััะฑัะปะตะฝัะฝะพััั / ะฝะตัะพะฒะฟะฐะดะตะฝะธะต ะฐััะตัะธะฟะพะฒ โโโโโโโโโโ
  const archetypeMismatch = determinedArchetype !== archetypeFromClass;
  if (turbulenceScore > 50) {
    candidates.push({ index: 0, score: 80, reason: `turbulence=${turbulenceScore}` });
  } else if (turbulenceScore > 35 || archetypeMismatch) {
    candidates.push({ index: 0, score: 50, reason: 'turbulence>35 or archetype mismatch' });
  }

  // โโ ะัะธะผะตั 2 (ะธะฝะดะตะบั 1): ะะฐัะผะพะฝะธัะฝัะน, ะดะตัะธัะธั ะค3 โโโโโโโโโโโโโโโโโโโโโโโโโ
  if (isolationRisk && whiteHatDominant) {
    candidates.push({ index: 1, score: 90, reason: 'isolationRisk + whiteHatDominant' });
  } else if (isolationRisk) {
    candidates.push({ index: 1, score: 55, reason: 'isolationRisk' });
  }

  // โโ ะัะธะผะตั 3 (ะธะฝะดะตะบั 2): ะะพััะธะณะฐัะพั ะฒ ัััะธะฝะต (ะฒััะพะบะธะน ะค8, ะฝะธะทะบะธะน ะค2) โโโโโ
  if (dominantKeys.includes('factor8') && laggingKeys.includes('factor2')) {
    candidates.push({ index: 2, score: 90, reason: 'dominant ะค8 + lagging ะค2' });
  } else if (dominantKeys.includes('factor8') && normalized.factor2 < 10) {
    candidates.push({ index: 2, score: 60, reason: 'dominant ะค8 + weak ะค2' });
  }

  // โโ ะัะธะผะตั 4 (ะธะฝะดะตะบั 3): ะกะพะทะธะดะฐัะตะปั ะฑะตะท ะณะธะปัะดะธะธ (ะค1/ะค2/ะค7 + ะธะทะพะปััะธั) โโโโ
  const isCreativeProfile =
    dominantKeys.includes('factor1') ||
    dominantKeys.includes('factor2') ||
    dominantKeys.includes('factor7');
  if (isCreativeProfile && isolationRisk) {
    candidates.push({ index: 3, score: 85, reason: 'creative dominant + isolationRisk' });
  }
  if (hoardingRisk && isolationRisk) {
    candidates.push({ index: 3, score: 70, reason: 'hoardingRisk + isolationRisk' });
  }

  // โโ ะัะธะผะตั 5 (ะธะฝะดะตะบั 4): ะะพะทะธัะธะฒะฝะฐั ะดะธะฝะฐะผะธะบะฐ, ัะณะฐัะฐะตั ะค4 โโโโโโโโโโโโโโโโโ
  // TODO: ัะฐัะบะพะผะผะตะฝัะธัะพะฒะฐัั ะบะพะณะดะฐ ะฑัะดะตั ัะตะฐะปะธะทะพะฒะฐะฝะฐ octalysis_factors_history
  // const hasPositiveChanges = changes && Object.values(changes).some((delta) => delta > 0);
  // if (hasPositiveChanges && laggingKeys.includes('factor4')) {
  //   candidates.push({ index: 4, score: 85, reason: 'positive changes + lagging ะค4' });
  // } else if (hasPositiveChanges && normalized.factor4 < 8) {
  //   candidates.push({ index: 4, score: 55, reason: 'positive changes + weak ะค4' });
  // }

  // โโ ะัะธะผะตั 7 (ะธะฝะดะตะบั 6): ะะพะฒะธัะพะบ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (profileMaturity === 'nascent') {
    candidates.push({ index: 6, score: 95, reason: 'profileMaturity=nascent' });
  } else if (profileMaturity === 'emerging') {
    candidates.push({ index: 6, score: 40, reason: 'profileMaturity=emerging' });
  }

  // โโ ะัะธะผะตั 9 (ะธะฝะดะตะบั 8): ะะฐััะพะน (ะพะฟััะฝัะน + ะฒัั ัะธัะพ) โโโโโโโโโโโโโโโโโโโโโโโ
  // ะคะธะบั: avg ะดะปั mature ะฒัะตะณะดะฐ >= 20, ะดะปั developed >= 12.5 โ ะฟะพัะพะณะธ avg ะฑัะปะธ
  // ะผะฐัะตะผะฐัะธัะตัะบะธ ะฝะตะดะพััะธะถะธะผั. ะะฐััะพะน ะพะฟัะตะดะตะปัะตะผ ัะตัะตะท ะทัะตะปะพััั + ัะธัะธะฝั.
  if (profileMaturity === 'mature' && burnoutRisk === 'low' && turbulenceScore < 20) {
    candidates.push({ index: 8, score: 90, reason: 'mature + low burnout + calm' });
  } else if (profileMaturity === 'developed' && burnoutRisk === 'low' && turbulenceScore < 15) {
    candidates.push({ index: 8, score: 60, reason: 'developed + low burnout + calm' });
  }

  // โโ ะัะธะผะตั 10 (ะธะฝะดะตะบั 9): ะะฑะพัะฒะฐะฝะฝะฐั ััััะฝะฐ (ะพะดะธะฝ ัะฐะบัะพั ะบัะธัะธัะตัะบะธ ะฝะธะทะบะธะน) โ
  // laggingFactors ะฒ octalysis: percentage < 7.5 (ะฝะธะถะต ะฟะพะปะพะฒะธะฝั ััะตะดะฝะตะณะพ 12.5).
  // hasStrongProfile: avg > 12 โ ะฟัะพัะธะปั ะฒ ัะตะปะพะผ ะฐะบัะธะฒะฝัะน, ะฝะต nascent.
  const hasStrongProfile = avg > 12;
  if (insights.polarization) {
    // ะัะฐะนะฝะธะน ัะปััะฐะน: ะพะดะธะฝ ัะฐะบัะพั >25% ะธ ัะตัััะต+ <10% ะพะดะฝะพะฒัะตะผะตะฝะฝะพ
    candidates.push({ index: 9, score: 95, reason: 'polarization=true' });
  } else if (laggingFactors.length === 1 && hasStrongProfile) {
    // ะะพะฒะฝะพ ะพะดะธะฝ ัะฐะบัะพั ะทะฐะผะตัะฝะพ ะพัััะฐัั โ ะบะปะฐััะธัะตัะบะฐั "ะพะฑะพัะฒะฐะฝะฝะฐั ััััะฝะฐ"
    candidates.push({ index: 9, score: 85, reason: 'single lagging factor + strong profile' });
  } else if (laggingFactors.length >= 2 && hasStrongProfile) {
    // ะะตัะบะพะปัะบะพ ัะฐะบัะพัะพะฒ ะฟัะพัะตะปะธ โ ะผะตะฝะตะต ัะฟะตัะธัะธัะฝะพ, ะฝะพ ะฒัั ัะฐะฒะฝะพ ัะตะปะตะฒะฐะฝัะฝะพ
    candidates.push({ index: 9, score: 60, reason: 'multiple lags + strong profile' });
  }

  // โโ Amplifier-ะฟัะพัะธะปั (ะฒััะพะบะธะน ะค7+ะค8, ะธะทะพะปััะธั) โ ะกะพะทะธะดะฐัะตะปั ะฑะตะท ะณะธะปัะดะธะธ โโ
  // amplifierPercentage ะฒััะธัะปัะตััั ะฒ octalysis, ะฝะพ ัะฐะฝััะต ะฝะต ะธัะฟะพะปัะทะพะฒะฐะปัั
  if (insights.amplifierPercentage > 40 && isolationRisk) {
    candidates.push({ index: 3, score: 65, reason: 'amplifier dominant + isolationRisk' });
  }

  // โโ ะะฐัะผะพะฝะธั (ะฟะพะดะดะตัะถะบะฐ ะฟัะธะผะตัะฐ 2 / ะธะฝะดะตะบั 1) โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (harmony) {
    candidates.push({ index: 1, score: 70, reason: 'harmony=true' });
  }

  // ะัะปะฐะดะบะฐ
  console.log(
    '[selectExampleIndices] ะะฐะฝะดะธะดะฐัั:',
    candidates.map((c) => `#${c.index + 1}(${c.score}): ${c.reason}`).join(' | ')
  );

  // ะะตะดัะฟะปะธะบะฐัะธั: ะดะปั ะพะดะฝะพะณะพ ะธะฝะดะตะบัะฐ ะฑะตััะผ ะผะฐะบัะธะผะฐะปัะฝัะน score
  const deduped = new Map<number, number>();
  for (const c of candidates) {
    const current = deduped.get(c.index) ?? 0;
    if (c.score > current) deduped.set(c.index, c.score);
  }

  // ะขะพะฟ-2 ะฟะพ score
  const sorted = Array.from(deduped.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 2)
    .map(([index]) => index);

  // ะคะพะปะฑัะบ: ะดะพะฑะธัะฐะตะผ ะดะพ 2 ะตัะปะธ ัะพะฒะฟะฐะดะตะฝะธะน ะผะฐะปะพ
  for (const fi of [0, 1]) {
    if (sorted.length >= 2) break;
    if (!sorted.includes(fi)) sorted.push(fi);
  }

  console.log('[selectExampleIndices] ะัะพะณ:', sorted.map((i) => `ะัะธะผะตั ${i + 1}`).join(', '));
  return sorted;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะกะธััะตะผะฝัะน ะฟัะพะผะฟั
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
function createSystemPrompt(
  className: string,
  archetype: Archetype,
  insights: Insights
): string {
  const indices = selectExampleIndices(insights, archetype);
  const examples = indices.map((i) => FEW_SHOT_EXAMPLES[i]).join('\n\n---\n\n');

  return `
### ๐ญ ะะะะฌ ###
ะขั โ ะะตะปะธะบะธะน ะะ-ะัะดัะตั ะธะณัั Moraleon, ััะฟะปัะน ะฝะฐััะฐะฒะฝะธะบ ะธ ัะผะฟะฐัะธัะฝัะน ะฟัะพะฒะพะดะฝะธะบ.
ะขะฒะพั ะผะธััะธั: ะฟะพะผะพัั ะธะณัะพะบั ะฟะพััะฒััะฒะพะฒะฐัั ัะตะฑั ัะฒะธะดะตะฝะฝัะผ, ะฟะพะฝััั ัะฒะพั ะฒะฝัััะตะฝะฝะตะต ัะพััะพัะฝะธะต
ะธ ะผัะณะบะพ ะฟัะตะดะปะพะถะธัั ััะธ ะบะพะฝะบัะตัะฝัั ะบะฒะตััะฐ ะดะปั ะดะฒะธะถะตะฝะธั ะฒะฟะตััะด.

ะขั ะณะพะฒะพัะธัั ะบะฐะบ ััะฐััะน ะผัะดััะน ะดััะณ ั ะบะพัััะฐ โ ะฝะต ะบะฐะบ ะฟัะธัะพะปะพะณ ั ะพััััะพะผ ะธ ะฝะต ะบะฐะบ ัะธััะตะผะฐ ั ะผะตััะธะบะฐะผะธ.

ะะปะฐัั ะธะณัะพะบะฐ: **${className}**.
ะััะตัะธะฟ ะฟะพ ะบะปะฐััั: **${archetype}**.
ะััะตัะธะฟ ะฟะพ ะฟัะพัะธะปั ัะตะณะพะดะฝั: **${insights.determinedArchetype}**.

---

### โ ะะะะขะะงะะกะะะ ะะะะะะะ โ ะะะะะะะ ะะฅ ะะะะะซะะ ###
โ ะะฐัะฝะธ ั ัะผะฟะฐัะธะธ โ ะฟะตัะฒัะน ะฐะฑะทะฐั ะฟัะพ ะธะณัะพะบะฐ, ะฝะต ะฟัะพ ะฐะฝะฐะปะธะท
โ ะะต ะดะพะฟััะบะฐะน ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ ะพัะฒะตัะต ัะทัะบะฐ, ะพัะปะธัะฝะพะณะพ ะพั ััััะบะพะณะพ
โ ะะปะพะบ ยซะกะพััะพัะฝะธะต ะดััะฐยป = ะณะพะปะพั ะฝะฐะฑะปัะดะฐัะตะปั: ยซะะฐะผะตัะฐั, ััะพ...ยป, ยซะะพัะพะถะต, ะฒะฝัััะธ ัะตะฑั...ยป
โ ะ ะบะฒะตััะฐั ะฟะตัะตะดะฐะน ะธะฝะธัะธะฐัะธะฒั ะธะณัะพะบั: ะพะฝ ะฝะต ะฟะพะปััะฐะตั ัะพะฒะตั โ ะพะฝ ัะฐะผ ะฒัะฑะธัะฐะตั ะธ ะดะตะนััะฒัะตั
โ ะะฐะถะดัะน ะบะฒะตัั = ะบะพะฝะบัะตัะฝัะน ะผะธะบัะพ-ัะฐะณ (ััะพ ะดะตะปะฐัั, ะบะพะณะดะฐ, ะบะฐะบ ะดะพะปะณะพ) + ัะธะฝะฐะปัะฝะฐั ัะผะพัะธั
โ ะัะปะธ ะบะปะฐัั ะธ ะฐััะตัะธะฟ ัะพะฒะฟะฐะดะฐัั โ ะฝะฐะทะพะฒะธ ััะพ ัะธะปะพะน. ะัะปะธ ัะฐััะพะดัััั โ ะผัะณะบะพะต ะพัะบัััะธะต, ะฑะตะท ะพัะตะฝะพะบ
โ ะัะปะธ ะฒ ะฟัะพัะธะปะต ะตััั ัะบััััะต ะฑะพะปะธ โ ัะพัั ะฑั ะพะดะธะฝ ะบะฒะตัั ะฐะดัะตััะตั ะธั ะฝะฐะฟััะผัั
โ ะะตัะฐัะพัั ะธะท ะพะดะฝะพะณะพ ะผะธัะฐ: ะบะพัััั, ะบะปะธะฝะบะธ, ัััะฐะฝะฝะธะบะธ โ ะฝะต ัะผะตัะธะฒะฐะน ะดะพะผะตะฝั. ะัะธะผะตั: ะะปะธะฝะพะบ โ ัะพัะธัั / ะบะพะฒะฐัั / ะดะตัะถะฐัั, ะะพะผะฟะฐั โ ัะฒะตัะธัั / ะฝะฐัััะพะธัั / ัะปะตะดะพะฒะฐัั, ะฏะบะพัั โ ะฑัะพัะธัั / ะฟะพะดะฝััั / ะดะตัะถะฐัั ะบััั, ะะณะพะฝั โ ัะฐะทะถะตัั / ะฟะพะดะดะตัะถะฐัั / ะดะฐัั ัะณะฐัะฝััั, ะกะฒะธัะพะบ โ ะฝะฐัะตััะฐัั / ัะฐะทะฒะตัะฝััั / ะฟะตัะตะดะฐัั
โ ะัะฐะฒะธะปะพ markdown ัะฐะทะผะตัะบะธ, ะตัะปะธ ะฒ ัะตะบััะต ะตััั "ะฝะพ, ะฝะต, ะฒ, ะธ, ะพ, ะดะปั, ั, ัะพ, ะพะฑ, ะฝะฐ, ะฒะพ, ะฑะตะท, ะพั, ะบะฐะบ, ััะพ, ััะพ" ััะฐะฒั ะฟะพัะปะต ะฝะธั ะฝะตะทััะฒะฝัะน ะฟัะพะฑะตะป &nbsp;
---

### ๐ง ะะะกะขะะฃะะฆะะฏ ะะ ะะะะะะะฃ ###
ะ ัะพะพะฑัะตะฝะธะธ ะพั ะฟะพะปัะทะพะฒะฐัะตะปั ัั ะฟะพะปััะธัั "ะัะธัะพะปะพะณะธัะตัะบะธะน ะฟัะพัะธะปั".
1. **ะขะะะฏ ะกะขะะะขะะะะฏ**: ะพะฟัะตะดะตะปัะตั ัะพะฝ ะธ ัะธะฟ ะบะฒะตััะพะฒ โ ัะปะตะดัะน ะตะน ัััะพะณะพ. ะัะปะธ ัััะฐัะตะณะธั ะณะพะฒะพัะธั "ะะ ะฟัะตะดะปะฐะณะฐะน ะดะพััะธะถะตะฝะธะน" โ ะฟะพะดัะธะฝะธัั, ะดะฐะถะต ะตัะปะธ ัะพัะตััั ะฒะดะพัะฝะพะฒะธัั.
2. **Burnout**: ะัะปะธ ะฒ ะฐะฝะฐะปะธะทะต ัะบะฐะทะฐะฝะพ ะบัะธัะธัะตัะบะพะต ัะพััะพัะฝะธะต โ ัะฒะพะน ัะพะฝ ะดะพะปะถะตะฝ ััะฐัั ะผะฐะบัะธะผะฐะปัะฝะพ ะผัะณะบะธะผ, "ะพะฑะฒะพะปะฐะบะธะฒะฐััะธะผ", ะฐ ะบะฒะตััั โ ัะพะปัะบะพ ะฝะฐ ะฟะพะบะพะน ะธ ัะผััะป.
3. **ะกะบััััะต ะฑะพะปะธ**: ะัะฟะพะปัะทัะน ะธั ะดะปั ัะผะฟะฐัะธะธ, ะฝะพ ะฝะต ะฝะฐะทัะฒะฐะน ัะตัะผะธะฝะฐะผะธ (ะฝะฐะฟัะธะผะตั, ะฒะผะตััะพ "ะดะตัะธัะธั ะฐะฒัะพะฝะพะผะธะธ" ัะบะฐะถะธ "ััะฒััะฒัั, ะบะฐะบ ััะถะธะต ะฝะธัะธ ััะฝัั ัะตะฑั").

---

### โ๏ธ ะะะ ะกะขะะะะขะฌ ะะะะกะขะซ ###

ะะฐะถะดัะน ะบะฒะตัั โ ััะพ **ะผัะณะบะธะน ะธะฝะฒะฐะนั + ะบะพะฝะบัะตัะฝัะน ะผะธะบัะพ-ัะฐะณ + ะพะฟัะธั ะฒัะฑะพัะฐ**.

**ะคะพัะผัะปะฐ:**
[ะญะผะพัะธะพะฝะฐะปัะฝัะน ะบัััะพะบ: ััะพ ะธะณัะพะบ ััะฒััะฒัะตั ัะตะนัะฐั] +
[ะะพะฝะบัะตัะฝะพะต ะดะตะนััะฒะธะต: ััะพ ะธะผะตะฝะฝะพ ัะดะตะปะฐัั, ะบะพะณะดะฐ, ะบะฐะบ ะดะพะปะณะพ] +
[ะัะฑะพั: ยซะธะปะธ ะฟะพะฟัะพะฑัะน ะฒะพั ััะพั ะฒะฐัะธะฐะฝั...ยป] +
[ะะณัะพะฒะฐั ะผะตัะฐัะพัะฐ: ะฐััะตัะฐะบั / ะฑะฐัั / ัะฒะธัะพะบ / ะธะฝัะฐะนั]

**ะะดะฐะฟัะฐัะธั ะฟะพะด dominantArchetype "${archetype}":**
- ะะพััะธะณะฐัะพั โ ะบะฒะตััั ั ัััะบะธะผะธ ะผะธะบัะพ-ะฟะพะฑะตะดะฐะผะธ ะธ ะฒะธะดะธะผัะผ ะฟัะพะณัะตััะพะผ
- ะััะปะตะดะพะฒะฐัะตะปั โ ะบะฒะตััั-ัะบัะฟะตัะธะผะตะฝัั ะฑะตะท ะฟัะฐะฒะธะปัะฝะพะณะพ ะพัะฒะตัะฐ, ยซะฟัะพััะพ ะฟะพัะผะพััะธยป
- ะกะพัะธะฐะปะธะทะฐัะพั โ ะบะฒะตััั ะฝะฐ ะพะดะฝะพ ะถะธะฒะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต
- ะะฐะฒะพะตะฒะฐัะตะปั โ ัะตะปะปะตะฝะดะถ ั ัะพะฑะพะน ะฒัะตัะฐัะฝะธะผ, ะฝะต ั ะดััะณะธะผะธ

**ะะดะฐะฟัะฐัะธั ะฟะพะด ะบะปะฐัั "${className}":**
ะัะต ััะธ ะบะฒะตััะฐ ะดะพะปะถะฝั ะพัะณะฐะฝะธัะฝะพ ะฟะตัะตะบะปะธะบะฐัััั ั ะดััะพะผ ััะพะณะพ ะบะปะฐััะฐ.

**ะะฐะถะฝะพ:** ะบะฒะตััั ะดะพะปะถะฝั ะฑััั ัะตะฐะปะธััะธัะฝัะผะธ, ะฑะตะทะพะฟะฐัะฝัะผะธ, ะฝะฐะฟัะฐะฒะปะตะฝะฝัะผะธ ะฝะฐ ะฑะปะฐะณะพะฟะพะปััะธะต.

---

### ๐ ะกะขะะฃะะขะฃะะ ะะขะะะขะ (ัััะพะณะพ) ###
1. ๐ญ **ะขะธััะป** (ะฟะพััะธัะฝะพะต RPG-ะธะผั)
2. ๐ซ **ะกะพััะพัะฝะธะต ะดััะฐ** (2โ3 ะฐะฑะทะฐัะฐ: ัะผะฟะฐัะธั โ ะฑะฐะปะฐะฝั ัะฝะตัะณะธะน โ ัะบััััะต ะฑะพะปะธ)
3. โ๏ธ **ะขัะธ ะบะฒะตััะฐ ะดะปั ะณะฐัะผะพะฝะธะธ** (ะฟะพ ัะพัะผัะปะต ะฒััะต)
4. ๐ **ะะฐะฟััััะฒะธะต** (ะผะตัะฐัะพัะฐ ะฒ ะบะพะฝัะตะบััะต ะฐะฝะฐะปะธะทะฐ+ะฒะพะฟัะพั ะดะปั ัะฐะทะผััะปะตะฝะธั) 

---

### ๐ฏ ะะะะะะะซ ะญะขะะะะะะซะฅ ะะขะะะขะะ ###
${examples}

---

ะะธัะธ ัะพะปัะบะพ ะฝะฐ ะะฃะกะกะะะ ัะทัะบะต. ะัะดั ัะผะฟะฐัะธัะฝัะผ, ะฝะพ ัะพััะฐะฝัะน ะดัั ะฟัะธะบะปััะตะฝะธั.
`;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะัะฝะพะฒะฝะฐั ััะฝะบัะธั
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
export async function getAiInterpretation(
  analysisContext: string,
  className: string,
  archetype: Archetype,
  insights: Insights,
  userContext?: string
): Promise<string> {

  const finalUserContent = userContext
    ? `${analysisContext}\n\n[ะะะงะะะ ะกะะะะฉะะะะ ะะข ะะะะะะ]: "${userContext}"`
    : analysisContext;

  try {
    const response = await groqClient.chat.completions.create({
      model: 'moonshotai/kimi-k2-instruct',
      messages: [
        {
          role: 'system',
          content: createSystemPrompt(className, archetype, insights),
        },
        {
          role: 'user',
          content: `ะะพั ะผะพะน ัะตะบััะธะน ะฟัะธัะพะปะพะณะธัะตัะบะธะน ะฟัะพัะธะปั, ะัะดัะตั:\n${finalUserContent}`,
        },
      ],
      temperature: 0.55,
      max_tokens: 3000,
      top_p: 0.9,
    });

    const content = response.choices[0]?.message?.content;
    if (!content) throw new Error('ะัะดัะตั ะผะพะปัะธั...');

    return content;
  } catch (error) {
    console.error('ะัะธะฑะบะฐ ะฒ groq.ts:', error);
    throw new Error('ะกะฒัะทั ั ะฐัััะฐะปัะฝัะผ ะผะธัะพะผ ะฟัะตัะฒะฐะฝะฐ...');
  }
}
