import { OctalysisStats } from './qroq';

// โโโ ะขะธะฟั โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

export type Archetype = 'ะะพััะธะณะฐัะพั' | 'ะััะปะตะดะพะฒะฐัะตะปั' | 'ะกะพัะธะฐะปะธะทะฐัะพั' | 'ะะฐะฒะพะตะฒะฐัะตะปั';

export interface OctalysisInsights {
  /** ะะพะผะธะฝะธััััะธะต ัะฐะบัะพัั (ะฒััะต ััะตะดะฝะตะณะพ) โ ัะตะบััะพะฒัะต ะฝะฐะทะฒะฐะฝะธั */
  dominantFactors: string[];
  /** ะขะตะฝะตะฒัะต ัะฐะบัะพัั (ะฝะธะถะต ััะตะดะฝะตะณะพ) โ ัะตะบััะพะฒัะต ะฝะฐะทะฒะฐะฝะธั */
  shadowFactors: string[];
  /** ะััั ะปะธ ะฒะฝัััะตะฝะฝะธะน ััะพัะผ (ัะฐะทะฑัะพั maxโmin > 15) */
  hasTurbulence: boolean;
  /** ะะตะถะธะผ ะผะพัะธะฒะฐัะธะธ */
  hatBalance: 'black_hat_dominant' | 'white_hat_dominant' | 'balanced';
  /** ะััะตัะธะฟ, ะฒััะธัะปะตะฝะฝัะน ะธะท ัะธัั */
  computedArchetype: Archetype;
  /** ะกะพะฒะฟะฐะดะฐะตั ะปะธ ะฒััะธัะปะตะฝะฝัะน ะฐััะตัะธะฟ ั ะฟะตัะตะดะฐะฝะฝัะผ */
  archetypeMatches: boolean;
  /** ะะตะดะพะฟะพะปััะตะฝะฝัะต ะฑะฐะทะพะฒัะต ะฟะพััะตะฑะฝะพััะธ (SDT) */
  unmetNeeds: Array<'autonomy' | 'competence' | 'relatedness'>;
  /** ะกะฟะตัะธะฐะปัะฝัะต ัะธะณะฝะฐะปั ะดะปั ะบะฒะตััะพะฒ */
  signals: string[];
  /** ะะธะฝะฐะผะธะบะฐ ะฟะพ ััะฐะฒะฝะตะฝะธั ั ะฟัะพัะปัะผ ะทะฐะผะตัะพะผ */
  dynamics?: {
    improved: string[];  // ัะฐะบัะพัั, ะบะพัะพััะต ะฒััะพัะปะธ
    declined: string[];  // ัะฐะบัะพัั, ะบะพัะพััะต ัะฟะฐะปะธ
  };
}

// โโโ ะัะฟะพะผะพะณะฐัะตะปัะฝัะต ะดะฐะฝะฝัะต โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const FACTOR_LABELS: Record<keyof OctalysisStats, string> = {
  factor1: 'ะญะฟะธัะตัะบะฐั ะทะฝะฐัะธะผะพััั',
  factor2: 'ะขะฒะพััะตััะฒะพ ะธ ะพะฑัะฐัะฝะฐั ัะฒัะทั',
  factor3: 'ะกะพัะธะฐะปัะฝะพะต ะฒะปะธัะฝะธะต',
  factor4: 'ะะตะฟัะตะดัะบะฐะทัะตะผะพััั',
  factor5: 'ะะทะฑะตะณะฐะฝะธะต ะฟะพัะตัั',
  factor6: 'ะะตัะธัะธั ะธ ะฝะตัะตัะฟะตะฝะธะต',
  factor7: 'ะะฑะปะฐะดะฐะฝะธะต ะธ ะฒะปะฐะดะตะฝะธะต',
  factor8: 'ะะพััะธะถะตะฝะธั',
};

// โโโ ะัะฝะพะฒะฝะฐั ััะฝะบัะธั ัะฐััััะฐ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

export function computeInsights(
  stats: OctalysisStats,
  passedArchetype: string,
  previousStats?: OctalysisStats
): OctalysisInsights {
  const values = Object.values(stats) as number[];
  const keys = Object.keys(stats) as (keyof OctalysisStats)[];

  // ะกัะตะดะฝะตะต
  const avg = values.reduce((s, v) => s + v, 0) / values.length;
  const max = Math.max(...values);
  const min = Math.min(...values);

  // ะะพะผะธะฝะธััััะธะต / ัะตะฝะตะฒัะต
  const dominantFactors = keys
    .filter(k => stats[k] > avg)
    .map(k => FACTOR_LABELS[k]);

  const shadowFactors = keys
    .filter(k => stats[k] < avg)
    .map(k => FACTOR_LABELS[k]);

  // ะขััะฑัะปะตะฝัะฝะพััั
  const hasTurbulence = max - min > 15;

  // ะะฐะปะฐะฝั ัะปัะฟ
  const whiteHat = stats.factor1 + stats.factor2 + stats.factor3;
  const blackHat = stats.factor4 + stats.factor5 + stats.factor6;
  const hatThreshold = Math.max(whiteHat, blackHat) * 0.2;

  let hatBalance: OctalysisInsights['hatBalance'];
  if (blackHat > whiteHat + hatThreshold) hatBalance = 'black_hat_dominant';
  else if (whiteHat > blackHat + hatThreshold) hatBalance = 'white_hat_dominant';
  else hatBalance = 'balanced';

  // ะััะธัะปะตะฝะฝัะน ะฐััะตัะธะฟ
  const computedArchetype = resolveArchetype(stats, avg);
  const archetypeMatches =
    computedArchetype.toLowerCase() === passedArchetype.toLowerCase();

  // SDT โ ะฝะตะดะพะฟะพะปััะตะฝะฝัะต ะฟะพััะตะฑะฝะพััะธ
  const unmetNeeds: OctalysisInsights['unmetNeeds'] = [];
  if (stats.factor1 < avg && stats.factor2 < avg) unmetNeeds.push('autonomy');
  if (stats.factor8 < avg && stats.factor2 < avg) unmetNeeds.push('competence');
  if (stats.factor3 < avg) unmetNeeds.push('relatedness');

  // ะกะฟะตัะธะฐะปัะฝัะต ัะธะณะฝะฐะปั
  const signals: string[] = [];

  if (stats.factor3 < avg * 0.7) {
    signals.push('isolation_risk'); // ะค3 ะพัััะฐัั >30% โ ัะธัะบ ะธะทะพะปััะธะธ
  }
  if (stats.factor7 > avg * 1.4) {
    signals.push('hoarding_risk'); // ะค7 >40% ะฒััะต ััะตะดะฝะตะณะพ โ ัะธัะบ ะฝะฐะบะพะฟะธัะตะปัััะฒะฐ
  }
  if (values.every(v => Math.abs(v - avg) <= 2)) {
    signals.push('harmony'); // ะัะต ัะฐะบัะพัั ะฒ ะฟัะตะดะตะปะฐั ยฑ2 โ ะณะฐัะผะพะฝะธั
  }
  const spikedFactor = keys.find(k => stats[k] > 25 && values.filter(v => v > 15).length <= 2);
  if (spikedFactor) {
    signals.push(`one_sided:${FACTOR_LABELS[spikedFactor]}`); // ะะดะฝะพะฑะพะบะพััั
  }

  // ะะธะฝะฐะผะธะบะฐ
  let dynamics: OctalysisInsights['dynamics'] | undefined;
  if (previousStats) {
    const improved = keys
      .filter(k => stats[k] > previousStats[k] + 2)
      .map(k => FACTOR_LABELS[k]);
    const declined = keys
      .filter(k => stats[k] < previousStats[k] - 2)
      .map(k => FACTOR_LABELS[k]);
    if (improved.length || declined.length) {
      dynamics = { improved, declined };
    }
  }

  return {
    dominantFactors,
    shadowFactors,
    hasTurbulence,
    hatBalance,
    computedArchetype,
    archetypeMatches,
    unmetNeeds,
    signals,
    dynamics,
  };
}

// โโโ ะะฟัะตะดะตะปะตะฝะธะต ะฐััะตัะธะฟะฐ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function resolveArchetype(stats: OctalysisStats, avg: number): Archetype {
  // ะะฐัะบะพะปัะบะพ ะบะฐะถะดัะน ัะฐะบัะพั ะฒัะดะตะปัะตััั ะฝะฐะด ััะตะดะฝะธะผ
  const deviation = (key: keyof OctalysisStats) => stats[key] - avg;

  const scores: Record<Archetype, number> = {
    ะะพััะธะณะฐัะพั: Math.max(deviation('factor8'), deviation('factor7')),
    ะััะปะตะดะพะฒะฐัะตะปั: Math.max(deviation('factor2'), deviation('factor4')),
    ะกะพัะธะฐะปะธะทะฐัะพั: Math.max(deviation('factor3'), deviation('factor1')),
    ะะฐะฒะพะตะฒะฐัะตะปั: Math.max(deviation('factor5'), deviation('factor6')),
  };

  return (Object.entries(scores) as [Archetype, number][]).reduce((a, b) =>
    b[1] > a[1] ? b : a
  )[0];
}

// โโโ ะกะตัะธะฐะปะธะทะฐัะธั ะธะฝัะฐะนัะพะฒ ะฒ ัะธัะฐะตะผัะน ัะตะบัั ะดะปั ะฟัะพะผัะฐ โโโโโโโโโโโโโโโโโโโโโโโ
// ะัะธะฝัะธะฟ: ะบะฐะถะดัะน ัะฐะบั ะฝะตััั ะฟะพะฒะตะดะตะฝัะตัะบัั ะดะธัะตะบัะธะฒั โ ััะพ ะฐะณะตะฝัั ะดะตะปะฐัั ั ะฝะธะผ.
// ะะณะตะฝั ะฝะต ะดะพะปะถะตะฝ ะดะพะณะฐะดัะฒะฐัััั ะพ ัะผััะปะต ะดะฐะฝะฝัั ะธะท ะบะพะฝัะตะบััะฐ ะฟัะพะผัะฐ.

export function insightsToPromptText(
  insights: OctalysisInsights,
  passedArchetype: string
): string {
  const lines: string[] = ['=== ะะะะะะะะะขะะะฌะะซะ ะะะะะะ (ะฒัะต ัะฐััััั ะฒัะฟะพะปะฝะตะฝั, ะดะพะฒะตััะน ะธะผ) ===\n'];

  // โโ ะะพะผะธะฝะธััััะธะต ัะฐะบัะพัั โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (insights.dominantFactors.length) {
    lines.push(
      `๐ ะกะะะฌะะซะ ะกะขะะะะะซ (ัะฐะบัะพัั ะฒััะต ััะตะดะฝะตะณะพ): ${insights.dominantFactors.join(', ')}\n` +
      `   โ ะ "ะกะพััะพัะฝะธะธ ะดััะฐ" ะธะผะตะฝะฝะพ ะพะฝะธ ัะพะทะดะฐัั ะพะฑัะฐะท ัะตะบััะตะน ะผะพัะธะฒะฐัะธะธ ะธะณัะพะบะฐ.\n` +
      `   โ ะ ะบะฒะตััะฐั ะพะฟะธัะฐะนัั ะฝะฐ ะฝะธั ะบะฐะบ ะฝะฐ ัะตัััั, ะฐ ะฝะต ะบะฐะบ ะฝะฐ ะฟัะพะฑะปะตะผั.`
    );
  }

  // โโ ะขะตะฝะตะฒัะต ัะฐะบัะพัั โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (insights.shadowFactors.length) {
    lines.push(
      `๐ ะขะะะะะซะ ะะะะซ (ัะฐะบัะพัั ะฝะธะถะต ััะตะดะฝะตะณะพ): ${insights.shadowFactors.join(', ')}\n` +
      `   โ ะะต ะฝะฐะทัะฒะฐะน ะธั ยซัะปะฐะฑะพัััะผะธยป ะธะปะธ ยซะฟัะพะฑะปะตะผะฐะผะธยป.\n` +
      `   โ ะะพะฒะพัะธ ะพะฑัะฐะทะฝะพ: ยซััะฐ ัะฐััั ัะตะฑั ัะตะนัะฐั ะผะพะปัะธัยป, ยซะพะณะพะฝั ะทะดะตัั ัััั ะฟัะธัะธัยป.\n` +
      `   โ ะะดะธะฝ ะธะท ะบะฒะตััะพะฒ ะดะพะปะถะตะฝ ะผัะณะบะพ ะฟัะธะณะปะฐัะฐัั ะฒ ะพะดะฝั ะธะท ัะตะฝะตะฒัั ะทะพะฝ.`
    );
  }

  // โโ ะขััะฑัะปะตะฝัะฝะพััั โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (insights.hasTurbulence) {
    lines.push(
      `โก ะขะฃะะะฃะะะะขะะะกะขะฌ: ะะซะกะะะะฏ (ัะฐะทะฑัะพั ะผะตะถะดั ะฟะพะปััะฐะผะธ ะพัะตะฝั ะฑะพะปััะพะน)\n` +
      `   โ ะ "ะกะพััะพัะฝะธะธ ะดััะฐ" ะพะฑัะทะฐัะตะปัะฝะพ ะฝะฐะทะพะฒะธ ััะพ ะพะฑัะฐะทะฝะพ:\n` +
      `      ยซะฒะฝัััะธ ัะตะฑั ััะพัะผยป, ยซะดะฒะฐ ัะตัะตะฝะธั ััะฝัั ะฒ ัะฐะทะฝัะต ััะพัะพะฝัยป, ยซะดััะฐ ะฒ ัะฐะทะปะฐะดะตยป.\n` +
      `   โ ะะฒะตััั ะดะพะปะถะฝั ัะณะปะฐะถะธะฒะฐัั ะบัะฐะนะฝะพััะธ โ ะฝะต ะฟะพะดัะฐะปะบะธะฒะฐัั ะบ ะฟะธะบั, ะฐ ัะบัะตะฟะปััั ัะตัะตะดะธะฝั.`
    );
  } else {
    lines.push(
      `ใฐ๏ธ ะขะฃะะะฃะะะะขะะะกะขะฌ: ะฝะธะทะบะฐั (ะฟัะพัะธะปั ัะพะฒะฝัะน)\n` +
      `   โ ะกะพััะพัะฝะธะต ััะฐะฑะธะปัะฝะพะต. ะะต ะธัะธ ยซััะพัะผยป ัะฐะผ, ะณะดะต ะตะณะพ ะฝะตั.\n` +
      `   โ ะะฒะตััั ะผะพะณัั ะฑััั ะฝะฐะฟัะฐะฒะปะตะฝั ะฝะฐ ัะพะฝะบะธะน ัะพัั, ะฐ ะฝะต ะฝะฐ ััะฐะฑะธะปะธะทะฐัะธั.`
    );
  }

  // โโ ะะฐะปะฐะฝั ัะปัะฟ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  const hatInstructions: Record<OctalysisInsights['hatBalance'], string> = {
    black_hat_dominant:
      `๐ค ะะะะะ ะะะขะะะะฆะะ: ะงััะฝะฐั ัะปัะฟะฐ ะดะพะผะธะฝะธััะตั\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ะธะณัะพะบ ัะตะนัะฐั ะดะฒะธะถะตััั ะพั ัััะฐัะฐ, ััะพัะฝะพััะธ, ะดะฐะฒะปะตะฝะธั โ ะฐ ะฝะต ะพั ัะผััะปะฐ.\n` +
      `   โ ะ "ะกะพััะพัะฝะธะธ ะดััะฐ" ะพะฟะธัะธ ััะพ ะพะฑัะฐะทะฝะพ: ยซัั ัะตะนัะฐั ะฑะตะถะธัั, ะฐ ะฝะต ะธะดัััยป,\n` +
      `      ยซะดะฒะธะณะฐัะตะปั ัะฐะฑะพัะฐะตั ะฝะฐ ััะตะฒะพะณะต, ะฐ ะฝะต ะฝะฐ ะธะฝัะตัะตัะตยป.\n` +
      `   โ ะะฐะบ ะผะธะฝะธะผัะผ ะพะดะธะฝ ะบะฒะตัั ะดะพะปะถะตะฝ ะฒะพะทะฒัะฐัะฐัั ะฒะฝัััะตะฝะฝะธะน ัะผััะป ะธะปะธ ัะฐะดะพััั ะฟัะพัะตััะฐ.\n` +
      `   โ ะขะพะฝ: ะพัะพะฑะตะฝะฝะพ ััะฟะปัะน, ะฑะตะท ะฝะฐะถะธะผะฐ. ะะณัะพะบ ะธ ัะฐะบ ะฟะพะด ะดะฐะฒะปะตะฝะธะตะผ.`,

    white_hat_dominant:
      `๐ค ะะะะะ ะะะขะะะะฆะะ: ะะตะปะฐั ัะปัะฟะฐ ะดะพะผะธะฝะธััะตั\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ัััะพะนัะธะฒะฐั, ะฟะธัะฐััะฐั ะผะพัะธะฒะฐัะธั โ ัะผััะป, ัะฒะพััะตััะฒะพ, ัะฒัะทั.\n` +
      `   โ ะัะธะทะฝะฐะน ััั ััะฐะฑะธะปัะฝะพััั ะบะฐะบ ะฝะฐััะพัััั ัะธะปั.\n` +
      `   โ ะะพะทะผะพะถะตะฝ ะฝะตะดะพััะฐัะพะบ ะฐะทะฐััะฐ ะธะปะธ ะฒะฝะตัะฝะตะณะพ ะฒัะทะพะฒะฐ.\n` +
      `   โ ะะดะธะฝ ะบะฒะตัั ะผะพะถะตั ะดะพะฑะฐะฒะธัั ะปัะณะบะธะน ะฒัะทะพะฒ ะธะปะธ ัะปะตะผะตะฝั ะฝะตะพะถะธะดะฐะฝะฝะพััะธ โ ะฑะตะท ัััะตััะฐ.`,

    balanced:
      `โ๏ธ ะะะะะ ะะะขะะะะฆะะ: ะจะปัะฟั ะฒ ะฑะฐะปะฐะฝัะต\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ะผะพัะธะฒะฐัะธั ัะผะตัะฐะฝะฝะฐั, ะฝะตั ัะฒะฝะพะณะพ ะฟะตัะตะบะพัะฐ.\n` +
      `   โ ะัะธ ะบะพะฝะบัะตัะฝัะน ัะฐะบัะพั, ะบะพัะพััะน ัะธะปัะฝะตะต ะฒัะตะณะพ ะฒัะฑะธะฒะฐะตััั ะธะท ััะตะดะฝะตะณะพ โ ะพะฝ ะธ ะตััั ะบะปัั.\n` +
      `   โ ะะฒะตััั ัััะพะน ะฒะพะบััะณ ัะฐะผะพะณะพ ะทะฐะผะตัะฝะพะณะพ ะพัะบะปะพะฝะตะฝะธั, ะฐ ะฝะต ะพะฑัะตะณะพ ะฟะฐััะตัะฝะฐ.`,
  };
  lines.push(hatInstructions[insights.hatBalance]);

  // โโ ะััะตัะธะฟ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  const archetypeDescriptions: Record<string, string> = {
    ะะพััะธะณะฐัะพั: 'ะตะผั ะฒะฐะถะฝะพ ััะฒััะฒะพ ะฟัะพะณัะตััะฐ, ะผะฐััะตัััะฒะฐ, ะฒะธะดะธะผัั ัะตะทัะปััะฐัะพะฒ',
    ะััะปะตะดะพะฒะฐัะตะปั: 'ะตะผั ะฝัะถะฝะฐ ะฝะพะฒะธะทะฝะฐ, ัะบัะฟะตัะธะผะตะฝัั, ัะฒะพะฑะพะดะฐ ะฟัะพะฑะพะฒะฐัั ะฑะตะท ะฟัะฐะฒะธะปัะฝะพะณะพ ะพัะฒะตัะฐ',
    ะกะพัะธะฐะปะธะทะฐัะพั: 'ะตะผั ะฒะฐะถะฝะฐ ัะฒัะทั ั ะดััะณะธะผะธ, ะฟัะธะฝะฐะดะปะตะถะฝะพััั, ะพัััะตะฝะธะต ยซั ะฝะต ะพะดะธะฝยป',
    ะะฐะฒะพะตะฒะฐัะตะปั: 'ะตะผั ะฝัะถะตะฝ ะดัะฐะนะฒ, ะฒัะทะพะฒ, ัะฝััะธะต ะฝะฐะฟััะถะตะฝะธั ัะตัะตะท ะดะตะนััะฒะธะต',
  };

  const archetypeQuestHints: Record<string, string> = {
    ะะพััะธะณะฐัะพั: 'ะบะฒะตััั ั ัััะบะธะผะธ ะผะธะบัะพ-ะฟะพะฑะตะดะฐะผะธ ะธ ะฒะธะดะธะผัะผ ะฟัะพะณัะตััะพะผ',
    ะััะปะตะดะพะฒะฐัะตะปั: 'ะบะฒะตััั-ัะบัะฟะตัะธะผะตะฝัั ะฑะตะท ะฟัะฐะฒะธะปัะฝะพะณะพ ะพัะฒะตัะฐ (ยซะฟัะพััะพ ะฟะพัะผะพััะธ, ััะพ ะฒัะนะดะตัยป)',
    ะกะพัะธะฐะปะธะทะฐัะพั: 'ะบะฒะตััั ะฝะฐ ะพะดะฝะพ ะถะธะฒะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ั ัะตะฐะปัะฝัะผ ัะตะปะพะฒะตะบะพะผ',
    ะะฐะฒะพะตะฒะฐัะตะปั: 'ะบะฒะตััั โ ัะตะปะปะตะฝะดะถ ั ัะพะฑะพะน ะฒัะตัะฐัะฝะธะผ, ะฝะต ัะพัะตะฒะฝะพะฒะฐะฝะธะต ั ะดััะณะธะผะธ',
  };

  const archDesc = archetypeDescriptions[insights.computedArchetype] ?? '';
  const archQuest = archetypeQuestHints[insights.computedArchetype] ?? '';

  if (insights.archetypeMatches) {
    lines.push(
      `๐ญ ะะะฅะะขะะ: ${insights.computedArchetype} (ัะพะฒะฟะฐะดะฐะตั ั ะฟะตัะตะดะฐะฝะฝัะผ)\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ${archDesc}.\n` +
      `   โ ะฃะบัะตะฟะธ ััั ัะฒัะทั ะฒ ัะตะบััะต. ะฃะฟะพะผัะฝะธ ะฐััะตัะธะฟ ะพัะณะฐะฝะธัะฝะพ.\n` +
      `   โ ะะฒะตััั: ${archQuest}.`
    );
  } else {
    lines.push(
      `๐ญ ะะะฅะะขะะ: ะฒััะธัะปะตะฝ ะบะฐะบ ${insights.computedArchetype}, ะฝะพ ะฟะตัะตะดะฐะฝ "${passedArchetype}"\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ัะธััั ะณะพะฒะพััั ะพะฑ ะพะดะฝะพะผ, ะฐ ะทะฐัะฒะปะตะฝะฝัะน ะฟััั โ ะพ ะดััะณะพะผ.\n` +
      `   โ ะัะณะบะพ ะพะฑะพะทะฝะฐัั ััะพ ะฟัะพัะธะฒะพัะตัะธะต ะฒ "ะกะพััะพัะฝะธะธ ะดััะฐ":\n` +
      `      ยซะกะตะนัะฐั ัะฒะพั ัะฝะตัะณะธั ะฑะปะธะถะต ะบ ${insights.computedArchetype}, ัะพัั ัั ะธะดััั ะบะฐะบ ${passedArchetype}.\n` +
      `       ะะฝัะตัะตัะฝะพ, ััะพ ัะตะนัะฐั ะดะฐัั ะฑะพะปััะต ัะธะป?ยป\n` +
      `   โ ะะฒะตััั ัััะพะน ะฟะพะด ะฒััะธัะปะตะฝะฝัะน ะฐััะตัะธะฟ (${insights.computedArchetype}): ${archQuest}.`
    );
  }

  // โโ ะะฐะทะพะฒัะต ะฟะพััะตะฑะฝะพััะธ (SDT) โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  const needsInstructions: Record<string, string> = {
    autonomy:
      `ะะะขะะะะะะฏ (ะฝะตะทะฐะฒะธัะธะผะพััั, ะพัััะตะฝะธะต ะฒัะฑะพัะฐ) โ ะฟะพัะพะถะต, ัะตะนัะฐั ะพัะปะฐะฑะปะตะฝะฐ.\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ะธะณัะพะบ ะผะพะถะตั ััะฒััะฒะพะฒะฐัั, ััะพ ะถะธะฒัั ะฟะพ ััะถะพะผั ััะตะฝะฐัะธั ะธะปะธ ยซะฝะฐะดะพยป, ะฐ ะฝะต ยซัะพััยป.\n` +
      `   โ ะะดะธะฝ ะบะฒะตัั ะดะพะปะถะตะฝ ะฒะพะทะฒัะฐัะฐัั ะพัััะตะฝะธะต ัะพะฑััะฒะตะฝะฝะพะณะพ ะฒัะฑะพัะฐ.\n` +
      `   โ ะคะพัะผัะปะธััะน ะบะฐะบ ะฟัะธะณะปะฐัะตะฝะธะต: ยซะ ััะพ, ะตัะปะธ ัะตะณะพะดะฝั ัั ัะดะตะปะฐะตัั ะพะดะฝะพ ะดะตะปะพ ัะพะปัะบะพ ะฟะพัะพะผั, ััะพ ัะพัะตัั?ยป`,

    competence:
      `ะะะะะะขะะะขะะะกะขะฌ (ัะพัั, ะผะฐััะตัััะฒะพ) โ ะฟะพัะพะถะต, ัะตะนัะฐั ะพัะปะฐะฑะปะตะฝะฐ.\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ะธะณัะพะบ ะผะพะถะตั ะฝะต ััะฒััะฒะพะฒะฐัั ะฟัะพะณัะตััะฐ ะธะปะธ ะฝะต ะทะฐะผะตัะฐัั, ะบะฐะบ ะพะฝ ะฒััะพั.\n` +
      `   โ ะะดะธะฝ ะบะฒะตัั ะดะพะปะถะตะฝ ะฟะพะผะพัั ัะฒะธะดะตัั ะธ ะทะฐัะธะบัะธัะพะฒะฐัั ัะตะฐะปัะฝัะน ัะพัั.\n` +
      `   โ ะญัะพ ะฝะต ะฟะพััะฐะฝะพะฒะบะฐ ะฝะพะฒัั ัะตะปะตะน โ ััะพ ะฟัะธะทะฝะฐะฝะธะต ัะถะต ะฟัะพะนะดะตะฝะฝะพะณะพ ะฟััะธ.`,

    relatedness:
      `ะกะะฏะะะะะะกะขะฌ (ะฟัะธะฝะฐะดะปะตะถะฝะพััั, ยซั ะฝะต ะพะดะธะฝยป) โ ะฟะพัะพะถะต, ัะตะนัะฐั ะพัะปะฐะฑะปะตะฝะฐ.\n` +
      `   ะงัะพ ััะพ ะทะฝะฐัะธั: ะธะณัะพะบ ะผะพะถะตั ััะฒััะฒะพะฒะฐัั ัะตะฑั ะธะทะพะปะธัะพะฒะฐะฝะฝะพ, ะดะฐะถะต ะตัะปะธ ะพะบััะถัะฝ ะปัะดัะผะธ.\n` +
      `   โ ะะดะธะฝ ะบะฒะตัั ะดะพะปะถะตะฝ ะฑััั ะฝะฐะฟัะฐะฒะปะตะฝ ะฝะฐ ะพะดะฝะพ ะถะธะฒะพะต ะฒะทะฐะธะผะพะดะตะนััะฒะธะต.\n` +
      `   โ ะะต ยซััะพะดะธ ะฝะฐ ะผะตัะพะฟัะธััะธะตยป โ ะฐ ะบะพะฝะบัะตัะฝะพ: ะฝะฐะฟะธัะฐัั ะพะดะฝะพะผั ัะตะปะพะฒะตะบั, ะทะฐะดะฐัั ะฒะพะฟัะพั, ะฟะพะฑะปะฐะณะพะดะฐัะธัั.`,
  };

  if (insights.unmetNeeds.length) {
    lines.push(`๐ง ะะะะะะะะฃะงะะะะซะ ะะะะะะซะ ะะะขะะะะะะกะขะ:`);
    for (const need of insights.unmetNeeds) {
      lines.push(`   โข ${needsInstructions[need]}`);
    }
    lines.push(`   โ๏ธ ะะฐะบ ะผะธะฝะธะผัะผ ะพะดะธะฝ ะธะท ัััั ะบะฒะตััะพะฒ ะะะฏะะะ ะฐะดัะตัะพะฒะฐัั ะพะดะฝั ะธะท ััะธั ะฟะพััะตะฑะฝะพััะตะน.`);
  } else {
    lines.push(`๐ง ะะะะะะซะ ะะะขะะะะะะกะขะ: ะฒัะต ะฒ ะฝะพัะผะต. ะะฒะตััั ะผะพะถะฝะพ ะฝะฐะฟัะฐะฒะธัั ะฝะฐ ัะพัั, ะฐ ะฝะต ะฒะพัะฟะพะปะฝะตะฝะธะต.`);
  }

  // โโ ะกะฟะตัะธะฐะปัะฝัะต ัะธะณะฝะฐะปั โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  const activeSignals = insights.signals;
  if (activeSignals.length) {
    lines.push(`๐ ะกะะะฆะะะะฌะะซะ ะกะะะะะะซ:`);
    for (const signal of activeSignals) {
      if (signal === 'isolation_risk') {
        lines.push(
          `   โ๏ธ ะะะะะฏะฆะะฏ: ะกะพัะธะฐะปัะฝะพะต ะฒะปะธัะฝะธะต ัะธะปัะฝะพ ะฝะธะถะต ะพััะฐะปัะฝะพะณะพ ะฟัะพัะธะปั.\n` +
          `      โ ะะดะธะฝ ะบะฒะตัั: ยซะฝะฐะนะดะธ ะพะดะฝะพะณะพ ัะพัะทะฝะธะบะฐยป โ ะฝะต ะฐะฑัััะฐะบัะฝะพ, ะฐ ะบะพะฝะบัะตัะฝะพ (ะบะพะผั ะฝะฐะฟะธัะฐัั, ั ะบะตะผ ะฟะพะณะพะฒะพัะธัั).`
        );
      }
      if (signal === 'hoarding_risk') {
        lines.push(
          `   โ๏ธ ะะะะะะะขะะะฌะกะขะะ: ะะฑะปะฐะดะฐะฝะธะต ะธ ะฒะปะฐะดะตะฝะธะต ัะธะปัะฝะพ ะฒััะต ะพััะฐะปัะฝะพะณะพ ะฟัะพัะธะปั.\n` +
          `      โ ะะดะธะฝ ะบะฒะตัั: ยซะฟะพะดะตะปะธัั ัะตะฝะฝะพััััยป โ ะฟะตัะตะดะฐัั ะทะฝะฐะฝะธะต, ะฟะพะผะพัั, ะพัะดะฐัั ััะพ-ัะพ ะฝะตะผะฐัะตัะธะฐะปัะฝะพะต.`
        );
      }
      if (signal === 'harmony') {
        lines.push(
          `   โจ ะะะะะะะะฏ: ะัะต ัะฐะบัะพัั ะฟัะธะผะตัะฝะพ ะฝะฐ ะพะดะฝะพะผ ััะพะฒะฝะต.\n` +
          `      โ ะญัะพ ัะตะดะบะพะต ัะพััะพัะฝะธะต, ะฟัะธะทะฝะฐะน ะตะณะพ ะฒัะปัั.\n` +
          `      โ ะัะตะดะปะพะถะธ ะพะดะธะฝ ะผัะณะบะธะน ะผะธะบัะพ-ัะบัะฟะตัะธะผะตะฝั ะดะปั ัะพััะฐ ะปัะฑะพะณะพ ะธะท White Hat-ัะฐะบัะพัะพะฒ (ะกะผััะป, ะขะฒะพััะตััะฒะพ, ะกะฒัะทั).`
        );
      }
      if (signal.startsWith('one_sided:')) {
        const factor = signal.replace('one_sided:', '');
        lines.push(
          `   โ๏ธ ะะะะะะะะะกะขะฌ: ยซ${factor}ยป ัะตะทะบะพ ะฒัะดะตะปัะตััั ะฝะฐ ัะพะฝะต ะพััะฐะปัะฝัั.\n` +
          `      โ ะัะณะบะพ ะพะฑะพะทะฝะฐัั ัะธัะบ: ัะปะธัะบะพะผ ะผะฝะพะณะพ ะพะดะฝะพะณะพ โ ะธ ะดััะณะธะต ัะฐััะธ ะฝะฐัะธะฝะฐัั ะผะพะปัะฐัั.\n` +
          `      โ ะะดะธะฝ ะบะฒะตัั ะฝะฐะฟัะฐะฒะปะตะฝ ะฝะฐ ัะพ, ััะพะฑั ะฟะธัะฐัั ะดััะณะธะต ะณัะฐะฝะธ.`
        );
      }
    }
  }

  // โโ ะะธะฝะฐะผะธะบะฐ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  if (insights.dynamics) {
    lines.push(`๐ ะะะะะะะะ (ััะฐะฒะฝะตะฝะธะต ั ะฟัะพัะปัะผ ะทะฐะผะตัะพะผ):`);
    if (insights.dynamics.improved.length) {
      lines.push(
        `   โ ะััะพัะปะพ: ${insights.dynamics.improved.join(', ')}\n` +
        `      โ ะะฑัะทะฐัะตะปัะฝะพ ะพัะผะตัั ััะพั ัะพัั ะฒ ัะตะบััะต. ะะต ะบะฐะบ ะณะฐะปะพัะบั โ ะบะฐะบ ะฝะฐััะพัััั ะฟะพะฑะตะดั.\n` +
        `      โ ยซะกะผะพััะธ, ะบะฐะบ ะฒััะพัะปะฐ ัะฒะพั...ยป โ ััะพ ัะพะฟะปะธะฒะพ ะดะปั ะดะฒะธะถะตะฝะธั ะดะฐะปััะต.`
      );
    }
    if (insights.dynamics.declined.length) {
      lines.push(
        `   โ ะฃะฟะฐะปะพ: ${insights.dynamics.declined.join(', ')}\n` +
        `      โ ะฃะฟะพะผัะฝะธ ััะพ ะผัะณะบะพ, ะฑะตะท ััะตะฒะพะณะธ ะธ ะฑะตะท ััะปัะบะพะฒ.\n` +
        `      โ ยซะะฝะพะณะดะฐ ะพัะปะธะฒ ะธะดัั ะฟะตัะตะด ะฑะพะปััะธะผ ะฟัะธะปะธะฒะพะผยป โ ััะพั ัะพะฝ.`
      );
    }
  }

  lines.push('\n=== ะะะะะฆ ะะะะะะะ. ะขะตะฟะตัั ัะฒะพั ะทะฐะดะฐัะฐ โ ะธะฝัะตัะฟัะตัะฐัะธั ะธ ะบะฒะตััั. ===');
  lines.push('ะัะฟะพะปัะทัะน ััะพั ะฐะฝะฐะปะธะท ะบะฐะบ ะบะฐััั. ะะต ะฟะตัะตััะธััะฒะฐะน. ะะต ะฝะฐะทัะฒะฐะน ัะธัะปะฐ ะฒ ะพัะฒะตัะต.');
  return lines.join('\n');
}
