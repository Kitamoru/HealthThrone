import { OctalysisStats } from './groq'; // fix: –±—ã–ª–æ ./qroq

// ‚îÄ‚îÄ‚îÄ –¢–∏–ø—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export type Archetype = '–î–æ—Å—Ç–∏–≥–∞—Ç–æ—Ä' | '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å' | '–°–æ—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä' | '–ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å';

export interface OctalysisInsights {
  /** –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã (–≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ) ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è */
  dominantFactors: string[];
  /** –¢–µ–Ω–µ–≤—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã (–Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ) ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è */
  shadowFactors: string[];
  /** –ï—Å—Ç—å –ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —à—Ç–æ—Ä–º (—Ä–∞–∑–±—Ä–æ—Å max‚Äìmin > 15) */
  hasTurbulence: boolean;
  /** –†–µ–∂–∏–º –º–æ—Ç–∏–≤–∞—Ü–∏–∏ */
  hatBalance: 'black_hat_dominant' | 'white_hat_dominant' | 'balanced';
  /** –ê—Ä—Ö–µ—Ç–∏–ø, –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∏–∑ —Ü–∏—Ñ—Ä */
  computedArchetype: Archetype;
  /** –°–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∞—Ä—Ö–µ—Ç–∏–ø —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º */
  archetypeMatches: boolean;
  /** –ù–µ–¥–æ–ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ (SDT) */
  unmetNeeds: Array<'autonomy' | 'competence' | 'relatedness'>;
  /** –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –∫–≤–µ—Å—Ç–æ–≤ */
  signals: string[];
  /** –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª—ã–º –∑–∞–º–µ—Ä–æ–º */
  dynamics?: {
    improved: string[];
    declined: string[];
  };
}

// ‚îÄ‚îÄ‚îÄ –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const FACTOR_LABELS: Record<keyof OctalysisStats, string> = {
  factor1: '–≠–ø–∏—á–µ—Å–∫–∞—è –∑–Ω–∞—á–∏–º–æ—Å—Ç—å',
  factor2: '–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å',
  factor3: '–°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ',
  factor4: '–ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å',
  factor5: '–ò–∑–±–µ–≥–∞–Ω–∏–µ –ø–æ—Ç–µ—Ä—å',
  factor6: '–î–µ—Ñ–∏—Ü–∏—Ç –∏ –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ',
  factor7: '–û–±–ª–∞–¥–∞–Ω–∏–µ –∏ –≤–ª–∞–¥–µ–Ω–∏–µ',
  factor8: '–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è',
};

// ‚îÄ‚îÄ‚îÄ –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export function computeInsights(
  stats: OctalysisStats,
  passedArchetype: string,
  previousStats?: OctalysisStats
): OctalysisInsights {
  const values = Object.values(stats) as number[];
  const keys = Object.keys(stats) as (keyof OctalysisStats)[];

  const avg = values.reduce((s, v) => s + v, 0) / values.length;
  const max = Math.max(...values);
  const min = Math.min(...values);

  // –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ / —Ç–µ–Ω–µ–≤—ã–µ
  const dominantFactors = keys
    .filter(k => stats[k] > avg)
    .map(k => FACTOR_LABELS[k]);

  const shadowFactors = keys
    .filter(k => stats[k] < avg)
    .map(k => FACTOR_LABELS[k]);

  // –¢—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å
  // –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å: max‚Äìmin > 15 –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–∏–º –Ω–∞ —Ä–∞–Ω–Ω–∏—Ö –¥–Ω—è—Ö
  // (–∫–æ–≥–¥–∞ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–∞–ª—ã), –ø–æ—ç—Ç–æ–º—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å.
  // –°–∏–≥–Ω–∞–ª —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –û–ë–ê —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã: –∞–±—Å–æ–ª—é—Ç–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å > 15
  // –ò–õ–ò –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å (max/min) > 2.5x –ø—Ä–∏ avg > 5 (–∏–≥—Ä–∞ —É–∂–µ –∏–¥—ë—Ç).
  const hasTurbulence =
    (max - min > 15) ||
    (avg > 5 && min > 0 && max / min > 2.5);

  // –ë–∞–ª–∞–Ω—Å —à–ª—è–ø
  const whiteHat = stats.factor1 + stats.factor2 + stats.factor3;
  const blackHat  = stats.factor4 + stats.factor5 + stats.factor6;
  const hatThreshold = Math.max(whiteHat, blackHat) * 0.2;

  let hatBalance: OctalysisInsights['hatBalance'];
  if (blackHat > whiteHat + hatThreshold) hatBalance = 'black_hat_dominant';
  else if (whiteHat > blackHat + hatThreshold) hatBalance = 'white_hat_dominant';
  else hatBalance = 'balanced';

  // –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∞—Ä—Ö–µ—Ç–∏–ø
  const computedArchetype = resolveArchetype(stats, avg);
  const archetypeMatches =
    computedArchetype.toLowerCase() === passedArchetype.toLowerCase();

  // SDT ‚Äî –Ω–µ–¥–æ–ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏
  // –ü–æ—Ä–æ–≥ 0.80 √ó avg: –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º.
  // ¬´–ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ¬ª –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Äî –Ω—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–Ω–µ–≤–∞—è –∑–æ–Ω–∞.
  const sdt = avg * 0.80;
  const unmetNeeds: OctalysisInsights['unmetNeeds'] = [];
  if (stats.factor1 < sdt && stats.factor2 < sdt) unmetNeeds.push('autonomy');
  if (stats.factor8 < sdt && stats.factor2 < sdt) unmetNeeds.push('competence');
  if (stats.factor3 < sdt) unmetNeeds.push('relatedness');

  // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
  const signals: string[] = [];

  if (stats.factor3 < avg * 0.7) {
    signals.push('isolation_risk');
  }

  if (stats.factor7 > avg * 1.4) {
    signals.push('hoarding_risk');
  }

  if (values.every(v => Math.abs(v - avg) <= 2)) {
    signals.push('harmony');
  }

  // fix: –±—ã–ª –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø–æ—Ä–æ–≥ > 25, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–ª—è –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏.
  // –¢–µ–ø–µ—Ä—å: —Ñ–∞–∫—Ç–æ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è ¬´–ø–∏–∫–æ–≤—ã–º¬ª –µ—Å–ª–∏ –æ–Ω –≤ 1.5√ó –≤—ã—à–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ
  // –ò —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–∞–∫–∏–º –≤—ã–±—Ä–æ—Å–æ–º (—á—Ç–æ–±—ã –Ω–µ –ª–æ–∂–Ω–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
  // –Ω–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–∑–¥–Ω–µ–π –∏–≥—Ä—ã).
  const topValue = Math.max(...values);
  const isSpiked = topValue > avg * 1.5 && values.filter(v => v > avg * 1.3).length === 1;
  if (isSpiked) {
    const spikedKey = keys.find(k => stats[k] === topValue);
    if (spikedKey) signals.push(`one_sided:${FACTOR_LABELS[spikedKey]}`);
  }

  // –î–∏–Ω–∞–º–∏–∫–∞
  let dynamics: OctalysisInsights['dynamics'] | undefined;
  if (previousStats) {
    const improved = keys
      .filter(k => stats[k] > previousStats[k] + 2)
      .map(k => FACTOR_LABELS[k]);
    const declined = keys
      .filter(k => stats[k] < previousStats[k] - 2)
      .map(k => FACTOR_LABELS[k]);
    if (improved.length || declined.length) {
      dynamics = { improved, declined };
    }
  }

  return {
    dominantFactors,
    shadowFactors,
    hasTurbulence,
    hatBalance,
    computedArchetype,
    archetypeMatches,
    unmetNeeds,
    signals,
    dynamics,
  };
}

// ‚îÄ‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function resolveArchetype(stats: OctalysisStats, avg: number): Archetype {
  const deviation = (key: keyof OctalysisStats) => stats[key] - avg;

  const scores: Record<Archetype, number> = {
    –î–æ—Å—Ç–∏–≥–∞—Ç–æ—Ä:   Math.max(deviation('factor8'), deviation('factor7')),
    –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: Math.max(deviation('factor2'), deviation('factor4')),
    –°–æ—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä:  Math.max(deviation('factor3'), deviation('factor1')),
    –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å:   Math.max(deviation('factor5'), deviation('factor6')),
  };

  return (Object.entries(scores) as [Archetype, number][]).reduce((a, b) =>
    b[1] > a[1] ? b : a
  )[0];
}

// ‚îÄ‚îÄ‚îÄ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤ –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–º—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export function insightsToPromptText(
  insights: OctalysisInsights,
  passedArchetype: string
): string {
  const lines: string[] = ['=== –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó (–≤—Å–µ —Ä–∞—Å—á—ë—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –¥–æ–≤–µ—Ä—è–π –∏–º) ===\n'];

  if (insights.dominantFactors.length) {
    lines.push(
      `üìà –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´ (—Ñ–∞–∫—Ç–æ—Ä—ã –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ): ${insights.dominantFactors.join(', ')}\n` +
      `   ‚Üí –í "–°–æ—Å—Ç–æ—è–Ω–∏–∏ –¥—É—Ö–∞" –∏–º–µ–Ω–Ω–æ –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –æ–±—Ä–∞–∑ —Ç–µ–∫—É—â–µ–π –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞.\n` +
      `   ‚Üí –í –∫–≤–µ—Å—Ç–∞—Ö –æ–ø–∏—Ä–∞–π—Å—è –Ω–∞ –Ω–∏—Ö –∫–∞–∫ –Ω–∞ —Ä–µ—Å—É—Ä—Å, –∞ –Ω–µ –∫–∞–∫ –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É.`
    );
  }

  if (insights.shadowFactors.length) {
    lines.push(
      `üìâ –¢–ï–ù–ï–í–´–ï –ó–û–ù–´ (—Ñ–∞–∫—Ç–æ—Ä—ã –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ): ${insights.shadowFactors.join(', ')}\n` +
      `   ‚Üí –ù–µ –Ω–∞–∑—ã–≤–∞–π –∏—Ö ¬´—Å–ª–∞–±–æ—Å—Ç—è–º–∏¬ª –∏–ª–∏ ¬´–ø—Ä–æ–±–ª–µ–º–∞–º–∏¬ª.\n` +
      `   ‚Üí –ì–æ–≤–æ—Ä–∏ –æ–±—Ä–∞–∑–Ω–æ: ¬´—ç—Ç–∞ —á–∞—Å—Ç—å —Ç–µ–±—è —Å–µ–π—á–∞—Å –º–æ–ª—á–∏—Ç¬ª, ¬´–æ–≥–æ–Ω—å –∑–¥–µ—Å—å —á—É—Ç—å –ø—Ä–∏—Ç–∏—Ö¬ª.\n` +
      `   ‚Üí –û–¥–∏–Ω –∏–∑ –∫–≤–µ—Å—Ç–æ–≤ –¥–æ–ª–∂–µ–Ω –º—è–≥–∫–æ –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –≤ –æ–¥–Ω—É –∏–∑ —Ç–µ–Ω–µ–≤—ã—Ö –∑–æ–Ω.`
    );
  }

  if (insights.hasTurbulence) {
    lines.push(
      `‚ö° –¢–£–†–ë–£–õ–ï–ù–¢–ù–û–°–¢–¨: –í–´–°–û–ö–ê–Ø\n` +
      `   ‚Üí –í "–°–æ—Å—Ç–æ—è–Ω–∏–∏ –¥—É—Ö–∞" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–∑–æ–≤–∏ —ç—Ç–æ –æ–±—Ä–∞–∑–Ω–æ:\n` +
      `      ¬´–≤–Ω—É—Ç—Ä–∏ —Ç–µ–±—è —à—Ç–æ—Ä–º¬ª, ¬´–¥–≤–∞ —Ç–µ—á–µ–Ω–∏—è —Ç—è–Ω—É—Ç –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã¬ª.\n` +
      `   ‚Üí –ö–≤–µ—Å—Ç—ã —Å–≥–ª–∞–∂–∏–≤–∞—é—Ç –∫—Ä–∞–π–Ω–æ—Å—Ç–∏ ‚Äî –Ω–µ –ø–æ–¥—Ç–∞–ª–∫–∏–≤–∞—é—Ç –∫ –ø–∏–∫—É, –∞ —É–∫—Ä–µ–ø–ª—è—é—Ç —Å–µ—Ä–µ–¥–∏–Ω—É.`
    );
  } else {
    lines.push(
      `„Ä∞Ô∏è –¢–£–†–ë–£–õ–ï–ù–¢–ù–û–°–¢–¨: –Ω–∏–∑–∫–∞—è (–ø—Ä–æ—Ñ–∏–ª—å —Ä–æ–≤–Ω—ã–π)\n` +
      `   ‚Üí –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ. –ù–µ –∏—â–∏ ¬´—à—Ç–æ—Ä–º¬ª —Ç–∞–º, –≥–¥–µ –µ–≥–æ –Ω–µ—Ç.\n` +
      `   ‚Üí –ö–≤–µ—Å—Ç—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Ç–æ–Ω–∫–∏–π —Ä–æ—Å—Ç, –∞ –Ω–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—é.`
    );
  }

  const hatInstructions: Record<OctalysisInsights['hatBalance'], string> = {
    black_hat_dominant:
      `üñ§ –†–ï–ñ–ò–ú –ú–û–¢–ò–í–ê–¶–ò–ò: –ß—ë—Ä–Ω–∞—è —à–ª—è–ø–∞ –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç\n` +
      `   ‚Üí –ò–≥—Ä–æ–∫ –¥–≤–∏–∂–µ—Ç—Å—è –æ—Ç —Å—Ç—Ä–∞—Ö–∞ –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –æ—Ç —Å–º—ã—Å–ª–∞.\n` +
      `   ‚Üí –û–±—Ä–∞–∑–Ω–æ: ¬´—Ç—ã —Å–µ–π—á–∞—Å –±–µ–∂–∏—à—å, –∞ –Ω–µ –∏–¥—ë—à—å¬ª.\n` +
      `   ‚Üí –ú–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –∫–≤–µ—Å—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–º—ã—Å–ª –∏–ª–∏ —Ä–∞–¥–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞.\n` +
      `   ‚Üí –¢–æ–Ω: –æ—Å–æ–±–µ–Ω–Ω–æ —Ç—ë–ø–ª—ã–π, –±–µ–∑ –Ω–∞–∂–∏–º–∞.`,

    white_hat_dominant:
      `ü§ç –†–ï–ñ–ò–ú –ú–û–¢–ò–í–ê–¶–ò–ò: –ë–µ–ª–∞—è —à–ª—è–ø–∞ –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç\n` +
      `   ‚Üí –£—Å—Ç–æ–π—á–∏–≤–∞—è –ø–∏—Ç–∞—é—â–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî —Å–º—ã—Å–ª, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, —Å–≤—è–∑—å.\n` +
      `   ‚Üí –ü—Ä–∏–∑–Ω–∞–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞–∫ —Å–∏–ª—É.\n` +
      `   ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç –ª—ë–≥–∫–∏–π –≤—ã–∑–æ–≤ –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç–∏ ‚Äî –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞.`,

    balanced:
      `‚öñÔ∏è –†–ï–ñ–ò–ú –ú–û–¢–ò–í–ê–¶–ò–ò: –®–ª—è–ø—ã –≤ –±–∞–ª–∞–Ω—Å–µ\n` +
      `   ‚Üí –ò—â–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–∏–ª—å–Ω–µ–µ –≤—Å–µ–≥–æ –≤—ã–±–∏–≤–∞–µ—Ç—Å—è –∏–∑ —Å—Ä–µ–¥–Ω–µ–≥–æ ‚Äî –æ–Ω –∫–ª—é—á.\n` +
      `   ‚Üí –ö–≤–µ—Å—Ç—ã —Å—Ç—Ä–æ–π –≤–æ–∫—Ä—É–≥ —Å–∞–º–æ–≥–æ –∑–∞–º–µ—Ç–Ω–æ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è.`,
  };
  lines.push(hatInstructions[insights.hatBalance]);

  const archetypeDescriptions: Record<string, string> = {
    –î–æ—Å—Ç–∏–≥–∞—Ç–æ—Ä:    '–µ–º—É –≤–∞–∂–Ω–æ —á—É–≤—Å—Ç–≤–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞, –≤–∏–¥–∏–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤',
    –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: '–µ–º—É –Ω—É–∂–Ω–∞ –Ω–æ–≤–∏–∑–Ω–∞, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã, —Å–≤–æ–±–æ–¥–∞ –ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞',
    –°–æ—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä:  '–µ–º—É –≤–∞–∂–Ω–∞ —Å–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å, –æ—â—É—â–µ–Ω–∏–µ ¬´—è –Ω–µ –æ–¥–∏–Ω¬ª',
    –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å:   '–µ–º—É –Ω—É–∂–µ–Ω –¥—Ä–∞–π–≤, –≤—ã–∑–æ–≤, —Å–Ω—è—Ç–∏–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥–µ–π—Å—Ç–≤–∏–µ',
  };
  const archetypeQuestHints: Record<string, string> = {
    –î–æ—Å—Ç–∏–≥–∞—Ç–æ—Ä:    '–∫–≤–µ—Å—Ç—ã —Å —á—ë—Ç–∫–∏–º–∏ –º–∏–∫—Ä–æ-–ø–æ–±–µ–¥–∞–º–∏ –∏ –≤–∏–¥–∏–º—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º',
    –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å: '–∫–≤–µ—Å—Ç—ã-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (¬´–ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–∏, —á—Ç–æ –≤—ã–π–¥–µ—Ç¬ª)',
    –°–æ—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä:  '–∫–≤–µ—Å—Ç—ã –Ω–∞ –æ–¥–Ω–æ –∂–∏–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º',
    –ó–∞–≤–æ–µ–≤–∞—Ç–µ–ª—å:   '–∫–≤–µ—Å—Ç—ã ‚Äî —á–µ–ª–ª–µ–Ω–¥–∂ —Å —Å–æ–±–æ–π –≤—á–µ—Ä–∞—à–Ω–∏–º, –Ω–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏',
  };

  if (insights.archetypeMatches) {
    lines.push(
      `üé≠ –ê–†–•–ï–¢–ò–ü: ${insights.computedArchetype} (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º)\n` +
      `   –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç: ${archetypeDescriptions[insights.computedArchetype] ?? ''}.\n` +
      `   ‚Üí –£–∫—Ä–µ–ø–∏ —ç—Ç—É —Å–≤—è–∑—å –≤ —Ç–µ–∫—Å—Ç–µ.\n` +
      `   ‚Üí –ö–≤–µ—Å—Ç—ã: ${archetypeQuestHints[insights.computedArchetype] ?? ''}.`
    );
  } else {
    lines.push(
      `üé≠ –ê–†–•–ï–¢–ò–ü: –≤—ã—á–∏—Å–ª–µ–Ω –∫–∞–∫ ${insights.computedArchetype}, –Ω–æ –ø–µ—Ä–µ–¥–∞–Ω "${passedArchetype}"\n` +
      `   ‚Üí –ú—è–≥–∫–æ –æ–±–æ–∑–Ω–∞—á—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –≤ "–°–æ—Å—Ç–æ—è–Ω–∏–∏ –¥—É—Ö–∞":\n` +
      `      ¬´–°–µ–π—á–∞—Å —Ç–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è –±–ª–∏–∂–µ –∫ ${insights.computedArchetype}, —Ö–æ—Ç—è —Ç—ã –∏–¥—ë—à—å –∫–∞–∫ ${passedArchetype}.\n` +
      `       –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ —Å–µ–π—á–∞—Å –¥–∞—ë—Ç –±–æ–ª—å—à–µ —Å–∏–ª?¬ª\n` +
      `   ‚Üí –ö–≤–µ—Å—Ç—ã —Å—Ç—Ä–æ–π –ø–æ–¥ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π –∞—Ä—Ö–µ—Ç–∏–ø (${insights.computedArchetype}): ${archetypeQuestHints[insights.computedArchetype] ?? ''}.`
    );
  }

  const needsInstructions: Record<string, string> = {
    autonomy:
      `–ê–í–¢–û–ù–û–ú–ò–Ø ‚Äî –æ—â—É—â–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∏ ¬´—Ö–æ—á—É¬ª, –∞ –Ω–µ ¬´–Ω–∞–¥–æ¬ª ‚Äî –ø–æ—Ö–æ–∂–µ, —Å–µ–π—á–∞—Å –æ—Å–ª–∞–±–ª–µ–Ω–∞.\n` +
      `   ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞.\n` +
      `   ‚Üí ¬´–ê —á—Ç–æ, –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ç—ã —Å–¥–µ–ª–∞–µ—à—å –æ–¥–Ω–æ –¥–µ–ª–æ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ —Ö–æ—á–µ—à—å?¬ª`,

    competence:
      `–ö–û–ú–ü–ï–¢–ï–ù–¢–ù–û–°–¢–¨ ‚Äî —á—É–≤—Å—Ç–≤–æ —Ä–æ—Å—Ç–∞ –∏ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ ‚Äî –ø–æ—Ö–æ–∂–µ, —Å–µ–π—á–∞—Å –æ—Å–ª–∞–±–ª–µ–Ω–∞.\n` +
      `   ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç –ø–æ–º–æ–≥–∞–µ—Ç —É–≤–∏–¥–µ—Ç—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç.\n` +
      `   ‚Üí –≠—Ç–æ –Ω–µ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö —Ü–µ–ª–µ–π ‚Äî —ç—Ç–æ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏.`,

    relatedness:
      `–°–í–Ø–ó–ê–ù–ù–û–°–¢–¨ ‚Äî ¬´—è –Ω–µ –æ–¥–∏–Ω¬ª ‚Äî –ø–æ—Ö–æ–∂–µ, —Å–µ–π—á–∞—Å –æ—Å–ª–∞–±–ª–µ–Ω–∞.\n` +
      `   ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –æ–¥–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∂–∏–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ.\n` +
      `   ‚Üí –ù–µ ¬´—Å—Ö–æ–¥–∏ –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ¬ª, –∞: –Ω–∞–ø–∏—Å–∞—Ç—å –æ–¥–Ω–æ–º—É —á–µ–ª–æ–≤–µ–∫—É, –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å, –ø–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å.`,
  };

  if (insights.unmetNeeds.length) {
    lines.push(`üß† –ù–ï–î–û–ü–û–õ–£–ß–ï–ù–ù–´–ï –ë–ê–ó–û–í–´–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ò:`);
    for (const need of insights.unmetNeeds) {
      lines.push(`   ‚Ä¢ ${needsInstructions[need]}`);
    }
    lines.push(`   ‚ö†Ô∏è –ú–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –∏–∑ —Ç—Ä—ë—Ö –∫–≤–µ—Å—Ç–æ–≤ –û–ë–Ø–ó–ê–ù –∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π.`);
  } else {
    lines.push(`üß† –ë–ê–ó–û–í–´–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ò: –≤—Å–µ –≤ –Ω–æ—Ä–º–µ. –ö–≤–µ—Å—Ç—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Ä–æ—Å—Ç, –∞ –Ω–µ –≤–æ—Å–ø–æ–ª–Ω–µ–Ω–∏–µ.`);
  }

  if (insights.signals.length) {
    lines.push(`üîî –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–ò–ì–ù–ê–õ–´:`);
    for (const signal of insights.signals) {
      if (signal === 'isolation_risk') {
        lines.push(
          `   ‚ö†Ô∏è –ò–ó–û–õ–Ø–¶–ò–Ø: –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ —Å–∏–ª—å–Ω–æ –Ω–∏–∂–µ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.\n` +
          `      ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç: ¬´–Ω–∞–π–¥–∏ –æ–¥–Ω–æ–≥–æ —Å–æ—é–∑–Ω–∏–∫–∞¬ª ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ (–∫–æ–º—É –Ω–∞–ø–∏—Å–∞—Ç—å, —Å –∫–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å).`
        );
      }
      if (signal === 'hoarding_risk') {
        lines.push(
          `   ‚ö†Ô∏è –ù–ê–ö–û–ü–ò–¢–ï–õ–¨–°–¢–í–û: –û–±–ª–∞–¥–∞–Ω–∏–µ –∏ –≤–ª–∞–¥–µ–Ω–∏–µ —Å–∏–ª—å–Ω–æ –≤—ã—à–µ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.\n` +
          `      ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç: ¬´–ø–æ–¥–µ–ª–∏—Å—å —Ü–µ–Ω–Ω–æ—Å—Ç—å—é¬ª ‚Äî –ø–µ—Ä–µ–¥–∞—Ç—å –∑–Ω–∞–Ω–∏–µ, –ø–æ–º–æ—á—å, –æ—Ç–¥–∞—Ç—å –Ω–µ–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–µ.`
        );
      }
      if (signal === 'harmony') {
        lines.push(
          `   ‚ú® –ì–ê–†–ú–û–ù–ò–Ø: –í—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ.\n` +
          `      ‚Üí –ü—Ä–∏–∑–Ω–∞–π —ç—Ç–æ –≤—Å–ª—É—Ö –∫–∞–∫ —Ä–µ–¥–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.\n` +
          `      ‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–¥–∏–Ω –º—è–≥–∫–∏–π –º–∏–∫—Ä–æ-—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –¥–ª—è —Ä–æ—Å—Ç–∞ White Hat-—Ñ–∞–∫—Ç–æ—Ä–∞ (–°–º—ã—Å–ª, –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –°–≤—è–∑—å).`
        );
      }
      if (signal.startsWith('one_sided:')) {
        const factor = signal.replace('one_sided:', '');
        lines.push(
          `   ‚ö†Ô∏è –û–î–ù–û–ë–û–ö–û–°–¢–¨: ¬´${factor}¬ª —Ä–µ–∑–∫–æ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ —Ñ–æ–Ω–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.\n` +
          `      ‚Üí –ú—è–≥–∫–æ –æ–±–æ–∑–Ω–∞—á—å —Ä–∏—Å–∫: —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–¥–Ω–æ–≥–æ ‚Äî –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –º–æ–ª—á–∞—Ç—å.\n` +
          `      ‚Üí –û–¥–∏–Ω –∫–≤–µ—Å—Ç –ø–∏—Ç–∞–µ—Ç –¥—Ä—É–≥–∏–µ –≥—Ä–∞–Ω–∏.`
        );
      }
    }
  }

  if (insights.dynamics) {
    lines.push(`üìä –î–ò–ù–ê–ú–ò–ö–ê (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ—à–ª—ã–º –∑–∞–º–µ—Ä–æ–º):`);
    if (insights.dynamics.improved.length) {
      lines.push(
        `   ‚Üë –í—ã—Ä–æ—Å–ª–æ: ${insights.dynamics.improved.join(', ')}\n` +
        `      ‚Üí –û—Ç–º–µ—Ç—å —ç—Ç–æ—Ç —Ä–æ—Å—Ç ‚Äî –Ω–µ –∫–∞–∫ –≥–∞–ª–æ—á–∫—É, –∞ –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â—É—é –ø–æ–±–µ–¥—É.\n` +
        `      ‚Üí ¬´–°–º–æ—Ç—Ä–∏, –∫–∞–∫ –≤—ã—Ä–æ—Å–ª–∞ —Ç–≤–æ—è...¬ª ‚Äî —ç—Ç–æ —Ç–æ–ø–ª–∏–≤–æ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –¥–∞–ª—å—à–µ.`
      );
    }
    if (insights.dynamics.declined.length) {
      lines.push(
        `   ‚Üì –£–ø–∞–ª–æ: ${insights.dynamics.declined.join(', ')}\n` +
        `      ‚Üí –£–ø–æ–º—è–Ω–∏ –º—è–≥–∫–æ, –±–µ–∑ —Ç—Ä–µ–≤–æ–≥–∏: ¬´–∏–Ω–æ–≥–¥–∞ –æ—Ç–ª–∏–≤ –∏–¥—ë—Ç –ø–µ—Ä–µ–¥ –±–æ–ª—å—à–∏–º –ø—Ä–∏–ª–∏–≤–æ–º¬ª.`
      );
    }
  }

  lines.push('\n=== –ö–û–ù–ï–¶ –ê–ù–ê–õ–ò–ó–ê. –¢–µ–ø–µ—Ä—å —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∏ –∫–≤–µ—Å—Ç—ã. ===');
  lines.push('–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∞–Ω–∞–ª–∏–∑ –∫–∞–∫ –∫–∞—Ä—Ç—É. –ù–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–π. –ù–µ –Ω–∞–∑—ã–≤–∞–π —á–∏—Å–ª–∞ –≤ –æ—Ç–≤–µ—Ç–µ.');
  return lines.join('\n');
}
