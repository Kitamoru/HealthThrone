import React, { useState, useCallback, useEffect } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import { useTelegram } from '@/hooks/useTelegram';
import { Loader } from '@/components/Loader';
import { 
  useUserData, 
  useSpritesData, 
  useOwnedSprites,
  usePurchaseSprite,
  useEquipSprite
} from '@/lib/api';
import { Sprite } from '@/lib/types';
import { validateRequiredFields } from '@/utils/validation';
import { queryClient } from '@/lib/queryClient';

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ø—Ä–∞–π—Ç–∞
const SpriteCard = React.memo(({ 
  sprite, 
  coins, 
  isOwned, 
  isEquipped, 
  isProcessing, 
  onPurchase, 
  onEquip 
}: { 
  sprite: Sprite;
  coins: number;
  isOwned: boolean;
  isEquipped: boolean;
  isProcessing: boolean;
  onPurchase: (id: number) => void;
  onEquip: (id: number) => void;
}) => (
  <div className="sprite-card">
    <img
      src={sprite.image_url}
      alt={sprite.name}
      className="sprite-image"
      onError={(e) =>
        (e.currentTarget.src =
          'https://via.placeholder.com/150?text=No+Image')
      }
    />
    <div className="sprite-info">
      <h3>{sprite.name}</h3>
      <div className="sprite-price">
        –¶–µ–Ω–∞:{' '}
        {sprite.price > 0 ? `${sprite.price} –º–æ–Ω–µ—Ç` : '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ'}
      </div>
      <div className="sprite-actions">
        {!isOwned ? (
          coins >= sprite.price ? (
            <button
              className={`buy-btn ${isProcessing ? 'processing' : ''}`}
              onClick={() => !isProcessing && onPurchase(sprite.id)}
              disabled={isProcessing}
            >
              {isProcessing ? (
                <span className="button-loader">‚è≥</span>
              ) : (
                '–ö—É–ø–∏—Ç—å'
              )}
            </button>
          ) : (
            <button className="buy-btn disabled" disabled>
              –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
            </button>
          )
        ) : (
          <button
            className={`equip-btn ${isEquipped ? 'equipped' : ''} ${isProcessing ? 'processing' : ''}`}
            onClick={() => !isProcessing && onEquip(sprite.id)}
            disabled={isProcessing || isEquipped}
          >
            {isProcessing ? (
              <span className="button-loader">‚è≥</span>
            ) : isEquipped ? (
              '–ü—Ä–∏–º–µ–Ω—ë–Ω'
            ) : (
              '–ü—Ä–∏–º–µ–Ω–∏—Ç—å'
            )}
          </button>
        )}
      </div>
    </div>
  </div>
));

export default function Shop() {
  const router = useRouter();
  const { user, initData, webApp } = useTelegram();
  const telegramId = user?.id ? Number(user.id) : null;
  
  const { 
    data: userResponse, 
    isLoading: userLoading,
    isFetched: userFetched,
    error: userError 
  } = useUserData(telegramId || 0, initData);
  
  const { 
    data: spritesResponse, 
    isLoading: spritesLoading,
    isFetched: spritesFetched,
    error: spritesError 
  } = useSpritesData(initData);
  
  const { 
    data: ownedResponse, 
    isLoading: ownedLoading,
    isFetched: ownedFetched,
    error: ownedError 
  } = useOwnedSprites(telegramId || 0, initData);
  
  const purchaseMutation = usePurchaseSprite();
  const equipMutation = useEquipSprite();
  
  const [processing, setProcessing] = useState<number | null>(null);
  const [error, setError] = useState<string | null>(null);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤—Å–µ –ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
  const allFetched = userFetched && spritesFetched && ownedFetched;
  const anyError = userError || spritesError || ownedError || 
                  (userResponse && !userResponse.success) || 
                  (spritesResponse && !spritesResponse.success) || 
                  (ownedResponse && !ownedResponse.success);

  // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const coins = userResponse?.success ? userResponse.data?.coins || 0 : 0;
  const currentSprite = userResponse?.success 
    ? userResponse.data?.current_sprite_id || null 
    : null;
  
  // –î–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–π—Ç–æ–≤
  const ownedSprites = ownedResponse?.success 
    ? ownedResponse.data || [] 
    : [];
  const sprites = spritesResponse?.success 
    ? spritesResponse.data || [] 
    : [];

  const handlePurchase = useCallback(async (spriteId: number) => {
    const validationError = validateRequiredFields(
      { user, initData },
      ['user', 'initData'],
      '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ª–∏—á–∏–µ –æ–±–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö'
    );
    if (validationError) {
      setError(validationError);
      return;
    }

    if (!user?.id) {
      setError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
      return;
    }

    const sprite = sprites.find((item) => item.id === spriteId);
    if (!sprite) {
      setError('–°–ø—Ä–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    if (ownedSprites.includes(spriteId)) {
      setError('–í—ã —É–∂–µ –ø—Ä–∏–æ–±—Ä–µ–ª–∏ —ç—Ç–æ—Ç —Å–ø—Ä–∞–π—Ç.');
      return;
    }

    if (coins < sprite.price) {
      setError('–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏.');
      return;
    }

    try {
      setProcessing(spriteId);
      setError(null);
      
      const purchaseResult = await purchaseMutation.mutateAsync({
        telegramId: Number(user.id),
        spriteId,
        initData
      });
      
      if (purchaseResult.success) {
        await Promise.all([
          queryClient.invalidateQueries({ 
            queryKey: ['user', telegramId] 
          }),
          queryClient.invalidateQueries({ 
            queryKey: ['ownedSprites', telegramId] 
          }),
          queryClient.invalidateQueries({ 
            queryKey: ['sprites'] 
          })
        ]);
      } else {
        setError(purchaseResult.error || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Å–ø—Ä–∞–π—Ç–∞.');
      }
    } catch (err) {
      setError('–í–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ.');
    } finally {
      setProcessing(null);
    }
  }, [user, initData, sprites, ownedSprites, coins, purchaseMutation, telegramId]);

  const handleEquip = useCallback(async (spriteId: number) => {
    const validationError = validateRequiredFields(
      { user, initData },
      ['user', 'initData'],
      '–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.'
    );
    if (validationError) {
      setError(validationError);
      return;
    }

    if (!user?.id) {
      setError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
      return;
    }

    try {
      setProcessing(spriteId);
      setError(null);
      
      const equipResult = await equipMutation.mutateAsync({
        telegramId: Number(user.id),
        spriteId,
        initData
      });
      
      if (equipResult.success) {
        await Promise.all([
          queryClient.invalidateQueries({ 
            queryKey: ['user', telegramId] 
          }),
          queryClient.invalidateQueries({ 
            queryKey: ['sprites'] 
          })
        ]);
      } else {
        setError(equipResult.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Å–ø—Ä–∞–π—Ç–∞.');
      }
    } catch (err) {
      setError('–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–ø—Ä–∞–π—Ç.');
    } finally {
      setProcessing(null);
    }
  }, [user, initData, equipMutation, telegramId]);

  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
  if (!allFetched) {
    return <Loader />;
  }

  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  if (anyError) {
    const errorMessage = 
      userError?.message || 
      spritesError?.message || 
      ownedError?.message ||
      (userResponse && !userResponse.success ? userResponse.error : null) ||
      (spritesResponse && !spritesResponse.success ? spritesResponse.error : null) ||
      (ownedResponse && !ownedResponse.success ? ownedResponse.error : null) ||
      '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
    
    return (
      <div className="container">
        <div className="scrollable-content">
          <div className="error">{errorMessage}</div>
        </div>
      </div>
    );
  }

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  if (!telegramId) {
    return (
      <div className="container">
        <div className="scrollable-content">
          <div className="error">
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.
          </div>
        </div>
      </div>
    );
  }

  // –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–Ω–¥–µ—Ä –º–∞–≥–∞–∑–∏–Ω–∞
  return (
    <div className="container">
      <div className="scrollable-content">
        <div className="header">
          <h2>–õ–∞–≤–∫–∞ —Å–ø—Ä–∞–π—Ç–æ–≤</h2>
          <div className="coins-display">–ú–æ–Ω–µ—Ç—ã: {coins}</div>
        </div>

        {error && <div className="error">{error}</div>}

        {sprites.length === 0 ? (
          <div className="info">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ø—Ä–∞–π—Ç–æ–≤.</div>
        ) : (
          <div className="sprites-grid">
            {sprites.map((sprite) => (
              <SpriteCard
                key={sprite.id}
                sprite={sprite}
                coins={coins}
                isOwned={ownedSprites.includes(sprite.id)}
                isEquipped={currentSprite === sprite.id}
                isProcessing={processing === sprite.id}
                onPurchase={handlePurchase}
                onEquip={handleEquip}
              />
            ))}
          </div>
        )}
      </div>

      <div className="menu">
        <Link href="/" passHref>
          <button className={`menu-btn ${router.pathname === '/' ? 'active' : ''}`}>üìä</button>
        </Link>
        <Link href="/friends" passHref>
          <button className={`menu-btn ${router.pathname === '/friends' ? 'active' : ''}`}>üìà</button>
        </Link>
        <Link href="/shop" passHref>
          <button className={`menu-btn ${router.pathname === '/shop' ? 'active' : ''}`}>üõçÔ∏è</button>
        </Link>
        <Link href="/reference" passHref>
          <button className={`menu-btn ${router.pathname === '/reference' ? 'active' : ''}`}>‚ÑπÔ∏è</button>
        </Link>
      </div>
    </div>
  );
}
